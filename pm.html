 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'success': '#10B981',
                        'danger': '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        /* Diversification chart removed - now handled in separate pages */
        /* Ensure the chart container can expand properly */
        .chart-container {
            height: auto !important;
            min-height: 800px;
        }
        
        /* Simple Plotly modebar styling without custom positioning */
        .modebar {
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 6px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        .modebar-btn {
            transition: all 0.2s ease !important;
        }
        
        .modebar-btn:hover {
            background-color: rgba(46, 134, 171, 0.1) !important;
        }
        
        /* Force single column layout for modebar */
        .modebar .modebar-group {
            display: flex !important;
            flex-direction: column !important;
            gap: 2px !important;
        }
        
        /* Ensure all buttons are in one group */
        .modebar > .modebar-group:not(:first-child) {
            display: none !important;
        }
        
        /* Better chart spacing and prevent clashing */
        /* Diversification chart CSS removed */
        
        /* Chart styling removed - now handled in separate pages */
        
        /* Ensure chart container has enough bottom space */
        .chart-container {
            padding-bottom: 120px !important;
        }
        
        /* Force chart to stay within bounds */
        .plotly .main-svg .bglayer {
            margin-bottom: 100px !important;
        }
        
        /* Prevent text overlap at bottom */
        .plotly .main-svg text {
            dominant-baseline: hanging !important;
        }
        
        /* Force reasonable title spacing */
        .text-xl.font-semibold {
            display: block !important;
        }
        
        /* Specific spacing for chart titles */
        h3.text-center.text-gray-700.mb-8.text-xl.font-semibold {
            margin-bottom: 2.5rem !important; /* 40px - balanced separation */
            line-height: 1.5 !important;
        }
        
        /* Force canvas positioning below titles */
        canvas {
            margin-top: 1rem !important; /* 16px - minimal top margin */
        }
        
        /* Portfolio Management Styles */
        .portfolio-checkbox:checked {
            background-color: #9333ea;
            border-color: #9333ea;
        }
        
        .portfolio-checkbox:indeterminate {
            background-color: #9333ea;
            border-color: #9333ea;
        }
        
        /* Table View Styles */
        #portfolioManagementTable {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        #portfolioManagementTable th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb;
        }
        
        #portfolioManagementTable tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* View Toggle Transitions */
        #portfolioList, #tableViewContainer {
            transition: opacity 0.2s ease-in-out;
        }
        
        /* Button States */
        .view-toggle-btn.active {
            background-color: #dbeafe;
            color: #2563eb;
            border-color: #93c5fd;
        }
        
        .view-toggle-btn.inactive {
            background-color: #f3f4f6;
            color: #6b7280;
            border-color: #d1d5db;
        }
        
        /* Custom CSS for enhanced styling */
        .chart-container {
            min-height: 400px;
            margin-bottom: 20px !important;
            padding-bottom: 40px !important;
        }
        
        .chart-container.multi-portfolio {
            height: 600px !important;
            min-height: 600px !important;
            max-height: 600px !important;
            margin-bottom: 2rem !important;
        }
        
        #diversificationChart {
            margin-bottom: 40px !important;
            padding-bottom: 40px !important;
        }
        
        .js-plotly-plot {
            margin-bottom: 40px !important;
            padding-bottom: 40px !important;
        }
        
        .plotly .main-svg {
            margin-bottom: 40px !important;
            padding-bottom: 40px !important;
        }
        
        .text-xl.font-semibold {
           
            display: block;
        }
        
        h3.text-center.text-gray-700.mb-8.text-xl.font-semibold {
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }
        
        canvas {
            margin-top: 1rem !important;
        }
        
        /* Multi-Portfolio Chart View Styles */
        #multiPortfolioChartView {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        #stockList {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E0 #F7FAFC;
        }
        
        #stockList::-webkit-scrollbar {
            width: 6px;
        }
        
        #stockList::-webkit-scrollbar-track {
            background: #F7FAFC;
            border-radius: 3px;
        }
        
        #stockList::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 3px;
        }
        
        #stockList::-webkit-scrollbar-thumb:hover {
            background: #A0AEC0;
        }
        
        #stockList > div:hover {
            background-color: #F3F4F6;
            transition: background-color 0.2s ease;
        }
        
        #stockList > div.selected {
            background-color: #EBF8FF;
            border-left: 3px solid #3182CE;
        }
        
        #stockPriceChart {
            background: linear-gradient(135deg, #F7FAFC 0%, #FFFFFF 100%);
            border-radius: 8px;
            padding: 16px;
            height: 500px !important;
            min-height: 500px !important;
        }
        
        .chart-controls {
            background: #F8FAFC;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #E2E8F0;
        }
        
        /* Radio button styling */
        input[type="radio"] {
            accent-color: #3B82F6;
        }
        
        .chart-controls label {
            cursor: pointer;
            user-select: none;
        }
        
        .chart-controls label:hover {
            color: #1E40AF;
        }
        
        /* Chart type radio buttons */
        input[name="chartDataType"]:checked + span {
            font-weight: 600;
            color: #1E40AF;
        }
        
        input[name="chartViewType"]:checked + span {
            font-weight: 600;
            color: #1E40AF;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            #multiPortfolioChartView .grid {
                grid-template-columns: 1fr;
            }
            
            #stockList {
                max-height: 200px;
            }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen p-4">
    <div class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen p-4 relative">

        <!-- Header -->
        <div class="max-w-7xl mx-auto">
            <div class="text-center text-white mb-8">
                <h1 class="text-4xl font-bold mb-2">Portfolio Dashboard</h1>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="portfolioManagementBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        üìä Portfolio Management
                    </button>
                    <button id="stockCalculatorBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        üßÆ Stock Calculator
                    </button>
                    <button id="targetPriceManagerBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        üéØ Target Price Manager
                    </button>
                </div>
            </div>

            <!-- Upload Portfolio Data Modal -->
            <div id="uploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Upload Portfolio Data</h2>
                        <button id="closeUploadModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                            √ó
                        </button>
                    </div>
                
                <!-- Portfolio Naming Section -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-semibold text-blue-900 mb-3">Portfolio Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="portfolioDate" class="block text-sm font-medium text-blue-800 mb-1">Portfolio Date *</label>
                            <input type="date" id="portfolioDate" required class="w-full p-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-blue-600 mt-1">Portfolio name will be automatically generated as YYYYMMDD</p>
                        </div>
                        <div>
                            <label for="portfolioDescription" class="block text-sm font-medium text-blue-800 mb-1">Description (Optional)</label>
                            <input type="text" id="portfolioDescription" placeholder="e.g., End of month portfolio" class="w-full p-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="csvFile" class="block text-sm font-medium text-gray-700 mb-2">Select Portfolio Files:</label>
                        <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" multiple>
                        <p class="text-sm text-gray-500 mt-1">Supports CSV, Excel (.xlsx, .xls) files</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="uploadBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                            üì§ Upload & Process Files
                        </button>
                        <button id="clearDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-6 rounded-lg transition-colors hidden">
                            üóëÔ∏è Clear Data
                        </button>
                    </div>
                </div>

                <!-- Help Toggle Button -->
                <div class="mt-6 text-center">
                    <button id="helpToggle" class="text-blue-600 hover:text-blue-700 font-medium flex items-center space-x-2 mx-auto transition-colors">
                        <span id="helpIcon">üìñ</span>
                        <span id="helpText">Show Help</span>
                    </button>
                </div>
                
                <!-- Collapsible Help Section -->
                <div id="helpSection" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-blue-800 text-sm">
                        <h4 class="font-semibold mb-3 text-blue-900">Portfolio Comparison Mode:</h4>
                        <p class="mb-2"><strong>How to use comparison mode:</strong></p>
                        <ol class="list-decimal list-inside ml-4 space-y-1 mb-4">
                            <li>Set the portfolio date using the date picker</li>
                            <li>First upload: Your initial portfolio (e.g., yesterday's data)</li>
                            <li>Second upload: Your new portfolio (e.g., today's data)</li>
                            <li>Dashboard will show comparison charts and change indicators</li>
                            <li>Portfolios are automatically sorted by date for proper comparison order</li>
                        </ol>
                        
                        <h4 class="font-semibold mb-2 text-blue-900">Multiple CSV Upload:</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mb-4">
                            <li>Select multiple CSV files using Ctrl+Click (or Cmd+Click on Mac)</li>
                            <li>All files are processed together</li>
                            <li>Securities with the same name are automatically aggregated</li>
                            <li>Dashboard shows only the final combined result</li>
                        </ul>
                        
                        <h4 class="font-semibold mb-2 text-blue-900">Expected File Format:</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1 mb-4">
                            <li>Security - Stock symbol/ticker (e.g., ALUM.N0000)</li>
                            <li>Quantity - Number of shares</li>
                            <li>Avg Price - Average purchase price</li>
                            <li>Total Cost - Total cost basis</li>
                            <li>Market Value - Current market value</li>
                            <li>Unrealized Gain / (Loss) - Unrealized profit/loss</li>
                            <li>Unrealized Gain/Loss % - Return percentage</li>
                        </ul>
                        
                        <h4 class="font-semibold mb-2 text-blue-900">Supported Formats:</h4>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>CSV files - Comma-separated values</li>
                            <li>Excel files - .xlsx and .xls formats</li>
                            <li>Multiple sheets - Excel files with multiple worksheets are supported</li>
                        </ul>
                    </div>
                </div>
                </div>
            </div>

            <!-- Portfolio Management Section (Visible initially) -->
            <div id="portfolioManagementSection" class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Portfolio Management</h2>
                    <div class="flex space-x-3">
                        <button id="newPortfolioBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìÅ New Portfolio
                        </button>
                        <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            üì¶ Export
                        </button>
                        <div class="relative inline-block text-left">
                            <button id="importPortfolioBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                üì• Import Portfolio
                            </button>
                            <div id="importDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                                <div class="py-1">
                                    <button id="importSingleBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        üìÑ Import Single Portfolio (.json)
                                    </button>
                                    <button id="importZipBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        üì¶ Import Multiple Portfolios (.zip)
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button id="backToUploadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors hidden">
                            ‚Üê Back to Upload
                        </button>
                    </div>
                </div>

                <!-- View Toggle and Selection Controls (Always Visible) -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                    <div class="flex items-center space-x-4">
                        <!-- Portfolio Count -->
                        <div class="flex items-center space-x-2">
                            <span id="portfolioCount" class="text-sm font-medium text-gray-700">0 portfolios (0 total uploads)</span>
                            <span class="text-xs text-gray-500" title="Multiple files can be uploaded for the same portfolio date. The system groups them by date to show unique portfolios.">‚ìò</span>
                        </div>
                        
                        <!-- View Toggle -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">View:</span>
                            <button id="cardViewBtn" class="px-3 py-1 text-sm font-medium text-blue-600 bg-blue-100 rounded-md border border-blue-200">
                                üìã Cards
                            </button>
                            <button id="tableViewBtn" class="px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md border border-gray-200 hover:bg-gray-200">
                                üìä Table
                            </button>
                        </div>
                        
                        <!-- Selection Controls -->
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="selectAllPortfolios" class="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500">
                            <label for="selectAllPortfolios" class="text-sm font-medium text-gray-700">Select All</label>
                            <span id="selectedCount" class="text-sm text-gray-500">0 selected</span>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="flex items-center space-x-2">
                        <button id="deleteSelectedBtn" class="px-3 py-1 text-sm text-white bg-red-600 rounded-md border border-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            üóëÔ∏è Delete Selected
                        </button>
                    </div>
                </div>

                <!-- Portfolio List -->
                <div id="portfolioList" class="space-y-4">
                    <!-- Portfolios will be populated here -->
                </div>

                <!-- Multi-Portfolio Chart View -->
                <div id="multiPortfolioChartView" class="hidden mt-8 bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">Stock Price Trends Across Portfolios</h3>
                        <button id="closeChartView" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">√ó</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Stock Selector Panel -->
                        <div class="lg:col-span-1">
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Select Stocks</h4>
                                
                                <!-- Search Box -->
                                <div class="mb-3">
                                    <input type="text" id="stockSearch" placeholder="Search stocks..." 
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <!-- Stock List -->
                                <div id="stockList" class="space-y-2 max-h-96 overflow-y-auto">
                                    <!-- Stocks will be populated here -->
                                </div>
                                
                                <!-- Select All/Clear All -->
                                <div class="flex space-x-2 mt-3 pt-3 border-t border-gray-200">
                                    <button id="selectAllStocks" class="text-xs text-blue-600 hover:text-blue-800">
                                        Select All
                                    </button>
                                    <button id="clearAllStocks" class="text-xs text-gray-600 hover:text-gray-800">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Display Panel -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-lg border border-gray-200 p-6">
                                <div class="chart-container multi-portfolio" style="height: 600px;">
                                    <canvas id="stockPriceChart" class="w-full" style="height: 600px;"></canvas>
                                </div>
                                
                                <!-- Chart Controls -->
                                <div class="flex items-center justify-between mt-6 pt-6 border-t border-gray-200">
                                    <div class="flex items-center space-x-6">
                                        <!-- Display Type Dropdown -->
                                        <div class="flex items-center space-x-3">
                                            <span class="text-sm font-medium text-gray-700">Chart Type:</span>
                                            <select id="chartViewType" class="text-sm border-2 border-gray-300 rounded-lg px-3 py-2 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                                                <option value="value">Value (Avg + Current)</option>
                                                <option value="percentage">Percentage (Deviation)</option>
                                                <option value="pnl">P&L Value</option>
                                                <option value="pnlPercentage">P&L %</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="resetChart" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg border border-gray-200 hover:bg-gray-200 transition-colors">
                                            Reset Chart
                                        </button>
                                        <button id="exportChart" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-lg border border-blue-200 hover:bg-blue-200 transition-colors">
                                            Export Chart
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table View Container (Hidden by default) -->
                <div id="tableViewContainer" class="hidden">
                    <div class="overflow-x-auto">
                        <table id="portfolioManagementTable" class="w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllTable" class="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500">
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Portfolio</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Securities</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total P&L</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Return %</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="portfolioManagementTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Portfolio rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Portfolios Message -->
                <div id="noPortfoliosMessage" class="text-center py-8 text-gray-500">
                    <p class="text-lg">No portfolios saved yet.</p>
                    <p class="text-sm">Upload your first portfolio to get started!</p>
                </div>

                <!-- Comparison Controls -->
                <div id="comparisonControls" class="hidden mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span class="text-purple-800 font-medium">Selected for comparison:</span>
                            <span id="selectedPortfolios" class="text-purple-600"></span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <!-- Automatic Date-Based Ordering Info -->
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-purple-700">üìÖ Order:</span>
                                <span class="text-sm text-purple-600">Automatic (Earlier date = Baseline)</span>
                            </div>
                            <button id="compareSelectedBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                üîç Compare Selected Portfolios
                            </button>
                            <button id="showChartViewBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                üìä Show Price Trends Chart
                            </button>
                            <button id="showTradeAnalysisBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                üí∞ Trade Analysis
                            </button>
                        </div>
                    </div>
                    

                </div>
            </div>

            
            <!-- Portfolio Comparison Selection Section -->
            <div id="portfolioComparisonSection" class="hidden bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Portfolio Comparison</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Portfolio (Baseline)</label>
                        <select id="initialPortfolioSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select initial portfolio...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Portfolio (To Compare)</label>
                        <select id="currentPortfolioSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select current portfolio...</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button id="comparePortfoliosBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        üîç Compare Portfolios
                    </button>
                </div>
            </div>

            <!-- Trade Analysis Section -->
            <!-- Portfolio Detail Section -->
            <div id="portfolioDetailSection" class="hidden bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 mb-8">
                <!-- Portfolio detail content will be dynamically inserted here -->
            </div>

            <div id="tradeAnalysisSection" class="hidden bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Trading Journal & Analysis</h2>
                
                <div class="mb-6">
                    <div class="flex items-center space-x-4 mb-4">
                        <span class="text-sm font-medium text-gray-700">Selected Portfolios:</span>
                        <span id="selectedPortfoliosCount" class="text-sm text-orange-600 font-semibold">0 portfolios</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">
                        Select multiple portfolios to analyze your complete trading history. The system will track purchases and sales across all selected portfolios chronologically.
                    </div>
                </div>

                <!-- Trading Journal Table -->
                <div id="tradingJournalContainer" class="hidden mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Daily Trading Journal</h3>
                        <div class="flex items-center space-x-3">
                            <button id="exportTradingJournalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                üìä Export
                            </button>
                            <button id="printTradingJournalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                üñ®Ô∏è Print
                            </button>
                            <button id="addManualTradeBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                + Add Manual Trade
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="tradingJournalTable" class="w-full border-separate border-spacing-0" style="min-width: 1200px;">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Date</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Stock</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Amount</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Ave Price</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Market Value</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 border-b">Type</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Sold Date</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Duration</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Sold Price</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Sell Order Value</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">P&L</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">P&L%</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 border-b">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradingJournalTableBody">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Portfolio Holdings Summary -->
                <div id="portfolioHoldingsSummary" class="hidden mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Current Holdings Summary</h3>
                        <div class="flex items-center space-x-3">
                            <button id="exportHoldingsSummaryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                üìä Export
                            </button>
                            <button id="printHoldingsSummaryBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                üñ®Ô∏è Print
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="holdingsSummaryTable" class="w-full border-separate border-spacing-0" style="min-width: 800px;">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b">Symbol</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Total Qty</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Avg Cost</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Current Price</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Market Value</th>
                                    <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Unrealized P&L</th>
                                </tr>
                            </thead>
                            <tbody id="holdingsSummaryTableBody">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trading Performance Summary -->
                <div id="tradingPerformanceSummary" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Trading Performance Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-green-800">Total Profit</h4>
                            <p id="totalProfit" class="text-2xl font-bold text-green-600">Rs. 0.00</p>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-red-800">Total Loss</h4>
                            <p id="totalLoss" class="text-2xl font-bold text-red-600">Rs. 0.00</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-blue-800">Net P&L</h4>
                            <p id="netPnL" class="text-2xl font-bold text-blue-600">Rs. 0.00</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-purple-800">Win Rate</h4>
                            <p id="winRate" class="text-2xl font-bold text-purple-600">0%</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-800">Total Trades</h4>
                            <p id="totalTrades" class="text-2xl font-bold text-gray-600">0</p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-yellow-800">Avg Profit per Trade</h4>
                            <p id="avgProfitPerTrade" class="text-2xl font-bold text-yellow-600">Rs. 0.00</p>
                        </div>
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-indigo-800">Best Trade</h4>
                            <p id="bestTrade" class="text-2xl font-bold text-indigo-600">Rs. 0.00</p>
                        </div>
                        <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-pink-800">Worst Trade</h4>
                            <p id="worstTrade" class="text-2xl font-bold text-pink-600">Rs. 0.00</p>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button id="analyzeTradesBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        üîç Analyze Trades
                    </button>
                </div>
            </div>

            <!-- Manual Trade Entry Modal -->
            <div id="manualTradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Manual Trade</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trade Date</label>
                            <input type="date" id="tradeDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock Symbol</label>
                            <input type="text" id="stockSymbol" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., AAPL">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity/Amount</label>
                            <input type="number" id="tradeQuantity" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="1000" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Average Price</label>
                            <input type="number" id="tradePrice" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="25.50" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss</label>
                            <input type="number" id="stopLoss" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="24.00" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Take Profit</label>
                            <input type="number" id="takeProfit" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="30.00" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trade Type</label>
                            <select id="tradeType" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div id="sellDateContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sell Date</label>
                            <input type="date" id="sellDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div id="sellPriceContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sell Price</label>
                            <input type="number" id="sellPrice" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="26.50" step="0.01">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button id="cancelTradeBtn" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button id="saveTradeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Trade
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hidden file input for portfolio import -->
            <input type="file" id="portfolioImportFile" accept=".json" class="hidden">
            <input type="file" id="zipImportFile" accept=".zip" class="hidden">

        <!-- Dashboard Content (Initially Hidden) -->
        <div id="dashboardContent" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20">
                    <h3 class="text-gray-500 text-sm font-medium">Total Portfolio Value</h3>
                    <p id="totalMarketValue" class="text-2xl font-bold text-gray-900">Rs. 0</p>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20">
                    <h3 class="text-gray-500 text-sm font-medium">Total Cost</h3>
                    <p id="totalCost" class="text-2xl font-bold text-gray-900">Rs. 0</p>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Total P&L</h3>
                    <p id="totalPnL" class="text-2xl font-bold text-success">Rs. 0</p>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Return %</h3>
                    <p id="totalReturn" class="text-2xl font-bold text-danger">0.00%</p>
                </div>
            </div>

            <!-- Comparison Summary Cards (Hidden by default) -->
            <div id="comparisonCards" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl p-6 shadow-2xl border border-blue-200">
                    <h3 class="text-blue-600 text-sm font-medium">Portfolio Value Change</h3>
                    <p id="valueChange" class="text-2xl font-bold text-blue-900">Rs. 0</p>
                    <p id="valueChangePercent" class="text-sm text-blue-600">0.00%</p>
                </div>
                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-2xl p-6 shadow-2xl border border-green-200">
                    <h3 class="text-green-600 text-sm font-medium">P&L Change</h3>
                    <p id="pnlChange" class="text-2xl font-bold text-green-900">Rs. 0</p>
                    <p id="pnlChangePercent" class="text-sm text-green-600">0.00%</p>
                </div>
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-2xl p-6 shadow-2xl border border-purple-200">
                    <h3 class="text-purple-600 text-sm font-medium">New Securities</h3>
                    <p id="newSecurities" class="text-2xl font-bold text-purple-900">0</p>
                    <p class="text-sm text-purple-600">Added today</p>
                </div>
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-2xl p-6 shadow-2xl border border-orange-200">
                    <h3 class="text-orange-600 text-sm font-medium">Removed Securities</h3>
                    <p id="removedSecurities" class="text-2xl font-bold text-orange-900">0</p>
                    <p class="text-sm text-orange-600">Sold today</p>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 h-[26rem] relative">
                    <h3 class="text-center text-gray-700 text-xl font-semibold">Portfolio Allocation (Top 10)</h3>
                    <canvas id="allocationChart" class="max-h-full w-full"></canvas>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 h-[26rem] relative">
                    <h3 class="text-center text-gray-700 text-xl font-semibold">Performance by Security (Top 10)</h3>
                    <canvas id="performanceChart" class="max-h-full w-full"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 h-[26rem] relative">
                    <h3 class="text-center text-gray-700  text-xl font-semibold">Sector Market Value Totals</h3>
                    <canvas id="sectorChart" class="max-h-full w-full"></canvas>
                </div>
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 h-[26rem] relative">
                    <h3 class="text-center text-gray-700  text-xl font-semibold">Performance by Sector</h3>
                    <canvas id="sectorPerformanceChart" class="max-h-full w-full"></canvas>
                </div>
            </div>

            <!-- Portfolio Table -->
            <div class="bg-white/95 backdrop-blur-sm mb-8 rounded-2xl p-6 shadow-2xl border border-white/20">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-center text-gray-700 text-xl font-semibold">Portfolio Details</h3>
                    <div class="flex items-center space-x-3">
                        <button id="exportPortfolioTableBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìä Export
                        </button>
                        <button id="printPortfolioTableBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto" style="max-width: 100%;">
                    <table id="portfolioTable" class="w-full border-separate border-spacing-0" style="min-width: 800px;margin-left: 0px;">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-center text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Rank</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-left text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Symbol</div>
                                        <div class="text-xs text-gray-600">Avg. Cost</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-right text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Quantity</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-right text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Market Value</div>
                                        <div class="text-xs text-gray-600">Last Price</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-right text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Gain/Loss</div>
                                        <div class="text-xs text-gray-600">Gain/Loss %</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-center text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Sector</div>
                                    </div>
                                </th>
                                <th class="px-4 py-2 text-center text-sm">
                                    <div class="flex flex-col">
                                        <div class="font-medium">Portfolio %</div>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody" style="margin-left: 0px;">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Comparison Table (Hidden by default) -->
            <div id="comparisonTable" class="hidden bg-white/95 mb-8 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-center text-gray-700 text-xl font-semibold">Portfolio Comparison - Changes Over Time</h3>
                    <div class="flex items-center space-x-3">
                        <button id="exportComparisonTableBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìä Export
                        </button>
                        <button id="printComparisonTableBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="comparisonDataTable" class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-center">Security</th>
                                <th class="px-4 py-2 text-center">Status</th>
                                <th class="px-4 py-2 text-right">Quantity Change</th>
                                <th class="px-4 py-2 text-right">Market Value Change</th>
                                <th class="px-4 py-2 text-right">P&L Change</th>
                                <th class="px-4 py-2 text-right">Return % Change</th>
                                <th class="px-4 py-2 text-center">Sector</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        
        <!-- Target Price Management Section -->
        <div id="targetPriceSection" class="hidden bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl border border-white/20 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üéØ Target Price Management</h2>
                    <div class="flex items-center space-x-3">
                        <button id="exportTargetPriceBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üìä Export
                        </button>
                        <button id="printTargetPriceBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-800 mb-2">How it works:</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>‚Ä¢ Set target prices for each stock to calculate potential P&L</li>
                        <li>‚Ä¢ Target P&L includes 1.12% broker fees on the selling side</li>
                        <li>‚Ä¢ Click on any cell to edit values</li>
                        <li>‚Ä¢ Changes are automatically saved</li>
                        <li>‚Ä¢ Current prices are based on the latest price from your portfolio</li>
                    </ul>
                </div>

                <div class="overflow-x-auto">
                    <table id="targetPriceTable" class="w-full border-separate border-spacing-0" style="min-width: 1000px;">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b">Stock</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Quantity</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Avg Cost</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Current Price</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Current P&L</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Current P&L%</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Target Price</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Target P&L</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Target P&L%</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b">TP Set Date</th>
                            </tr>
                        </thead>
                        <tbody id="targetPriceTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Total Target P&L</p>
                            <p id="totalTargetPnL" class="text-xl font-bold text-gray-900">Rs. 0.00</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Average Target P&L%</p>
                            <p id="avgTargetPnLPercent" class="text-xl font-bold text-gray-900">0.00%</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-500">Stocks with Targets</p>
                            <p id="stocksWithTargets" class="text-xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
        </div>

        <!-- Portfolio Diversification Chart - REMOVED (Now handled in separate pages) -->
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <span id="notificationIcon" class="text-lg">‚ÑπÔ∏è</span>
                </div>
                <div class="ml-3 flex-1">
                    <p id="notificationMessage" class="text-sm text-gray-900"></p>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
                        <span class="sr-only">Close</span>
                        √ó
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Ensure proper table alignment */
        #portfolioTable th.text-center,
        #portfolioTable td.text-center {
            text-align: center !important;
        }
        #portfolioTable th.text-right,
        #portfolioTable td.text-right {
            text-align: right !important;
        }
        #portfolioTable th.text-left,
        #portfolioTable td.text-left {
            text-align: left !important;
        }
        
        /* DataTable specific overrides */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: #333;
        }

        /* Make table headers clearly sortable */
        .dataTables_wrapper th.sorting,
        .dataTables_wrapper th.sorting_asc,
        .dataTables_wrapper th.sorting_desc {
            cursor: pointer !important;
            position: relative;
            user-select: none;
        }

        .dataTables_wrapper th.sorting:hover,
        .dataTables_wrapper th.sorting_asc:hover,
        .dataTables_wrapper th.sorting_desc:hover {
            background-color: #f3f4f6 !important;
        }

        .dataTables_wrapper th.sorting:after,
        .dataTables_wrapper th.sorting_asc:after,
        .dataTables_wrapper th.sorting_desc:after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }

        .dataTables_wrapper th.sorting:after {
            border-top: 4px solid #999;
            border-bottom: none;
        }

        .dataTables_wrapper th.sorting_asc:after {
            border-bottom: 4px solid #333;
            border-top: none;
        }

        .dataTables_wrapper th.sorting_desc:after {
            border-top: 4px solid #333;
            border-bottom: none;
        }

        /* Ensure table headers are clickable */
        #tradingJournalTable th {
            cursor: pointer !important;
            user-select: none;
        }

        #tradingJournalTable th:hover {
            background-color: #f3f4f6 !important;
        }
    </style>

    <script>
        // Utility functions for number formatting
        function formatNumber(number, decimals = 2) {
            if (number === null || number === undefined || isNaN(number)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(number);
        }

        function formatInteger(number) {
            if (number === null || number === undefined || isNaN(number)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.round(number));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'LKR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Global variables
        let portfolioData = [];
        let sectorMapping = {};
        
        let allUploadedData = [];
        
        // Comparison variables
        let initialPortfolio = null;
        let comparisonMode = false;
        let uploadCount = 0;

        // Database and Storage Management
        let db = null;
        const DB_NAME = 'PortfolioDatabase';
        const DB_VERSION = 1;
        const STORE_NAME = 'portfolios';
        const BACKUP_KEY = 'portfolio_backup_data';
        
        // Portfolio object structure
        class Portfolio {
            constructor(name, date, description = '', holdings = [], metadata = {}) {
                this.id = this.generateId();
                this.name = name;
                this.date = date;
                this.description = description;
                this.holdings = holdings;
                this.metadata = {
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    fileCount: 0,
                    totalSecurities: 0,
                    totalValue: 0,
                    totalCost: 0,
                    ...metadata
                };
            }
            
            generateId() {
                return 'portfolio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            updateMetadata() {
                this.metadata.lastModified = new Date().toISOString();
                this.metadata.totalSecurities = this.holdings.length;
                this.metadata.totalValue = this.holdings.reduce((sum, item) => sum + (item.marketValue || 0), 0);
                this.metadata.totalCost = this.holdings.reduce((sum, item) => sum + (item.totalCost || 0), 0);
            }
        }

        // Database Management Functions
        async function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    // Database error
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object store for portfolios
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                        store.createIndex('createdAt', 'metadata.createdAt', { unique: false });
                    }
                };
            });
        }

        // Save portfolio to IndexedDB
        async function savePortfolioToDB(portfolio) {
            if (!db) {
                await initDatabase();
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // Update metadata before saving
                portfolio.updateMetadata();
                
                const request = store.put(portfolio);
                
                request.onsuccess = () => {
                    // Also save to LocalStorage as backup
                    savePortfolioToLocalStorage(portfolio);
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        // Load portfolio from IndexedDB
        async function loadPortfolioFromDB(portfolioId) {
            if (!db) {
                await initDatabase();
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(portfolioId);
                
                request.onsuccess = () => {
                    if (request.result) {
                        resolve(request.result);
                    } else {
                        reject(new Error('Portfolio not found'));
                    }
                };
                
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        // Get all portfolios from IndexedDB
        async function getAllPortfoliosFromDB() {
            if (!db) {
                await initDatabase();
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const portfolios = request.result.sort((a, b) => 
                        new Date(b.metadata.createdAt) - new Date(a.metadata.createdAt)
                    );
                    resolve(portfolios);
                };
                
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        // Delete portfolio from IndexedDB
        async function deletePortfolioFromDB(portfolioId) {
            if (!db) {
                await initDatabase();
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(portfolioId);
                
                request.onsuccess = () => {
                    // Also remove from LocalStorage backup
                    removePortfolioFromLocalStorage(portfolioId);
                    resolve();
                };
                
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        // LocalStorage Backup Functions
        function savePortfolioToLocalStorage(portfolio) {
            try {
                const backupData = JSON.parse(localStorage.getItem(BACKUP_KEY) || '{}');
                backupData[portfolio.id] = {
                    name: portfolio.name,
                    date: portfolio.date,
                    description: portfolio.description,
                    metadata: portfolio.metadata,
                    holdingsCount: portfolio.holdings.length
                };
                localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
            } catch (error) {
            }
        }

        function removePortfolioFromLocalStorage(portfolioId) {
            try {
                const backupData = JSON.parse(localStorage.getItem(BACKUP_KEY) || '{}');
                delete backupData[portfolioId];
                localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
            } catch (error) {
            }
        }

        // Export/Import Functions
        function exportPortfolio(portfolio) {
            try {
                const dataStr = JSON.stringify(portfolio, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `portfolio_${portfolio.name}_${portfolio.date}.json`;
                link.click();
                
                URL.revokeObjectURL(link.href);
            } catch (error) {
                alert('Error exporting portfolio: ' + error.message);
            }
        }

        function importPortfolio(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const portfolioData = JSON.parse(e.target.result);
                        
                        // Validate portfolio structure
                        if (!portfolioData.name || !portfolioData.date || !Array.isArray(portfolioData.holdings)) {
                            throw new Error('Invalid portfolio file format');
                        }
                        
                        // Create new portfolio object
                        const portfolio = new Portfolio(
                            portfolioData.name,
                            portfolioData.date,
                            portfolioData.description || '',
                            portfolioData.holdings || [],
                            portfolioData.metadata || {}
                        );
                        
                        resolve(portfolio);
                    } catch (error) {
                        reject(new Error('Failed to parse portfolio file: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Generate default portfolio name (YYYYmmdd format)
        function generateDefaultPortfolioName() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function getPortfolioNameFromDate() {
            const dateInput = document.getElementById('portfolioDate');
            if (dateInput && dateInput.value) {
                const date = new Date(dateInput.value);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }
            return generateDefaultPortfolioName();
        }

        // Initialize database when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDatabase();
                
                // Since portfolio management is now the default page, load the portfolio list automatically
                loadPortfolioList();
            } catch (error) {
                alert('Warning: Portfolio database could not be initialized. Some features may not work properly.');
            }
        });

        // Portfolio Management UI Functions
        function showPortfolioManagement() {
            // Hide all other sections
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('portfolioComparisonSection').classList.add('hidden');
            document.getElementById('portfolioDetailSection').classList.add('hidden');
            document.getElementById('tradeAnalysisSection').classList.add('hidden');
            
            // Hide target price section and remove inline styles
            const targetPriceSection = document.getElementById('targetPriceSection');
            if (targetPriceSection) {
                targetPriceSection.classList.add('hidden');
                targetPriceSection.style.display = '';
                targetPriceSection.style.visibility = '';
                targetPriceSection.style.opacity = '';
            }
            
            document.getElementById('multiPortfolioChartView').classList.add('hidden');
            
            // Show portfolio management section
            document.getElementById('portfolioManagementSection').classList.remove('hidden');
            
            loadPortfolioList();
        }


        function showComparisonSection() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('portfolioManagementSection').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('portfolioComparisonSection').classList.remove('hidden');
            loadPortfolioSelects();
        }

        async function loadPortfolioList() {
            try {
                const portfolios = await getAllPortfoliosFromDB();
                const portfolioList = document.getElementById('portfolioList');
                const noPortfoliosMessage = document.getElementById('noPortfoliosMessage');
                const tableViewContainer = document.getElementById('tableViewContainer');
                
                // Get unique portfolios by name (in case of multiple uploads)
                const uniquePortfolios = [];
                const seenNames = new Set();
                
                portfolios.forEach(portfolio => {
                    if (!seenNames.has(portfolio.name)) {
                        seenNames.add(portfolio.name);
                        uniquePortfolios.push(portfolio);
                    } else {
                        // If duplicate name exists, keep the most recent one
                        const existingIndex = uniquePortfolios.findIndex(p => p.name === portfolio.name);
                        if (existingIndex !== -1) {
                            const existingDate = new Date(uniquePortfolios[existingIndex].metadata.createdAt);
                            const newDate = new Date(portfolio.metadata.createdAt);
                            if (newDate > existingDate) {
                                uniquePortfolios[existingIndex] = portfolio;
                            }
                        }
                    }
                });
                
                // Sort portfolios by date (YYYYMMDD format sorts chronologically)
                uniquePortfolios.sort((a, b) => a.name.localeCompare(b.name));
                
                
                if (uniquePortfolios.length === 0) {
                    // Keep the controls but hide the portfolio content
                    const portfolioCards = portfolioList.querySelectorAll('.bg-white.border.border-gray-200.rounded-lg');
                    portfolioCards.forEach(card => card.remove());
                    noPortfoliosMessage.classList.remove('hidden');
                    tableViewContainer.classList.add('hidden');
                    return;
                }
                
                noPortfoliosMessage.classList.add('hidden');
                
                // Clear only the portfolio cards, keep the controls
                const portfolioCards = portfolioList.querySelectorAll('.bg-white.border.border-gray-200.rounded-lg');
                portfolioCards.forEach(card => card.remove());
                
                // Populate both card and table views with unique portfolios
                populateCardView(uniquePortfolios);
                populateTableView(uniquePortfolios);
                
                // Show table view by default
                showTableView();
                
                // Update selection state
                updatePortfolioSelection();
                
                // Update portfolio count display
                updatePortfolioCount();
                
            } catch (error) {
                showNotification('Error loading portfolios: ' + error.message, 'error');
            }
        }

        function populateCardView(portfolios) {
            const portfolioList = document.getElementById('portfolioList');
            
            portfolios.forEach(portfolio => {
                const portfolioCard = createPortfolioCard(portfolio);
                portfolioList.appendChild(portfolioCard);
            });
        }

        function populateTableView(portfolios) {
            const tableBody = document.getElementById('portfolioManagementTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            portfolios.forEach(portfolio => {
                const row = createPortfolioTableRow(portfolio);
                tableBody.appendChild(row);
            });
        }

        function createPortfolioTableRow(portfolio) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const totalValue = portfolio.holdings.reduce((sum, item) => sum + (item.marketValue || 0), 0);
            const totalCost = portfolio.holdings.reduce((sum, item) => sum + (item.totalCost || 0), 0);
            const totalPnL = totalValue - totalCost;
            const totalReturn = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
            
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="checkbox" class="portfolio-checkbox w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" data-portfolio-id="${portfolio.id}" data-portfolio-name="${portfolio.name}">
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <div>
                        <div class="text-sm font-medium text-gray-900">${portfolio.name}</div>
                        ${portfolio.description ? `<div class="text-sm text-gray-500">${portfolio.description}</div>` : ''}
                    </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${getDateFromPortfolioName(portfolio.name)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${portfolio.holdings.length}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">Rs. ${formatNumber(totalValue)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm ${totalPnL >= 0 ? 'text-green-600' : 'text-red-600'}">Rs. ${formatNumber(totalPnL)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm ${totalReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${formatNumber(totalReturn, 2)}%</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="viewPortfolio('${portfolio.id}')" class="text-blue-600 hover:text-blue-900">View</button>
                        <button onclick="exportPortfolioData(${JSON.stringify(portfolio).replace(/"/g, '&quot;')})" class="text-green-600 hover:text-green-900">Export</button>
                        <button onclick="showTargetPriceForPortfolio('${portfolio.id}')" class="text-purple-600 hover:text-purple-900">üéØ Target</button>
                        <button onclick="deletePortfolio('${portfolio.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </div>
                </td>
            `;
            
            return row;
        }

        function createPortfolioCard(portfolio) {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
            
            const totalValue = portfolio.holdings.reduce((sum, item) => sum + (item.marketValue || 0), 0);
            const totalCost = portfolio.holdings.reduce((sum, item) => sum + (item.totalCost || 0), 0);
            const totalPnL = totalValue - totalCost;
            const totalReturn = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;
            
            card.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 pt-1">
                        <input type="checkbox" id="portfolio_${portfolio.id}" class="portfolio-checkbox w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" data-portfolio-id="${portfolio.id}" data-portfolio-name="${portfolio.name}">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${portfolio.name}</h3>
                                <p class="text-sm text-gray-600">${getDateFromPortfolioName(portfolio.name)}</p>
                                ${portfolio.description ? `<p class="text-sm text-gray-500 mt-1">${portfolio.description}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Created: ${new Date(portfolio.metadata.createdAt).toLocaleDateString()}</p>
                                <p class="text-sm text-gray-500">Modified: ${new Date(portfolio.metadata.lastModified).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex space-x-3">
                                <button id="setTargetPricesBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    üéØ Set Target Prices
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Securities</p>
                                <p class="text-lg font-semibold text-gray-900">${portfolio.holdings.length}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Total Value</p>
                                <p class="text-lg font-semibold text-gray-900">Rs. ${formatNumber(totalValue)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Total P&L</p>
                                <p class="text-lg font-semibold ${totalPnL >= 0 ? 'text-green-600' : 'text-red-600'}">Rs. ${formatNumber(totalPnL)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">Return %</p>
                                <p class="text-lg font-semibold ${totalReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${formatNumber(totalReturn, 2)}%</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="viewPortfolio('${portfolio.id}')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                üëÅÔ∏è View
                            </button>
                            <button onclick="exportPortfolioData(${JSON.stringify(portfolio).replace(/"/g, '&quot;')})" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                üì• Export
                            </button>
                            <button onclick="showTargetPriceForPortfolio('${portfolio.id}')" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                üéØ Target
                            </button>
                            <button onclick="deletePortfolio('${portfolio.id}')" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded transition-colors">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        async function loadPortfolioSelects() {
            try {
                const portfolios = await getAllPortfoliosFromDB();
                const initialSelect = document.getElementById('initialPortfolioSelect');
                const currentSelect = document.getElementById('currentPortfolioSelect');
                
                // Clear existing options
                initialSelect.innerHTML = '<option value="">Select initial portfolio...</option>';
                currentSelect.innerHTML = '<option value="">Select current portfolio...</option>';
                
                portfolios.forEach(portfolio => {
                    const option = document.createElement('option');
                    option.value = portfolio.id;
                    option.textContent = `${portfolio.name} (${getDateFromPortfolioName(portfolio.name)}) - ${portfolio.holdings.length} securities`;
                    
                    initialSelect.appendChild(option.cloneNode(true));
                    currentSelect.appendChild(option);
                });
                
                // Enable/disable compare button based on selection
                updateCompareButtonState();
                
            } catch (error) {
            }
        }

        function updateCompareButtonState() {
            const initialSelect = document.getElementById('initialPortfolioSelect');
            const currentSelect = document.getElementById('currentPortfolioSelect');
            const compareBtn = document.getElementById('comparePortfoliosBtn');
            
            const canCompare = initialSelect.value && currentSelect.value && initialSelect.value !== currentSelect.value;
            compareBtn.disabled = !canCompare;
        }

        async function viewPortfolio(portfolioId) {
            try {
                const portfolio = await loadPortfolioFromDB(portfolioId);
                
                // Set the portfolio data and show dashboard
                portfolioData = portfolio.holdings;
                sectorMapping = {...defaultSectorMapping};
                
                // Add sectors to portfolio data
                portfolioData.forEach(item => {
                    item.sector = sectorMapping[item.security] || 'Unknown';
                });
                
                // Reset comparison mode
                comparisonMode = false;
                initialPortfolio = null;
                
                // Show dashboard
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('portfolioManagementSection').classList.add('hidden');
                document.getElementById('uploadModal').classList.add('hidden');
                document.getElementById('portfolioComparisonSection').classList.add('hidden');
                
                // Hide comparison elements for individual view
                document.getElementById('comparisonCards').classList.add('hidden');
                document.getElementById('comparisonTable').classList.add('hidden');
                
                // Update dashboard title to show portfolio name
                const dashboardTitle = document.querySelector('#dashboardContent h1') || document.querySelector('#dashboardContent h2');
                if (dashboardTitle) {
                    dashboardTitle.textContent = `Portfolio: ${portfolio.name} (${getDateFromPortfolioName(portfolio.name)})`;
                }
                
                // Store current portfolio for target price management
                window.currentPortfolio = portfolio;
                
                
                // Refresh dashboard
                refreshDashboard();
                
            } catch (error) {
                alert('Error loading portfolio: ' + error.message);
            }
        }

        async function deletePortfolio(portfolioId) {
            if (!confirm('Are you sure you want to delete this portfolio? This action cannot be undone.')) {
                return;
            }
            
            try {
                await deletePortfolioFromDB(portfolioId);
                loadPortfolioList(); // Refresh the list
                alert('Portfolio deleted successfully');
            } catch (error) {
                alert('Error deleting portfolio: ' + error.message);
            }
        }

        function exportPortfolioData(portfolio) {
            exportPortfolio(portfolio);
        }

        // Event Listeners for Portfolio Management
        document.addEventListener('DOMContentLoaded', function() {
            // Portfolio Management button
            const portfolioManagementBtn = document.getElementById('portfolioManagementBtn');
            if (portfolioManagementBtn) {
                portfolioManagementBtn.addEventListener('click', showPortfolioManagement);
            }
            
        // Stock Calculator button
        const stockCalculatorBtn = document.getElementById('stockCalculatorBtn');
        if (stockCalculatorBtn) {
            stockCalculatorBtn.addEventListener('click', function() {
                window.open('stock-calculator.html', '_blank');
            });
        }

        // Target Price Manager button
        const targetPriceManagerBtn = document.getElementById('targetPriceManagerBtn');
        if (targetPriceManagerBtn) {
            targetPriceManagerBtn.addEventListener('click', function() {
                window.open('target-price-manager.html', '_blank');
            });
        }
            
            // Back to Upload button
            
            // New Portfolio button
            const newPortfolioBtn = document.getElementById('newPortfolioBtn');
            if (newPortfolioBtn) {
                newPortfolioBtn.addEventListener('click', () => {
                    // Generate new portfolio name
                    const newName = generateDefaultPortfolioName();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('portfolioDate').value = today;
                    document.getElementById('portfolioDescription').value = '';
                    
                    // Open upload modal
                    const uploadModal = document.getElementById('uploadModal');
                    if (uploadModal) {
                        uploadModal.classList.remove('hidden');
                    } else {
                    }
                    
                    // Show message in console for production
                });
            } else {
            }
            
            // Compare Portfolios button in management section
            const comparePortfoliosBtn = document.getElementById('comparePortfoliosBtn');
            if (comparePortfoliosBtn) {
                comparePortfoliosBtn.addEventListener('click', showComparisonSection);
            }
            
            // Import Portfolio button
            const importPortfolioBtn = document.getElementById('importPortfolioBtn');
            if (importPortfolioBtn) {
                importPortfolioBtn.addEventListener('click', () => {
                    const dropdown = document.getElementById('importDropdown');
                    dropdown.classList.toggle('hidden');
                });
            }
            
            // Import dropdown options
            const importSingleBtn = document.getElementById('importSingleBtn');
            if (importSingleBtn) {
                importSingleBtn.addEventListener('click', () => {
                    document.getElementById('portfolioImportFile').click();
                    document.getElementById('importDropdown').classList.add('hidden');
                });
            }
            
            const importZipBtn = document.getElementById('importZipBtn');
            if (importZipBtn) {
                importZipBtn.addEventListener('click', () => {
                    document.getElementById('zipImportFile').click();
                    document.getElementById('importDropdown').classList.add('hidden');
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const importBtn = document.getElementById('importPortfolioBtn');
                const dropdown = document.getElementById('importDropdown');
                
                if (dropdown && !dropdown.contains(event.target) && !importBtn.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // Portfolio import file input
            const portfolioImportFile = document.getElementById('portfolioImportFile');
            if (portfolioImportFile) {
                portfolioImportFile.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            const portfolio = await importPortfolio(file);
                            await savePortfolioToDB(portfolio);
                            alert('Portfolio imported successfully!');
                            loadPortfolioList();
                        } catch (error) {
                            alert('Error importing portfolio: ' + error.message);
                        }
                        // Reset file input
                        portfolioImportFile.value = '';
                    }
                });
            }
            
            // Zip import file input
            const zipImportFile = document.getElementById('zipImportFile');
            if (zipImportFile) {
                zipImportFile.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            await importPortfoliosFromZip(file);
                        } catch (error) {
                            alert('Error importing portfolios: ' + error.message);
                        }
                        // Reset file input
                        zipImportFile.value = '';
                    }
                });
            }
            

            
            // Compare selected portfolios button
            const compareSelectedBtn = document.getElementById('compareSelectedBtn');
            if (compareSelectedBtn) {
                compareSelectedBtn.addEventListener('click', compareSelectedPortfolios);
            }
            
            
            // Portfolio comparison selects
            const initialSelect = document.getElementById('initialPortfolioSelect');
            const currentSelect = document.getElementById('currentPortfolioSelect');
            if (initialSelect && currentSelect) {
                initialSelect.addEventListener('change', updateCompareButtonState);
                currentSelect.addEventListener('change', updateCompareButtonState);
            }
            
            // Compare portfolios button in comparison section
            const comparePortfoliosBtnComparison = document.getElementById('comparePortfoliosBtn');
            if (comparePortfoliosBtnComparison) {
                comparePortfoliosBtnComparison.addEventListener('click', async () => {
                    const initialId = initialSelect.value;
                    const currentId = currentSelect.value;
                    
                    if (!initialId || !currentId || initialId === currentId) {
                        alert('Please select two different portfolios to compare');
                        return;
                    }
                    
                    try {
                        const initialPortfolioData = await loadPortfolioFromDB(initialId);
                        const currentPortfolioData = await loadPortfolioFromDB(currentId);
                        
                        // Set up comparison mode
                        comparisonMode = true;
                        initialPortfolio = initialPortfolioData.holdings;
                        portfolioData = currentPortfolioData.holdings;
                        
                        // Add sectors
                        sectorMapping = {...defaultSectorMapping};
                        portfolioData.forEach(item => {
                            item.sector = sectorMapping[item.security] || 'Unknown';
                        });
                        
                        // Show dashboard with comparison
                        document.getElementById('dashboardContent').classList.remove('hidden');
                        document.getElementById('portfolioComparisonSection').classList.add('hidden');
                        document.getElementById('uploadModal').classList.add('hidden');
                        document.getElementById('portfolioManagementSection').classList.add('hidden');
                        
                        // Show comparison elements
                        document.getElementById('comparisonCards').classList.remove('hidden');
                        document.getElementById('comparisonTable').classList.remove('hidden');
                        
                        // Calculate and display comparison data
                        calculateComparisonData(initialPortfolio, portfolioData);
                        
                        // Refresh dashboard
                        refreshDashboard();
                        
                    } catch (error) {
                        alert('Error setting up comparison: ' + error.message);
                    }
                });
            }
            
            // Set default portfolio name
            const portfolioNameInput = document.getElementById('portfolioName');
            if (portfolioNameInput) {
                portfolioNameInput.value = generateDefaultPortfolioName();
            }
            
            // Add event delegation for portfolio checkboxes
            document.addEventListener('change', function(event) {
                if (event.target.classList.contains('portfolio-checkbox')) {
                    updatePortfolioSelection();
                }
            });
        });

        // Comparison mode toggle functionality
        try {
            const comparisonCheckbox = document.getElementById('comparisonMode');
            if (comparisonCheckbox) {
                comparisonCheckbox.addEventListener('change', function() {
                    comparisonMode = this.checked;
                    uploadCount = 0;
                    initialPortfolio = null;
                    
                    if (comparisonMode) {
                        // Reset dashboard when entering comparison mode
                        const dashboardContent = document.getElementById('dashboardContent');
                        if (dashboardContent) {
                            dashboardContent.classList.add('hidden');
                        }
                        document.getElementById('uploadModal').classList.remove('hidden');
                        
                        // Clear any existing data
                        portfolioData = [];
                        allUploadedData = [];
                        cleanupCharts();
                        
                        alert('Comparison mode enabled! Upload your first portfolio (e.g., yesterday) to begin.');
                    }
                });
            }
        } catch (error) {
        }

        // Upload Modal functionality
        try {
            const uploadModal = document.getElementById('uploadModal');
            const closeUploadModal = document.getElementById('closeUploadModal');
            
            if (closeUploadModal && uploadModal) {
                closeUploadModal.addEventListener('click', function() {
                    uploadModal.classList.add('hidden');
                });
            }
            
            // Close modal when clicking outside
            if (uploadModal) {
                uploadModal.addEventListener('click', function(e) {
                    if (e.target === uploadModal) {
                        uploadModal.classList.add('hidden');
                    }
                });
            }
        } catch (error) {
        }

        // Export and Print button event listeners
        const exportTradingJournalBtn = document.getElementById('exportTradingJournalBtn');
        if (exportTradingJournalBtn) {
            exportTradingJournalBtn.addEventListener('click', () => {
                exportTableToCSV('tradingJournalTable', 'trading_journal.csv');
            });
        }

        const printTradingJournalBtn = document.getElementById('printTradingJournalBtn');
        if (printTradingJournalBtn) {
            printTradingJournalBtn.addEventListener('click', () => {
                printTable('tradingJournalTable', 'Daily Trading Journal');
            });
        }

        const exportHoldingsSummaryBtn = document.getElementById('exportHoldingsSummaryBtn');
        if (exportHoldingsSummaryBtn) {
            exportHoldingsSummaryBtn.addEventListener('click', () => {
                exportTableToCSV('holdingsSummaryTable', 'holdings_summary.csv');
            });
        }

        const printHoldingsSummaryBtn = document.getElementById('printHoldingsSummaryBtn');
        if (printHoldingsSummaryBtn) {
            printHoldingsSummaryBtn.addEventListener('click', () => {
                printTable('holdingsSummaryTable', 'Current Holdings Summary');
            });
        }

        const exportPortfolioTableBtn = document.getElementById('exportPortfolioTableBtn');
        if (exportPortfolioTableBtn) {
            exportPortfolioTableBtn.addEventListener('click', () => {
                exportTableToCSV('portfolioTable', 'portfolio_details.csv');
            });
        }

        const printPortfolioTableBtn = document.getElementById('printPortfolioTableBtn');
        if (printPortfolioTableBtn) {
            printPortfolioTableBtn.addEventListener('click', () => {
                printTable('portfolioTable', 'Portfolio Details');
            });
        }

        const exportTargetPriceBtn = document.getElementById('exportTargetPriceBtn');
        if (exportTargetPriceBtn) {
            exportTargetPriceBtn.addEventListener('click', () => {
                exportTableToCSV('targetPriceTable', 'target_price_management.csv');
            });
        }

        const printTargetPriceBtn = document.getElementById('printTargetPriceBtn');
        if (printTargetPriceBtn) {
            printTargetPriceBtn.addEventListener('click', () => {
                printTable('targetPriceTable', 'Target Price Management');
            });
        }

        const exportComparisonTableBtn = document.getElementById('exportComparisonTableBtn');
        if (exportComparisonTableBtn) {
            exportComparisonTableBtn.addEventListener('click', () => {
                exportTableToCSV('comparisonDataTable', 'portfolio_comparison.csv');
            });
        }

        const printComparisonTableBtn = document.getElementById('printComparisonTableBtn');
        if (printComparisonTableBtn) {
            printComparisonTableBtn.addEventListener('click', () => {
                printTable('comparisonDataTable', 'Portfolio Comparison');
            });
        }


        // Function to refresh dashboard with current combined data
        function refreshDashboard() {
            try {
                // Check if we have data to display
                if (!portfolioData || portfolioData.length === 0) {
                    return;
                }
                
                // Check if dashboard is visible
                const dashboardContent = document.getElementById('dashboardContent');
                if (!dashboardContent || dashboardContent.classList.contains('hidden')) {
                    return;
                }
                
                // Clean up all existing charts
                cleanupCharts();
                
                // Clear chart canvases
                const canvases = ['allocationChart', 'performanceChart', 'sectorChart', 'sectorPerformanceChart'];
                canvases.forEach(canvasId => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        canvas.width = canvas.width;
                        canvas.height = canvas.height;
                    }
                });
                
                // Wait a bit for cleanup to complete
                setTimeout(() => {
                    // Refresh all dashboard components
                    calculateSummary();
                    createAllocationChart();
                    createPerformanceChart();
                    createSectorChart();
                    createSectorPerformanceChart();
                    createDiversificationChart(portfolioData);
                    populateTable();
                    populateTradingJournal();
                    
                    // If in comparison mode, also refresh comparison data
                    if (comparisonMode && initialPortfolio && portfolioData.length > 0) {
                        calculateComparisonData(initialPortfolio, portfolioData);
                    }
                }, 1000);
                
            } catch (error) {
            }
        }

        // Function to clean up all charts
        function cleanupCharts() {
            try {
                // Destroy all existing Chart.js instances
                Chart.helpers.each(Chart.instances, (instance) => {
                    instance.destroy();
                });
                
                // Also try to destroy charts by canvas ID
                const canvasIds = ['allocationChart', 'performanceChart', 'sectorChart', 'sectorPerformanceChart'];
                canvasIds.forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const chart = Chart.getChart(canvas);
                        if (chart) {
                            chart.destroy();
                        }
                    }
                });
            } catch (error) {
            }
        }

        // Clear data button functionality
        try {
            const clearDataBtn = document.getElementById('clearDataBtn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear all data and start over?')) {
                        // Reset everything
                        portfolioData = [];
                        allUploadedData = [];
                        initialPortfolio = null;
                        uploadCount = 0;
                        comparisonMode = false;
                        
                        // Reset UI
                        document.getElementById('comparisonMode').checked = false;
                        document.getElementById('uploadModal').classList.remove('hidden');
                        document.getElementById('dashboardContent').classList.add('hidden');
                        document.getElementById('comparisonCards').classList.add('hidden');
                        document.getElementById('comparisonTable').classList.add('hidden');
                        this.classList.add('hidden');
                        
                        // Clear file input
                        document.getElementById('csvFile').value = '';
                        
                        // Clean up charts and tables
                        cleanupCharts();
                        if ($.fn.DataTable.isDataTable('#portfolioTable')) {
                            $('#portfolioTable').DataTable().destroy();
                        }
                        if ($.fn.DataTable.isDataTable('#comparisonDataTable')) {
                            $('#comparisonDataTable').DataTable().destroy();
                        }
                        
                        alert('All data cleared. You can start fresh.');
                    }
                });
            }
        } catch (error) {
        }

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', function() {
                    const fileInput = document.getElementById('csvFile');
                    const files = fileInput.files;
                    
                    if (!files || files.length === 0) {
                        alert('Please select one or more CSV files first');
                        return;
                    }
                    
                    // Store the files before clearing the input
                    const filesToProcess = Array.from(files);
                    
                    
                    // Automatically clear any existing data first to prevent partial data issues
                    allUploadedData = [];
                    portfolioData = [];
                    sectorMapping = {};
                    
                    
                    // Hide dashboard if it was previously shown
                    const dashboardContent = document.getElementById('dashboardContent');
                    if (dashboardContent) {
                        dashboardContent.classList.add('hidden');
                    }
                    
                    // Hide settings button if it was previously shown
                    document.getElementById('settingsButtonContainer').classList.add('hidden');
                    
                    // Clear file input AFTER storing the files
                    document.getElementById('csvFile').value = '';
                    
                    // Clear table if it exists
                    const tableBody = document.getElementById('portfolioTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = '';
                    }
                    
                    // Destroy DataTable if it exists
                    if ($.fn.DataTable.isDataTable('#portfolioTable')) {
                        $('#portfolioTable').DataTable().destroy();
                    }
                    
                    // Clean up charts
                    cleanupCharts();
                    
                    // Reset summary cards
                    document.getElementById('totalMarketValue').textContent = 'Rs. 0';
                    document.getElementById('totalCost').textContent = 'Rs. 0';
                    document.getElementById('totalPnL').textContent = 'Rs. 0';
                    document.getElementById('totalReturn').textContent = '0.00%';
                    
                    // Process all files
                    let processedFiles = 0;
                    let totalSecurities = 0;
                    
                    const processFiles = async (fileList) => {
                        for (let i = 0; i < fileList.length; i++) {
                            const file = fileList[i];
                            
                            try {
                                const fileData = await readFileAsync(file);
                                
                                let newData = [];
                                
                                if (fileData.type === 'csv') {
                                    newData = parseCSV(fileData.data);
                                } else if (fileData.type === 'excel') {
                                    newData = parseExcel(fileData.data);
                                }
                                
                                
                                if (newData && newData.length > 0) {
                                    // Check for duplicates before adding
                                    const existingSecurities = new Set(allUploadedData.map(item => item.security));
                                    const newSecurities = newData.map(item => item.security);
                                    const duplicateSecurities = newSecurities.filter(security => existingSecurities.has(security));
                                    
                                    if (duplicateSecurities.length > 0) {
                                    }
                                    
                                    allUploadedData.push(...newData);
                                    totalSecurities += newData.length;
                                    processedFiles++;
                                } else {
                                }
                            } catch (error) {
                            }
                        }
                        
                        // All files processed, now combine and display
                        if (allUploadedData.length > 0) {
                            try {
                                // Combine portfolios and aggregate by security
                                portfolioData = combinePortfolios(allUploadedData);
                                
                                // Use default sector mapping
                                sectorMapping = {...defaultSectorMapping};
                                
                                // Add sectors to portfolio data
                                portfolioData.forEach(item => {
                                    item.sector = sectorMapping[item.security] || 'Unknown';
                                });
                                
                                if (comparisonMode) {
                                    // Handle comparison mode
                                    uploadCount++;
                                    
                                    if (uploadCount === 1) {
                                        // First upload - store as initial portfolio
                                        initialPortfolio = JSON.parse(JSON.stringify(portfolioData));
                                        alert(`First portfolio uploaded successfully!\n\nTotal securities: ${portfolioData.length}\n\nNow upload your second portfolio (e.g., today's data) to see the comparison.`);
                                        
                                        // Show clear data button
                                        document.getElementById('clearDataBtn').classList.remove('hidden');
                                        
                                        // Clear current data for second upload
                                        portfolioData = [];
                                        allUploadedData = [];
                                        document.getElementById('csvFile').value = '';
                                        
                                    } else if (uploadCount === 2) {
                                        // Second upload - show comparison
                                        const currentPortfolio = JSON.parse(JSON.stringify(portfolioData));
                                        
                                        // Show dashboard with comparison
                                if (dashboardContent) {
                                    dashboardContent.classList.remove('hidden');
                                            document.getElementById('uploadModal').classList.add('hidden');
                                            
                                            // Show comparison elements
                                            document.getElementById('comparisonCards').classList.remove('hidden');
                                            document.getElementById('comparisonTable').classList.remove('hidden');
                                            
                                            // Calculate and display comparison data
                                            calculateComparisonData(initialPortfolio, currentPortfolio);
                                            
                                            // Refresh dashboard with comparison
                                            refreshDashboard();
                                            
                                            alert(`Comparison complete!\n\nInitial portfolio: ${initialPortfolio.length} securities\nCurrent portfolio: ${currentPortfolio.length} securities\n\nDashboard now shows comparison charts and change indicators.`);
                                        }
                                    }
                                } else {
                                    // Normal mode - save portfolio to database and show options
                                    const portfolioName = getPortfolioNameFromDate();
                                    const portfolioDescription = document.getElementById('portfolioDescription').value || '';
                                    const portfolioDate = document.getElementById('portfolioDate').value; // Get selected date
                                    
                                    // Create portfolio object
                                    const portfolio = new Portfolio(
                                        portfolioName,
                                        portfolioDate,
                                        portfolioDescription,
                                        portfolioData,
                                        { fileCount: filesToProcess.length }
                                    );
                                    
                                    try {
                                        // Save to database
                                        await savePortfolioToDB(portfolio);
                                        
                                        // Show success message with options
                                        const choice = confirm(
                                            `Portfolio "${portfolioName}" saved successfully!\n\n` +
                                            `Total securities: ${portfolioData.length}\n` +
                                            `Total value: Rs. ${formatNumber(portfolio.metadata.totalValue)}\n\n` +
                                            `Would you like to view this portfolio now?\n\n` +
                                            `Click OK to view, Cancel to return to management.`
                                        );
                                        
                                        if (choice) {
                                            // Show dashboard with the portfolio
                                            if (dashboardContent) {
                                                dashboardContent.classList.remove('hidden');
                                    document.getElementById('uploadModal').classList.add('hidden');
                                                document.getElementById('settingsButtonContainer').classList.remove('hidden');
                                                document.getElementById('settingsBtn').textContent = '‚öôÔ∏è Settings';
                                                
                                                // Refresh the dashboard
                                                refreshDashboard();
                                                
                                                alert(`Portfolio "${portfolioName}" is now displayed in the dashboard.`);
                                            }
                                        } else {
                                            // Return to portfolio management
                                            showPortfolioManagement();
                                        }
                                        
                                    } catch (error) {
                                        alert('Error saving portfolio: ' + error.message);
                                        
                                        // Still show dashboard even if save failed
                                        if (dashboardContent) {
                                            dashboardContent.classList.remove('hidden');
                                            document.getElementById('uploadModal').classList.add('hidden');
                                    document.getElementById('settingsButtonContainer').classList.remove('hidden');
                                    document.getElementById('settingsBtn').textContent = '‚öôÔ∏è Settings';
                                    
                                    // Refresh the dashboard
                                    refreshDashboard();
                                    
                                            alert(`Portfolio processed but could not be saved to database.\n\nDashboard shows the data, but it won't be saved for future use.`);
                                        }
                                    }
                                }
                            } catch (error) {
                                alert('Error processing portfolio data: ' + error.message);
                            }
                        } else {
                            alert('No valid data found in any of the selected portfolio files');
                        }
                    };
                    
                    // Start processing files - pass the stored files array
                    processFiles(filesToProcess);
                });
            }
        } catch (error) {
            console.error('Error setting up upload button:', error);
        }
        });
        
        // Helper function to read file asynchronously
        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.name.toLowerCase().endsWith('.csv')) {
                    // Handle CSV files
                    reader.onload = (e) => resolve({ type: 'csv', data: e.target.result });
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
                } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    // Handle Excel files
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            resolve({ type: 'excel', data: workbook });
                        } catch (error) {
                            reject(new Error('Failed to parse Excel file: ' + error.message));
                        }
                    };
                    reader.onerror = (e) => reject(e);
                    reader.readAsArrayBuffer(file);
                } else {
                    reject(new Error('Unsupported file format. Please use CSV, XLSX, or XLS files.'));
                }
            });
        }

        // Combine portfolios and aggregate by security
        function combinePortfolios(allData) {
            if (!Array.isArray(allData)) {
                return [];
            }
            
            
            const combined = {};
            let processedCount = 0;
            let newSecuritiesCount = 0;
            let aggregatedSecuritiesCount = 0;
            let duplicateCount = 0;
            
            allData.forEach((item, index) => {
                processedCount++;
                
                if (!item.security) {
                    return;
                }
                
                if (combined[item.security]) {
                    // Aggregate existing security
                    const oldQuantity = combined[item.security].quantity;
                    const oldTotalCost = combined[item.security].totalCost;
                    const oldMarketValue = combined[item.security].marketValue;
                    const oldUnrealizedPnL = combined[item.security].unrealizedPnL;
                    
                    combined[item.security].quantity += item.quantity;
                    combined[item.security].totalCost += item.totalCost;
                    combined[item.security].marketValue += item.marketValue;
                    combined[item.security].unrealizedPnL += item.unrealizedPnL;
                    
                    // Recalculate average price
                    combined[item.security].avgPrice = combined[item.security].totalCost / combined[item.security].quantity;
                    // Recalculate return percentage
                    combined[item.security].returnPercent = (combined[item.security].unrealizedPnL / combined[item.security].totalCost) * 100;
                    
                    aggregatedSecuritiesCount++;
                    duplicateCount++;
                } else {
                    // Add new security
                    combined[item.security] = { ...item };
                    newSecuritiesCount++;
                }
            });
            
            const result = Object.values(combined);
            
            return result;
        }

        // Excel Parser
        function parseExcel(workbook) {
            try {
                const data = [];
                
                // Only process the first sheet to avoid duplication
                const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Try different parsing approaches
                    let jsonData = [];
                    try {
                        // First try: with headers
                        jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    } catch (e) {
                        try {
                            jsonData = XLSX.utils.sheet_to_json(worksheet);
                        } catch (e2) {
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true, header: 1 });
                        }
                    }
                    
                    if (jsonData.length > 0) {
                    }
                    
                    if (jsonData.length === 0) return;
                    
                    // Find the header row
                    let headerRowIndex = 0;
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => cell && cell.toString().includes('Security'))) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    const headers = jsonData[headerRowIndex] || [];
                    
                    // Process data rows
                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const item = {};
                        headers.forEach((header, index) => {
                            if (header && row[index] !== undefined) {
                                item[header] = row[index];
                            }
                        });
                        
                        // Map the specific columns from your Excel format - using exact headers
                        const mappedItem = {
                            security: item['Security'] || '',
                            quantity: safeParseNumber(item['Quantity'] || 0),
                            avgPrice: safeParseNumber(item['Avg Price'] || 0),
                            totalCost: safeParseNumber(item['Total Cost'] || 0),
                            marketValue: safeParseNumber(item['Market Value'] || 0),
                            unrealizedPnL: safeParseNumber(item['Unrealized Gain / (Loss)'] || 0),
                            returnPercent: safeParseNumber(item['Unrealized Gain/Loss %'] || 0)
                        };
                        
                        
                        // Only add if we have valid security data and it's not a summary row
                        if (mappedItem.security && 
                            mappedItem.security !== 'Security' && 
                            mappedItem.security.toString().length > 0 &&
                            !mappedItem.security.toLowerCase().includes('total') &&
                            !mappedItem.security.toLowerCase().includes('portfolio') &&
                            !mappedItem.security.toLowerCase().includes('summary') &&
                            !mappedItem.security.toLowerCase().includes('grand total')) {
                            
                            // Check for duplicate securities within this sheet
                            const existingIndex = data.findIndex(existing => existing.security === mappedItem.security);
                            if (existingIndex !== -1) {
                            }
                            
                            // Calculate missing values if possible
                            if (mappedItem.quantity && mappedItem.avgPrice && !mappedItem.totalCost) {
                                mappedItem.totalCost = mappedItem.quantity * mappedItem.avgPrice;
                            }
                            if (mappedItem.totalCost && mappedItem.marketValue && !mappedItem.unrealizedPnL) {
                                // Calculate unrealized P&L with 1.12% brokerage fee
                                const grossProceeds = mappedItem.marketValue;
                                const brokerFees = grossProceeds * 0.0112; // 1.12% broker fees
                                const netProceeds = grossProceeds - brokerFees;
                                mappedItem.unrealizedPnL = netProceeds - mappedItem.totalCost;
                            }
                            if (mappedItem.totalCost && mappedItem.unrealizedPnL && !mappedItem.returnPercent) {
                                mappedItem.returnPercent = (mappedItem.unrealizedPnL / mappedItem.totalCost) * 100;
                            }
                            
                            data.push(mappedItem);
                        } else {
                            if (mappedItem.security && mappedItem.security.toString().length > 0) {
                                if (mappedItem.security.toLowerCase().includes('total') ||
                                    mappedItem.security.toLowerCase().includes('portfolio') ||
                                    mappedItem.security.toLowerCase().includes('summary') ||
                                    mappedItem.security.toLowerCase().includes('grand total')) {
                                } else {
                                }
                            } else {
                            }
                        }
                    }
                
                return data;
            } catch (error) {
                return [];
            }
        }

        // CSV Parser
        function parseCSV(csvText) {
            try {
                const lines = csvText.split('\n');
                
                // Find the line with actual headers (skip portfolio title lines)
                let headerLineIndex = 0;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Security') && lines[i].includes('Quantity')) {
                        headerLineIndex = i;
                        break;
                    }
                }
                
                if (headerLineIndex === 0) {
                    // Try to find any line that might contain headers
                    for (let i = 0; i < Math.min(10, lines.length); i++) {
                        if (lines[i].includes('Security')) {
                            headerLineIndex = i;
                            break;
                        }
                    }
                }
                
                const headers = parseCSVLine(lines[headerLineIndex]);
                
                const data = [];
                for (let i = headerLineIndex + 1; i < lines.length; i++) {
                    if (lines[i].trim() && !lines[i].includes('Total') && !lines[i].includes('Portfolio')) {
                        const values = parseCSVLine(lines[i]);
                        const item = {};
                        
                        headers.forEach((header, index) => {
                            if (values[index]) {
                                item[header] = values[index];
                            }
                        });
                        
                        // Map the specific columns from your CSV format - using exact headers
                        const mappedItem = {
                            security: item['Security'] || '',
                            quantity: safeParseNumber(item['Quantity'] || '0'),
                            avgPrice: safeParseNumber(item['Avg Price'] || '0'),
                            totalCost: safeParseNumber(item['Total Cost'] || '0'),
                            marketValue: safeParseNumber(item['Market Value'] || '0'),
                            unrealizedPnL: safeParseNumber(item['Unrealized Gain / (Loss)'] || '0'),
                            returnPercent: safeParseNumber(item['Unrealized Gain/Loss %'] || '0')
                        };
                        
                        // Only add if we have valid security data
                        if (mappedItem.security && mappedItem.security !== 'Security' && mappedItem.security.length > 0) {
                            // Calculate missing values if possible
                            if (mappedItem.quantity && mappedItem.avgPrice && !mappedItem.totalCost) {
                                mappedItem.totalCost = mappedItem.quantity * mappedItem.avgPrice;
                            }
                            if (mappedItem.totalCost && mappedItem.marketValue && !mappedItem.unrealizedPnL) {
                                // Calculate unrealized P&L with 1.12% brokerage fee
                                const grossProceeds = mappedItem.marketValue;
                                const brokerFees = grossProceeds * 0.0112; // 1.12% broker fees
                                const netProceeds = grossProceeds - brokerFees;
                                mappedItem.unrealizedPnL = netProceeds - mappedItem.totalCost;
                            }
                            if (mappedItem.totalCost && mappedItem.unrealizedPnL && !mappedItem.returnPercent) {
                                mappedItem.returnPercent = (mappedItem.unrealizedPnL / mappedItem.totalCost) * 100;
                            }
                            
                            data.push(mappedItem);
                        }
                    }
                }
                
                return data;
            } catch (error) {
                return [];
            }
        }
        
        // Helper function to properly parse CSV lines with quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            // Remove quotes from each field
            return result.map(field => field.replace(/^"|"$/g, ''));
        }
        
        // Safe number parsing function that handles all edge cases
        function safeParseNumber(value) {
            try {
                // Handle null, undefined, empty strings
                if (value === null || value === undefined || value === '') {
                    return 0;
                }
                
                // If it's already a number, return it
                if (typeof value === 'number') {
                    return isNaN(value) ? 0 : value;
                }
                
                // Convert to string
                let str = String(value);
                
                // Handle zero values
                if (str === '0' || str === '0.00' || str === '0.0' || str === '0.000') {
                    return 0;
                }
                
                // Remove all commas and spaces
                let cleanStr = str.replace(/[, ]/g, '');
                
                // Handle negative numbers
                const isNegative = cleanStr.startsWith('-');
                if (isNegative) {
                    cleanStr = cleanStr.substring(1);
                }
                
                // Parse the number
                const result = parseFloat(cleanStr);
                
                // Check if parsing was successful
                if (isNaN(result)) {
                    return 0;
                }
                
                return isNegative ? -result : result;
            } catch (error) {
                return 0;
            }
        }
        
        // Helper function to parse Indian/Sri Lankan number format
        function parseIndianNumber(numStr) {
            if (numStr === null || numStr === undefined || numStr === '') return 0;
            
            // Convert to string if it's a number
            let str = String(numStr);
            
            // Handle zero values
            if (str === '0' || str === '0.00' || str === '0.0') return 0;
            
            // Remove all commas first
            let cleanStr = str.replace(/,/g, '');
            
            // Handle negative numbers
            const isNegative = cleanStr.startsWith('-');
            if (isNegative) {
                cleanStr = cleanStr.substring(1);
            }
            
            // Parse the number
            const result = parseFloat(cleanStr);
            
            // Check if parsing was successful
            if (isNaN(result)) {
                return 0;
            }
            
            return isNegative ? -result : result;
        }
        
        // Helper function to format numbers with standard thousand separators
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0.00';
            
            const isNegative = num < 0;
            const absNum = Math.abs(num);
            
            // Format with standard thousand separators
            if (absNum >= 1000000) {
                return (isNegative ? '-' : '') + new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(absNum / 1000000) + 'M';
            } else if (absNum >= 1000) {
                return (isNegative ? '-' : '') + absNum.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } else {
                return (isNegative ? '-' : '') + new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(absNum);
            }
        }

        // Calculate comparison data between two portfolios
        function calculateComparisonData(initial, current) {
            try {
                // Create maps for easy lookup
                const initialMap = new Map();
                const currentMap = new Map();
                
                initial.forEach(item => initialMap.set(item.security, item));
                current.forEach(item => currentMap.set(item.security, item));
                
                // Calculate summary changes
                const initialTotalValue = initial.reduce((sum, item) => sum + (item.marketValue || 0), 0);
                const currentTotalValue = current.reduce((sum, item) => sum + (item.marketValue || 0), 0);
                const initialTotalPnL = initial.reduce((sum, item) => sum + (item.unrealizedPnL || 0), 0);
                const currentTotalPnL = current.reduce((sum, item) => sum + (item.unrealizedPnL || 0), 0);
                
                const valueChange = currentTotalValue - initialTotalValue;
                const valueChangePercent = initialTotalValue > 0 ? (valueChange / initialTotalValue) * 100 : 0;
                const pnlChange = currentTotalPnL - initialTotalPnL;
                const pnlChangePercent = initialTotalPnL !== 0 ? (pnlChange / Math.abs(initialTotalPnL)) * 100 : 0;
                
                // Count new and removed securities
                let newSecurities = 0;
                let removedSecurities = 0;
                
                current.forEach(item => {
                    if (!initialMap.has(item.security)) {
                        newSecurities++;
                    }
                });
                
                // Count removed securities (not in current portfolio OR sold completely)
                initial.forEach(item => {
                    if (!currentMap.has(item.security)) {
                        removedSecurities++;
                    } else {
                        // Check if sold completely (quantity <= 0)
                        const currentItem = currentMap.get(item.security);
                        if (currentItem && currentItem.quantity <= 0) {
                            removedSecurities++;
                        }
                    }
                });
                
                // Update comparison cards
                document.getElementById('valueChange').textContent = 'Rs. ' + formatNumber(valueChange);
                document.getElementById('valueChangePercent').textContent = formatNumber(valueChangePercent, 2) + '%';
                document.getElementById('pnlChange').textContent = 'Rs. ' + formatNumber(pnlChange);
                document.getElementById('pnlChangePercent').textContent = formatNumber(pnlChangePercent, 2) + '%';
                document.getElementById('newSecurities').textContent = newSecurities;
                document.getElementById('removedSecurities').textContent = removedSecurities;
                
                // Update colors based on changes
                const valueChangeElement = document.getElementById('valueChange');
                const valueChangePercentElement = document.getElementById('valueChangePercent');
                const pnlChangeElement = document.getElementById('pnlChange');
                const pnlChangePercentElement = document.getElementById('pnlChangePercent');
                
                valueChangeElement.className = valueChange >= 0 ? 'text-2xl font-bold text-blue-900' : 'text-2xl font-bold text-red-900';
                valueChangePercentElement.className = valueChange >= 0 ? 'text-sm text-blue-600' : 'text-sm text-red-600';
                pnlChangeElement.className = pnlChange >= 0 ? 'text-2xl font-bold text-green-900' : 'text-2xl font-bold text-red-900';
                pnlChangePercentElement.className = pnlChange >= 0 ? 'text-sm text-green-600' : 'text-sm text-red-600';
                
                // Populate comparison table
                populateComparisonTable(initial, current);
                
            } catch (error) {
            }
        }

        // Populate comparison table
        function populateComparisonTable(initial, current) {
            try {
                const tableBody = document.getElementById('comparisonTableBody');
                if (!tableBody) return;
                
                // Clear existing content
                tableBody.innerHTML = '';
                
                // Create maps for easy lookup
                const initialMap = new Map();
                const currentMap = new Map();
                
                initial.forEach(item => initialMap.set(item.security, item));
                current.forEach(item => currentMap.set(item.security, item));
                
                // Get all unique securities
                const allSecurities = new Set([...initial.map(item => item.security), ...current.map(item => item.security)]);
                const comparisonData = [];
                
                allSecurities.forEach(security => {
                    const initialItem = initialMap.get(security);
                    const currentItem = currentMap.get(security);
                    
                    let status = 'Unchanged';
                    let quantityChange = 0;
                    let marketValueChange = 0;
                    let pnlChange = 0;
                    let returnChange = 0;
                    let sector = 'Unknown';
                    
                    if (initialItem && currentItem) {
                        // Security exists in both portfolios
                        quantityChange = (currentItem.quantity || 0) - (initialItem.quantity || 0);
                        marketValueChange = (currentItem.marketValue || 0) - (initialItem.marketValue || 0);
                        pnlChange = (currentItem.unrealizedPnL || 0) - (initialItem.unrealizedPnL || 0);
                        returnChange = (currentItem.returnPercent || 0) - (initialItem.returnPercent || 0);
                        sector = currentItem.sector || 'Unknown';
                        
                        // Determine if this should be marked as removed (sold completely)
                        if (currentItem.quantity <= 0) {
                            status = 'Removed';
                        } else if (quantityChange !== 0 || marketValueChange !== 0 || pnlChange !== 0) {
                            status = 'Modified';
                        } else {
                            status = 'Unchanged';
                        }
                    } else if (currentItem) {
                        // New security
                        status = 'Added';
                        quantityChange = currentItem.quantity || 0;
                        marketValueChange = currentItem.marketValue || 0;
                        pnlChange = currentItem.unrealizedPnL || 0;
                        returnChange = currentItem.returnPercent || 0;
                        sector = currentItem.sector || 'Unknown';
                    } else if (initialItem) {
                        // Removed security (not in current portfolio)
                        status = 'Removed';
                        quantityChange = -(initialItem.quantity || 0);
                        marketValueChange = -(initialItem.marketValue || 0);
                        pnlChange = -(initialItem.unrealizedPnL || 0);
                        returnChange = -(initialItem.returnPercent || 0);
                        sector = initialItem.sector || 'Unknown';
                    }
                    
                    comparisonData.push({
                        security,
                        status,
                        quantityChange,
                        marketValueChange,
                        pnlChange,
                        returnChange,
                        sector
                    });
                });
                
                // Sort by absolute market value change
                comparisonData.sort((a, b) => Math.abs(b.marketValueChange) - Math.abs(a.marketValueChange));
                
                // Create table rows
                comparisonData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Determine status color
                    let statusColor = 'text-gray-600';
                    if (item.status === 'Added') statusColor = 'text-green-600';
                    else if (item.status === 'Removed') statusColor = 'text-red-600';
                    else if (item.status === 'Modified') statusColor = 'text-blue-600';
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 font-medium">${item.security}</td>
                        <td class="px-4 py-2 text-center ${statusColor} font-semibold">${item.status}</td>
                        <td class="px-4 py-2 text-right ${item.quantityChange >= 0 ? 'text-green-600' : 'text-red-600'}" data-order="${item.quantityChange}">
                            ${item.quantityChange >= 0 ? '+' : ''}${item.quantityChange.toLocaleString('en-US')}
                        </td>
                        <td class="px-4 py-2 text-right ${item.marketValueChange >= 0 ? 'text-green-600' : 'text-red-600'}" data-order="${item.marketValueChange}">
                            ${item.marketValueChange >= 0 ? '+' : ''}Rs. ${formatNumber(item.marketValueChange)}
                        </td>
                        <td class="px-4 py-2 text-right ${item.pnlChange >= 0 ? 'text-green-600' : 'text-red-600'}" data-order="${item.pnlChange}">
                            ${item.pnlChange >= 0 ? '+' : ''}Rs. ${formatNumber(item.pnlChange)}
                        </td>
                        <td class="px-4 py-2 text-right ${item.returnChange >= 0 ? 'text-green-600' : 'text-red-600'}" data-order="${item.returnChange}">
                            ${item.returnChange >= 0 ? '+' : ''}${formatNumber(item.returnChange, 2)}%
                        </td>
                        <td class="px-4 py-2 text-center">${item.sector}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Initialize DataTable
                const comparisonTable = document.getElementById('comparisonDataTable');
                if (comparisonTable) {
                    if ($.fn.DataTable.isDataTable('#comparisonDataTable')) {
                        $('#comparisonDataTable').DataTable().destroy();
                    }
                    
                    $('#comparisonDataTable').DataTable({
                    pageLength: 100,
                    lengthMenu: [[25, 50, 100, 200, -1], [25, 50, 100, 200, "All"]],
                    order: [[3, 'desc']], // Sort by market value change by default
                    responsive: true,
                    processing: false,
                    searching: true,
                    ordering: true,
                    info: true,
                    paging: true,
                    columnDefs: [
                        { type: 'num', targets: [2, 3, 4, 5] }, // Quantity Change, Market Value Change, P&L Change, Return % Change
                        { type: 'num-fmt', targets: [2, 3, 4] } // Format numbers with commas
                    ]
                });
                }
                
            } catch (error) {
            }
        }

        // Calculate summary statistics
        function calculateSummary() {
            const totalValue = portfolioData.reduce((sum, item) => sum + (item.marketValue || 0), 0);
            const totalCost = portfolioData.reduce((sum, item) => sum + (item.totalCost || 0), 0);
            const totalPnL = totalValue - totalCost;
            const totalReturn = totalCost > 0 ? (totalPnL / totalCost) * 100 : 0;

            document.getElementById('totalMarketValue').textContent = 'Rs. ' + formatNumber(totalValue);
            document.getElementById('totalCost').textContent = 'Rs. ' + formatNumber(totalCost);
            document.getElementById('totalPnL').textContent = 'Rs. ' + formatNumber(totalPnL);
            document.getElementById('totalReturn').textContent = formatNumber(totalReturn, 2) + '%';

            // Update colors based on P&L
            const pnlElement = document.getElementById('totalPnL');
            const returnElement = document.getElementById('totalReturn');
            
            pnlElement.className = totalPnL >= 0 ? 'text-2xl font-bold text-success' : 'text-2xl font-bold text-danger';
            returnElement.className = totalReturn >= 0 ? 'text-2xl font-bold text-success' : 'text-2xl font-bold text-danger';
        }

        // Create allocation chart
        function createAllocationChart(dataToUse = portfolioData) {
            try {
                const canvas = document.getElementById('allocationChart');
                if (!canvas) {
                    return;
                }
                
                // Check if there's already a chart on this canvas and destroy it
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    return;
                }
                
                // Sort by market value
                const sortedData = [...dataToUse].sort((a, b) => (b.marketValue || 0) - (a.marketValue || 0));
                const top10 = sortedData.slice(0, 10);
                
                window.allocationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: top10.map(item => item.security),
                        datasets: [{
                            data: top10.map(item => item.marketValue || 0),
                            backgroundColor: [
                                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const percentage = formatNumber((value / dataToUse.reduce((sum, item) => sum + (item.marketValue || 0), 0)) * 100, 1);
                                                return {
                                                    text: `${label}: ${percentage}%`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    strokeStyle: data.datasets[0].backgroundColor[i],
                                                    pointStyle: 'circle',
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
            }
        }

        // Create performance chart
        function createPerformanceChart(dataToUse = portfolioData) {
            try {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) {
                    return;
                }
                
                // Check if there's already a chart on this canvas and destroy it
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    return;
                }
                
                // Sort by absolute P&L
                const sortedData = [...portfolioData].sort((a, b) => Math.abs(b.unrealizedPnL || 0) - Math.abs(a.unrealizedPnL || 0));
                const top15 = sortedData.slice(0, 15);
                
                window.performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top15.map(item => item.security),
                        datasets: [{
                            label: 'Unrealized P&L (Rs.)',
                            data: top15.map(item => item.unrealizedPnL || 0),
                            backgroundColor: top15.map(item => (item.unrealizedPnL || 0) >= 0 ? '#10B981' : '#EF4444')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Rs. ' + formatInteger(value / 1000) + 'K';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = top15[context.dataIndex];
                                        return [
                                            `P&L: Rs. ${formatNumber(item.unrealizedPnL || 0)}`,
                                            `Return: ${formatNumber(item.returnPercent || 0, 2)}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
            }
        }

        // Create sector chart
        function createSectorChart(dataToUse = portfolioData) {
            try {
                const canvas = document.getElementById('sectorChart');
                if (!canvas) {
                    return;
                }
                
                // Check if there's already a chart on this canvas and destroy it
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    return;
                }
                
                // Group by sector and sum market values, filtering out "Unknown" sectors
                const sectorData = {};
                dataToUse.forEach(item => {
                    const sector = item.sector;
                    if (sector && sector !== 'Unknown') {
                        if (!sectorData[sector]) {
                            sectorData[sector] = 0;
                        }
                        sectorData[sector] += (item.marketValue || 0);
                    }
                });
                
                // Only create chart if we have valid sector data
                if (Object.keys(sectorData).length === 0) {
                    return;
                }
                
                // Sort sectors by market value
                const sortedSectors = Object.entries(sectorData)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8); // Top 8 sectors
                
                const labels = sortedSectors.map(([sector]) => sector);
                const data = sortedSectors.map(([, value]) => value);
                
                window.sectorChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                                '#06B6D4', '#84CC16', '#F97316'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const percentage = formatNumber((value / dataToUse.reduce((sum, item) => sum + (item.marketValue || 0), 0)) * 100, 1);
                                                return {
                                                    text: `${label}: ${percentage}%`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    strokeStyle: data.datasets[0].backgroundColor[i],
                                                    pointStyle: 'circle',
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
            }
        }

        // Create sector performance chart
        function createSectorPerformanceChart(dataToUse = portfolioData) {
            try {
                const canvas = document.getElementById('sectorPerformanceChart');
                if (!canvas) {
                    return;
                }
                
                // Check if there's already a chart on this canvas and destroy it
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    return;
                }
                
                // Group by sector and calculate total P&L, filtering out "Unknown" sectors
                const sectorData = {};
                dataToUse.forEach(item => {
                    const sector = item.sector;
                    if (sector && sector !== 'Unknown') {
                        if (!sectorData[sector]) {
                            sectorData[sector] = 0;
                        }
                        sectorData[sector] += (item.unrealizedPnL || 0);
                    }
                });
                
                // Only create chart if we have valid sector data
                if (Object.keys(sectorData).length === 0) {
                    return;
                }
                
                // Sort sectors by P&L value
                const sortedSectors = Object.entries(sectorData)
                    .sort(([,a], [,b]) => Math.abs(b) - Math.abs(a))
                    .slice(0, 10); // Top 10 sectors
                
                const labels = sortedSectors.map(([sector]) => sector);
                const data = sortedSectors.map(([, pnl]) => pnl);
                
                window.sectorPerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sector P&L',
                            data: data,
                            backgroundColor: data.map(value => value >= 0 ? '#10B981' : '#EF4444'),
                            borderColor: data.map(value => value >= 0 ? '#059669' : '#DC2626'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                          
                            legend: {
                                display: false
                            },
                            datalabels: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Rs. ' + formatInteger(value / 1000) + 'K';
                                    }
                                }
                            }
                        },
                        tooltips: {
                            callbacks: {
                                label: function(context) {
                                    return 'P&L: Rs. ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    }
                });
            } catch (error) {
            }
        }

        // Populate trading journal
        function populateTradingJournal() {
            try {
                if (!portfolioData || portfolioData.length === 0) {
                    return;
                }
                
                const tableBody = document.getElementById('tradingJournalTableBody');
                if (!tableBody) {
                    return;
                }
                
                // Clear existing content
                tableBody.innerHTML = '';
                
                // Create trading journal entries from portfolio data
                portfolioData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    
                    // Calculate values
                    const quantity = item.quantity || 0;
                    const avgPrice = item.avgPrice || 0;
                    const marketValue = item.marketValue || 0;
                    const totalCost = item.totalCost || 0;
                    const unrealizedPnL = item.unrealizedPnL || 0;
                    const returnPercent = item.returnPercent || 0;
                    const lastPrice = quantity > 0 ? marketValue / quantity : 0;
                    
                    // Calculate stop loss (assume 5% below average price)
                    const stopLoss = avgPrice * 0.95;
                    
                    // Calculate take profit (assume 10% above average price)
                    const takeProfit = avgPrice * 1.10;
                    
                    // For now, assume all positions are still open (no sold date)
                    const soldDate = '-';
                    const duration = '-';
                    const soldPrice = '-';
                    const sellOrderValue = '-';
                    
                    // Format PnL with proper color
                    const pnlColor = unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600';
                    const pnlPercentColor = returnPercent >= 0 ? 'text-green-600' : 'text-red-600';
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 text-center text-xs border-r whitespace-nowrap">${new Date().toLocaleDateString()}</td>
                        <td class="px-4 py-2 text-left text-xs font-medium border-r">${item.security}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">${quantity.toLocaleString()}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">Rs. ${formatNumber(avgPrice, 2)}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">Rs. ${formatNumber(stopLoss, 2)}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">Rs. ${formatNumber(takeProfit, 2)}</td>
                        <td class="px-4 py-2 text-center text-xs border-r"></td>
                        <td class="px-4 py-2 text-center text-xs border-r">${soldDate}</td>
                        <td class="px-4 py-2 text-center text-xs border-r">${duration}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">${soldPrice}</td>
                        <td class="px-4 py-2 text-right text-xs border-r">${sellOrderValue}</td>
                        <td class="px-4 py-2 text-right text-xs border-r ${pnlColor}">${unrealizedPnL >= 0 ? '+' : ''}${formatNumber(unrealizedPnL)}</td>
                        <td class="px-4 py-2 text-right text-xs border-r ${pnlPercentColor}">${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                
            } catch (error) {
            }
        }

        // Populate portfolio table
        function populateTable() {
            try {
                if (!portfolioData || portfolioData.length === 0) {
                    return;
                }
                
                // Filter out stocks with 0 quantity
                const validData = portfolioData.filter(item => (item.quantity || 0) > 0);
                
                if (validData.length === 0) {
                    return;
                }
                
                const tableBody = document.getElementById('portfolioTableBody');
                if (!tableBody) {
                    return;
                }
                
                // Clear existing table content
                tableBody.innerHTML = '';
                
                // Calculate rank and portfolio percentage
                const sortedData = [...validData].sort((a, b) => (b.marketValue || 0) - (a.marketValue || 0));
                const totalValue = validData.reduce((sum, item) => sum + (item.marketValue || 0), 0);
                
                // Create table rows
                sortedData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    const portfolioPercentage = totalValue > 0 ? (item.marketValue / totalValue) * 100 : 0;
                    const rank = index + 1;
                    
                    // Ensure all numeric values are valid numbers
                    const quantity = item.quantity || 0;
                    const avgPrice = item.avgPrice || 0;
                    const totalCost = item.totalCost || 0;
                    const marketValue = item.marketValue || 0;
                    const unrealizedPnL = item.unrealizedPnL || 0;
                    const returnPercent = item.returnPercent || 0;
                    
                    // Calculate last price (current price)
                    const lastPrice = quantity > 0 ? marketValue / quantity : 0;
                    
                    row.innerHTML = `
                        <td class="px-3 py-2 text-center" data-order="${rank}">
                            <div class="text-xs font-medium text-gray-700">${rank}</div>
                        </td>
                        <td class="px-3 py-2 text-left" data-order="${item.security}">
                            <div class="flex flex-col">
                                <div class="text-sm font-bold text-gray-900">${item.security}</div>
                                <div class="text-xs text-gray-600">Rs. ${formatNumber(avgPrice, 2)}</div>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-right" data-order="${quantity}">
                            <div class="text-sm font-bold text-gray-900">${formatInteger(quantity)}</div>
                        </td>
                        <td class="px-3 py-2 text-right" data-order="${marketValue}">
                            <div class="flex flex-col">
                                <div class="text-sm font-bold text-gray-900">Rs. ${formatNumber(marketValue)}</div>
                                <div class="text-xs text-gray-600">Rs. ${formatNumber(lastPrice, 2)}</div>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-right" data-order="${unrealizedPnL}">
                            <div class="flex flex-col">
                                <div class="text-sm font-bold ${unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600'}">Rs. ${formatNumber(unrealizedPnL)}</div>
                                <div class="text-xs ${returnPercent >= 0 ? 'text-green-600' : 'text-red-600'}">${formatNumber(returnPercent, 2)}%</div>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center" data-order="${item.sector || 'Unknown'}">
                            <div class="text-xs text-gray-700">${item.sector || 'Unknown'}</div>
                        </td>
                        <td class="px-3 py-2 text-center" data-order="${portfolioPercentage}">
                            <div class="text-xs font-medium text-gray-700">${formatNumber(portfolioPercentage, 2)}%</div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Destroy existing DataTable if it exists
                const portfolioTable = document.getElementById('portfolioTable');
                if (portfolioTable) {
                    if ($.fn.DataTable.isDataTable('#portfolioTable')) {
                        $('#portfolioTable').DataTable().destroy();
                    }
                    
                    // Initialize new DataTable
                    $('#portfolioTable').DataTable({
                    pageLength: 100,
                    lengthMenu: [[25, 50, 100, 200, -1], [25, 50, 100, 200, "All"]],
                    order: [[0, 'asc']],
                    responsive: true,
                    processing: false,
                    searching: true,
                    ordering: true,
                    info: true,
                    paging: true,
                    scrollX: true,
                    scrollCollapse: true,
                    fixedColumns: {
                        leftColumns: 1
                    },
                    columnDefs: [
                        { type: 'num', targets: [0, 2, 3, 5] }, // Rank, Market Value, Gain/Loss, Portfolio %
                        { type: 'string', targets: [1, 4] }, // Symbol, Sector
                        { orderable: true, targets: '_all' }, // Enable sorting for all columns
                        { className: 'text-center', targets: [0, 4, 5] }, // Center align Rank, Sector, Portfolio %
                        { className: 'text-right', targets: [2, 3] }, // Right align Market Value, Gain/Loss
                        { className: 'text-left', targets: [1] } // Left align Symbol
                    ],
                    initComplete: function() {
                        // Force alignment after table is initialized
                        $('#portfolioTable th, #portfolioTable td').each(function() {
                            if ($(this).hasClass('text-center')) {
                                $(this).css('text-align', 'center');
                            } else if ($(this).hasClass('text-right')) {
                                $(this).css('text-align', 'right');
                            } else if ($(this).hasClass('text-left')) {
                                $(this).css('text-align', 'left');
                            }
                        });
                    }
                });
                }
                
            } catch (error) {
            }
        }

        // Initialize dashboard
        function initDashboard() {
            try {
                // Check if dashboard is visible
                const dashboardContent = document.getElementById('dashboardContent');
                if (!dashboardContent || dashboardContent.classList.contains('hidden')) {
                    return;
                }
                
                calculateSummary();
                createAllocationChart();
                createPerformanceChart();
                createSectorChart();
                createSectorPerformanceChart();
                populateTable();
            } catch (error) {
            }
        }

        // Default sector mapping for known securities
        const defaultSectorMapping = {
            // Automobiles
            'TYRE.N0000': 'Automobiles',
            
            // Banks
            'SDB.N0000': 'Banks',
            'COMB.N0000': 'Banks',
            'PABC.N0000': 'Banks',
            'HNB.N0000': 'Banks',
            'HNB.X0000': 'Banks',
            'DFCC.N0000': 'Banks',
            'NTB.N0000': 'Banks',
            'NDB.N0000': 'Banks',
            'COMB.X0000': 'Banks',
            'SAMP.N0000': 'Banks',
            'HDFC.N0000': 'Banks',
            'SEYB.X0000': 'Banks',
            'UBC.N0000': 'Banks',
            'ABL.N0000': 'Banks',
            'SEYB.N0000': 'Banks',
            'CBNK.N0000': 'Banks',
            'NTB.X0000': 'Banks',
            'SEYB.R0001': 'Banks',
            'SEYB.R0000': 'Banks',
            'SDB.R0000': 'Banks',
            'SAMP.R0000': 'Banks',
            'PABC.R0000': 'Banks',
            'NTB.R0001': 'Banks',
            'NTB.R0000': 'Banks',
            'NDB.R0000': 'Banks',
            'HNB.R0001': 'Banks',
            'HNB.R0000': 'Banks',
            'DFCC.S0000': 'Banks',
            'DFCC.R0000': 'Banks',
            'COMB.R0001': 'Banks',
            'COMB.R0000': 'Banks',
            'ABL.R0000': 'Banks',
            
            // Basic Materials
            'UCAR.N0000': 'Basic Materials',
            'TKYO.X0000': 'Basic Materials',
            'TKYO.R0000': 'Basic Materials',
            'TKYO.N0000': 'Basic Materials', 
            'SIL.R0000': 'Basic Materials',
            'SIL.N0000': 'Basic Materials',
            'REXP.N0000': 'Basic Materials',
            'PARQ.R0000': 'Basic Materials',
            'PARQ.N0000': 'Basic Materials',
            'PACK.N0000': 'Basic Materials',
            'LLUB.N0000': 'Basic Materials',
            'LALU.N0000': 'Basic Materials',
            'JAT.N0000': 'Basic Materials',
            'HAYC.N0000': 'Basic Materials',
            'GLAS.R0000': 'Basic Materials',
            'GLAS.N0000': 'Basic Materials',
            'DIPD.R0000': 'Basic Materials',
            'DIPD.N0000': 'Basic Materials',
            'CIC.X0000': 'Basic Materials',
            'CIC.R0001': 'Basic Materials',
            'CIC.R0000': 'Basic Materials',
            'CIC.N0000': 'Basic Materials',
            'CHMX.R0000': 'Basic Materials',
            'CHMX.N0000': 'Basic Materials',
            'BOGA.N0000': 'Basic Materials',
            'ASPH.R0000': 'Basic Materials',
            'ASPH.N0000': 'Basic Materials',
            'APLA.N0000': 'Basic Materials',
            'ALUM.N0000': 'Basic Materials',
            'AGST.X0000': 'Basic Materials',
            'AGST.R0001': 'Basic Materials',
            'AGST.R0000': 'Basic Materials',
            'AGST.N0000': 'Basic Materials',
            'ACME.R0000': 'Basic Materials',
            'ACME.N0000': 'Basic Materials',
            'RCL.N0000': 'Basic Materials',
            
            // Capital Goods
            'ASHO.N0000': 'Capital Goods',
            'BRWN.N0000': 'Capital Goods',
            'LITE.N0000': 'Capital Goods',
            'HHL.N0000': 'Capital Goods',
            'MEL.N0000': 'Capital Goods',
            'CSLK.N0000': 'Capital Goods',
            'SPEN.N0000': 'Capital Goods',
            'LWL.N0000': 'Capital Goods',
            'SIRA.N0000': 'Capital Goods',
            'TILE.N0000': 'Capital Goods',
            'RHL.N0000': 'Capital Goods',
            'JKH.N0000': 'Capital Goods',
            'HAYL.N0000': 'Capital Goods',
            'AEL.N0000': 'Capital Goods',
            'KCAB.N0000': 'Capital Goods',
            'DOCK.N0000': 'Capital Goods',
            'VONE.N0000': 'Capital Goods',
            'SHL.N0000': 'Capital Goods',
            'EBCR.N0000': 'Capital Goods',
            'CFLB.N0000': 'Capital Goods',
            'ACL.N0000': 'Capital Goods',
            'AFS.N0000': 'Capital Goods',
            'RHL.X0000': 'Capital Goods',
            'RICH.N0000': 'Capital Goods',
            'CIND.N0000': 'Capital Goods',
            'CERA.N0000': 'Capital Goods',
            'LCEY.N0000': 'Capital Goods',
            'LUMX.N0000': 'Capital Goods',
            'SHL.W0000': 'Capital Goods',
            'AFS.R0000': 'Capital Goods',
            'TILE.R0000': 'Capital Goods',
            'SPEN.R0000': 'Capital Goods',
            
            // Commercial Services
            'EXT.N0000': 'Commercial Services',
            'CARE.N0000': 'Commercial Services',
            'PARA.N0000': 'Commercial Services',
            'EML.N0000': 'Commercial Services',
            'GEST.N0000': 'Commercial Services',
            'CPRT.N0000': 'Commercial Services',
            'LPRT.R0000': 'Commercial Services',
            'LPRT.N0000': 'Commercial Services',
            'GEST.R0000': 'Commercial Services',
            'CPRT.R0000': 'Commercial Services',
            
            // Consumer Durables
            'TJL.N0000': 'Consumer Durables',
            'TAP.N0000': 'Consumer Durables',
            'RGEM.N0000': 'Consumer Durables',
            'DPL.N0000': 'Consumer Durables',
            'ABAN.N0000': 'Consumer Durables',
            'HEXP.N0000': 'Consumer Durables',
            'MGT.N0000': 'Consumer Durables',
            'HELA.N0000': 'Consumer Durables',
            'GREG.N0000': 'Consumer Durables',
            'HELA.R0000': 'Consumer Durables',
            'TAP.R0000': 'Consumer Durables',
            'RGEM.R0000': 'Consumer Durables',
            'MGT.R0000': 'Consumer Durables',
            'KDL.R0000': 'Consumer Durables',
            'KDL.N0000': 'Consumer Durables',
            'GREG.W0006': 'Consumer Durables',
            'GREG.W0003': 'Consumer Durables',
            'GREG.R0000': 'Consumer Durables',
            'GREG.P0002': 'Consumer Durables',
            'DPL.R0000': 'Consumer Durables',
            'BLUE.X0000': 'Consumer Durables',
            'BLUE.R0001': 'Consumer Durables',
            'BLUE.R0000': 'Consumer Durables',
            'BLUE.N0000': 'Consumer Durables',
            'ABAN.R0000': 'Consumer Durables',
            
            // Consumer Services
            'KHC.N0000': 'Consumer Services',
            'JETS.N0000': 'Consumer Services',
            'CHOT.N0000': 'Consumer Services',
            'MARA.N0000': 'Consumer Services',
            'RCH.N0000': 'Consumer Services',
            'TANG.N0000': 'Consumer Services',
            'AHPL.N0000': 'Consumer Services',
            'TRAN.N0000': 'Consumer Services',
            'TAJ.N0000': 'Consumer Services',
            'GHLL.N0000': 'Consumer Services',
            'RPBH.N0000': 'Consumer Services',
            'LHL.N0000': 'Consumer Services',
            'CITW.N0000': 'Consumer Services',
            'STAF.N0000': 'Consumer Services',
            'CITH.N0000': 'Consumer Services',
            'KHL.N0000': 'Consumer Services',
            'HUNA.N0000': 'Consumer Services',
            'EDEN.N0000': 'Consumer Services',
            'SERV.N0000': 'Consumer Services',
            'RHTL.N0000': 'Consumer Services',
            'BERU.N0000': 'Consumer Services',
            'AHUN.N0000': 'Consumer Services',
            'BBH.N0000': 'Consumer Services',
            'BRR.N0000': 'Consumer Services',
            'REEF.N0000': 'Consumer Services',
            'CONN.N0000': 'Consumer Services',
            'MRH.N0000': 'Consumer Services',
            'SHOT.X0000': 'Consumer Services',
            'SIGV.N0000': 'Consumer Services',
            'PALM.N0000': 'Consumer Services',
            'SHOT.N0000': 'Consumer Services',
            'HSIG.N0000': 'Consumer Services',
            'PEG.N0000': 'Consumer Services',
            'RENU.N0000': 'Consumer Services',
            'NEH.N0000': 'Consumer Services',
            'RFL.N0000': 'Consumer Services',
            'BERU.R0000': 'Consumer Services',
            'JETS.R0000': 'Consumer Services',
            'TANG.R0000': 'Consumer Services',
            'STAF.R0000': 'Consumer Services',
            'SIGV.R0000': 'Consumer Services',
            'SHOT.R0001': 'Consumer Services',
            'SHOT.R0000': 'Consumer Services',
            'SERV.R0000': 'Consumer Services',
            'RPBH.R0000': 'Consumer Services',
            'RHTL.R0000': 'Consumer Services',
            'RENU.R0000': 'Consumer Services',
            'REEF.W0018': 'Consumer Services',
            'REEF.W0019': 'Consumer Services',
            'REEF.R0000': 'Consumer Services',
            'REEF.W0017': 'Consumer Services',
            'PEG.R0000': 'Consumer Services',
            'PALM.R0000': 'Consumer Services',
            'NEH.R0000': 'Consumer Services',
            'MRH.R0000': 'Consumer Services',
            'MARA.R0000': 'Consumer Services',
            'KHL.R0000': 'Consumer Services',
            'KHC.P0002': 'Consumer Services',
            'HUNA.R0000': 'Consumer Services',
            'HSIG.R0000': 'Consumer Services',
            'EDEN.R0000': 'Consumer Services',
            'CONN.R0000': 'Consumer Services',
            'CITW.R0000': 'Consumer Services',
            'CITH.R0000': 'Consumer Services',
            'CHOT.R0000': 'Consumer Services',
            'BBH.R0000': 'Consumer Services',
            'ALHP.R0000': 'Consumer Services',
            'ALHP.N0000': 'Consumer Services',
            'AHUN.R0000': 'Consumer Services',
            
            // Diversified Finance
            'LOLC.R0000': 'Diversified Finance',
            'LOLC.N0000': 'Diversified Finance',
            'LOFC.R0000': 'Diversified Finance',
            'LOFC.N0000': 'Diversified Finance',
            'LFIN.R0000': 'Diversified Finance',
            'LFIN.N0000': 'Diversified Finance',
            'LCBF.N0000': 'Diversified Finance',
            'KZOO.R0000': 'Diversified Finance',
            'KZOO.N0000': 'Diversified Finance',
            'HNBF.X0000': 'Diversified Finance',
            'HNBF.R0001': 'Diversified Finance',
            'HNBF.R0000': 'Diversified Finance',
            'HNBF.N0000': 'Diversified Finance',
            'GUAR.R0000': 'Diversified Finance',
            'GUAR.N0000': 'Diversified Finance',
            'FCT.N0000': 'Diversified Finance',
            'CSF.W0021': 'Diversified Finance',
            'CSF.R0000': 'Diversified Finance',
            'CSF.N0000': 'Diversified Finance',
            'CRL.R0000': 'Diversified Finance',
            'CRL.N0000': 'Diversified Finance',
            'COCR.N0000': 'Diversified Finance',
            'CIT.R0000': 'Diversified Finance',
            'CIT.N0000': 'Diversified Finance',
            'CIT.B0000': 'Diversified Finance',
            'CINV.R0000': 'Diversified Finance',
            'CINV.N0000': 'Diversified Finance',
            'CFVF.R0000': 'Diversified Finance',
            'CFVF.N0000': 'Diversified Finance',
            'CFIN.N0000': 'Diversified Finance',
            'CFI.R0000': 'Diversified Finance',
            'CFI.N0000': 'Diversified Finance',
            'CFI.B0000': 'Diversified Finance',
            'CDB.X0000': 'Diversified Finance',
            'CDB.R0001': 'Diversified Finance',
            'CDB.R0000': 'Diversified Finance',
            'CDB.N0000': 'Diversified Finance',
            'CALT.N0000': 'Diversified Finance',
            'CALH.N0000': 'Diversified Finance',
            'CALF.R0000': 'Diversified Finance',
            'CALF.N0000': 'Diversified Finance',
            'CALC.U0000': 'Diversified Finance',
            'BLI.R0000': 'Diversified Finance',
            'BLI.N0000': 'Diversified Finance',
            'BFN.R0000': 'Diversified Finance',
            'BFN.N0000': 'Diversified Finance',
            'ASIY.N0000': 'Diversified Finance',
            'AMF.R0000': 'Diversified Finance',
            'AMF.N0000': 'Diversified Finance',
            'AMCL.N0000': 'Diversified Finance',
            'ALLI.R0000': 'Diversified Finance',
            'ALLI.N0000': 'Diversified Finance',
            'AFSL.R0000': 'Diversified Finance',
            'AFSL.N0000': 'Diversified Finance',
            'ACAP.N0000': 'Diversified Finance',
            'AAF.R0001': 'Diversified Finance',
            'AAF.R0000': 'Diversified Finance',
            'AAF.P0000': 'Diversified Finance',
            'AAF.N0000': 'Diversified Finance',
            'SEMB.N0000': 'Diversified Finance',
            'UBF.N0000': 'Diversified Finance',
            'MBSL.N0000': 'Diversified Finance',
            'SFCL.N0000': 'Diversified Finance',
            'WAPO.N0000': 'Diversified Finance',
            'LVEN.R0000': 'Diversified Finance',
            'VFIN.R0000': 'Diversified Finance',
            'VFIN.N0000': 'Diversified Finance',
            'SFIN.R0000': 'Diversified Finance',
            'SEMB.W0016': 'Diversified Finance',
            'SEMB.W0015': 'Diversified Finance',
            'SEMB.R0001': 'Diversified Finance',
            'SEMB.R0000': 'Diversified Finance',
            'PMB.R0000': 'Diversified Finance',
            'MERC.N0000': 'Diversified Finance',
            'MBSL.R0000': 'Diversified Finance',
            'CFI.N0000': 'Diversified Finance',
            
            // Energy
            'LIOC.N0000': 'Energy',
            'LGL.N0000': 'Energy',
            'LGL.X0000': 'Energy',
            
            // Food & Beverage
            'LMF.N0000': 'Food & Beverage',
            'WATA.N0000': 'Food & Beverage',
            'TAFL.N0000': 'Food & Beverage',
            'BIL.N0000': 'Food & Beverage',
            'BUKI.N0000': 'Food & Beverage',
            'HVA.N0000': 'Food & Beverage',
            'DIST.N0000': 'Food & Beverage',
            'BFL.N0000': 'Food & Beverage',
            'TSML.N0000': 'Food & Beverage',
            'KOTA.N0000': 'Food & Beverage',
            'SUN.N0000': 'Food & Beverage',
            'MCPL.N0000': 'Food & Beverage',
            'UDPL.N0000': 'Food & Beverage',
            'ELPL.N0000': 'Food & Beverage',
            'LDEV.N0000': 'Food & Beverage',
            'RWSL.N0000': 'Food & Beverage',
            'AGPL.N0000': 'Food & Beverage',
            'HPL.N0000': 'Food & Beverage',
            'CARS.N0000': 'Food & Beverage',
            'HOPL.N0000': 'Food & Beverage',
            'TPL.N0000': 'Food & Beverage',
            'BALA.N0000': 'Food & Beverage',
            'CCS.N0000': 'Food & Beverage',
            'MELS.N0000': 'Food & Beverage',
            'MADU.N0000': 'Food & Beverage',
            'COCO.N0000': 'Food & Beverage',
            'COCO.X0000': 'Food & Beverage',
            'GRAN.N0000': 'Food & Beverage',
            'KGAL.N0000': 'Food & Beverage',
            'MFPE.N0000': 'Food & Beverage',
            'LION.N0000': 'Food & Beverage',
            'CTC.N0000': 'Food & Beverage',
            'AGAL.N0000': 'Food & Beverage',
            'KVAL.N0000': 'Food & Beverage',
            'LAMB.N0000': 'Food & Beverage',
            'SOY.N0000': 'Food & Beverage',
            'MASK.N0000': 'Food & Beverage',
            'RAL.N0000': 'Food & Beverage',
            'MAL.N0000': 'Food & Beverage',
            'KAHA.N0000': 'Food & Beverage',
            'NAMU.N0000': 'Food & Beverage',
            'HAPU.N0000': 'Food & Beverage',
            'BREW.N0000': 'Food & Beverage',
            'CTEA.N0000': 'Food & Beverage',
            'BOPL.N0000': 'Food & Beverage',
            'KFP.N0000': 'Food & Beverage',
            'HARI.N0000': 'Food & Beverage',
            'BALA.R0000': 'Food & Beverage',
            'HVA.R0000': 'Food & Beverage',
            'UDPL.R0000': 'Food & Beverage',
            'SUN.R0000': 'Food & Beverage',
            'SOY.R0000': 'Food & Beverage',
            'RAL.R0000': 'Food & Beverage',
            'MASK.R0000': 'Food & Beverage',
            'MAL.X0000': 'Food & Beverage',
            'MADU.R0000': 'Food & Beverage',
            'LMF.R0000': 'Food & Beverage',
            'LION.R0000': 'Food & Beverage',
            'LDEV.R0000': 'Food & Beverage',
            'KOTA.R0000': 'Food & Beverage',
            'KFP.R0000': 'Food & Beverage',
            'KAHA.R0000': 'Food & Beverage',
            'HAPU.R0000': 'Food & Beverage',
            'GRAN.R0000': 'Food & Beverage',
            'ELPL.R0000': 'Food & Beverage',
            'COCO.R0001': 'Food & Beverage',
            'COCO.R0000': 'Food & Beverage',
            'CCS.R0000': 'Food & Beverage',
            'BREW.R0000': 'Food & Beverage',
            'BOPL.R0000': 'Food & Beverage',
            'BIL.R0000': 'Food & Beverage',
            'ASPM.N0000': 'Food & Beverage',
            'AGAL.R0000': 'Food & Beverage',
            
            // Food Retailing
            'CARG.N0000': 'Food Retailing',
            'TESS.N0000': 'Food Retailing',
            'TESS.X0000': 'Food Retailing',
            'CTHR.N0000': 'Food Retailing',
            'TESS.R0001': 'Food Retailing',
            'TESS.R0000': 'Food Retailing',
            'CTHR.R0000': 'Food Retailing',
            'CARG.R0000': 'Food Retailing',
            
            // Health Care Equipment
            'NHL.N0000': 'Health Care Equipment',
            'SINH.N0000': 'Health Care Equipment',
            'CHL.X0000': 'Health Care Equipment',
            'CHL.N0000': 'Health Care Equipment',
            'AMSL.N0000': 'Health Care Equipment',
            'ASIR.N0000': 'Health Care Equipment',
            'ECL.N0000': 'Health Care Equipment',
            'MULL.N0000': 'Health Care Equipment',
            'LHCL.N0000': 'Health Care Equipment',
            'NHL.R0000': 'Health Care Equipment',
            'MULL.R0000': 'Health Care Equipment',
            'LHCL.R0000': 'Health Care Equipment',
            'ECL.R0000': 'Health Care Equipment',
            'CHL.R0001': 'Health Care Equipment',
            'CHL.R0000': 'Health Care Equipment',
            'ASIR.R0000': 'Health Care Equipment',
            'AMSL.R0000': 'Health Care Equipment',
            
            // Household Products
            'BPPL.N0000': 'Household Products',
            'SWAD.R0000': 'Household Products',
            'SWAD.N0000': 'Household Products',
            'EXT.B0000': 'Household Products',
            
            // Insurance
            'JINS.N0000': 'Insurance',
            'AAIC.N0000': 'Insurance',
            'COOP.N0000': 'Insurance',
            'SCAP.N0000': 'Insurance',
            'ATL.N0000': 'Insurance',
            'CINS.X0000': 'Insurance',
            'PINS.N0000': 'Insurance',
            'UAL.N0000': 'Insurance',
            'HASU.N0000': 'Insurance',
            'CINS.N0000': 'Insurance',
            'LGIL.N0000': 'Insurance',
            'ATLL.N0000': 'Insurance',
            'AINS.N0000': 'Insurance',
            'UAL.R0000': 'Insurance',
            'SCAP.R0000': 'Insurance',
            'JINS.R0000': 'Insurance',
            'HASU.R0000': 'Insurance',
            'CINS.R0000': 'Insurance',
            'ATL.R0000': 'Insurance',
            'AAIC.R0000': 'Insurance',
            
            // Real Estate
            'EAST.N0000': 'Real Estate',
            'PLR.N0000': 'Real Estate',
            'OSEA.N0000': 'Real Estate',
            'ASCO.N0000': 'Real Estate',
            'CSD.N0000': 'Real Estate',
            'MHDL.N0000': 'Real Estate',
            'PHAR.N0000': 'Real Estate',
            'CLND.N0000': 'Real Estate',
            'COMD.N0000': 'Real Estate',
            'ONAL.N0000': 'Real Estate',
            'ETWO.N0000': 'Real Estate',
            'CABO.N0000': 'Real Estate',
            'SLND.N0000': 'Real Estate',
            'SHAW.N0000': 'Real Estate',
            'SING.N0000': 'Real Estate',
            'YORK.N0000': 'Real Estate',
            'CTLD.N0000': 'Real Estate',
            'MDL.N0000': 'Real Estate',
            'YORK.R0000': 'Real Estate',
            'SING.R0000': 'Real Estate',
            'PHAR.R0000': 'Real Estate',
            'OSEA.R0000': 'Real Estate',
            'ONAL.R0000': 'Real Estate',
            'ETWO.R0000': 'Real Estate',
            'EAST.R0000': 'Real Estate',
            'CTLD.R0000': 'Real Estate',
            'CSD.R0000': 'Real Estate',
            'CHOU.R0000': 'Real Estate',
            'CHOU.N0000': 'Real Estate',
            'CABO.R0000': 'Real Estate',
            'ASCO.W0024': 'Real Estate',
            'ASCO.R0000': 'Real Estate',
            
            // Retailing
            'UML.N0000': 'Retailing',
            'SMOT.R0000': 'Retailing',
            'SMOT.N0000': 'Retailing',
            'SINS.R0000': 'Retailing',
            'SINS.N0000': 'Retailing',
            'RIL.R0000': 'Retailing',
            'RIL.N0000': 'Retailing',
            'ODEL.R0000': 'Retailing',
            'ODEL.N0000': 'Retailing',
            'KPHL.N0000': 'Retailing',
            'JKL.N0000': 'Retailing',
            'HUNT.R0000': 'Retailing',
            'HUNT.N0000': 'Retailing',
            'EMER.N0000': 'Retailing',
            'DIMO.R0000': 'Retailing',
            'DIMO.N0000': 'Retailing',
            'CWM.R0000': 'Retailing',
            'CWM.N0000': 'Retailing',
            'CTBL.R0000': 'Retailing',
            'CTBL.N0000': 'Retailing',
            'COLO.R0000': 'Retailing',
            'COLO.N0000': 'Retailing',
            'AUTO.R0000': 'Retailing',
            'AUTO.N0000': 'Retailing',
            
            // Software & Services
            'HBS.N0000': 'Software & Services',
            
            // Telecommunication
            'SLTL.N0000': 'Telecommunication',
            'DIAL.N0000': 'Telecommunication',
            'DIAL.R0000': 'Telecommunication',
            
            // Transportation
            'PKME.N0000': 'Transportation',
            'CWL.N0000': 'Transportation',
            'MSL.N0000': 'Transportation',
            'MSL.R0000': 'Transportation',
            
            // Utilities
            'LVEF.N0000': 'Utilities',
            'PAP.N0000': 'Utilities',
            'VLL.N0000': 'Utilities',
            'VPEL.N0000': 'Utilities',
            'WIND.N0000': 'Utilities',
            'VLL.X0000': 'Utilities',
            'HPWR.N0000': 'Utilities',
            'LPL.N0000': 'Utilities',
            'LPL.X0000': 'Utilities',
            'HPFL.N0000': 'Utilities',
            'LVEF.R0000': 'Utilities',
            'VLL.R0001': 'Utilities',
            'VLL.R0000': 'Utilities'
        };

        // Diversification chart function removed - now handled in separate pages
        function createDiversificationChart(portfolioData) {
            // Function disabled - chart now handled in separate pages
            return;
            try {
                const chartContainer = document.getElementById('diversificationChart');
                if (!chartContainer) {
                    return;
                }
                
                // Clear existing chart
                chartContainer.innerHTML = '';
                
                if (!portfolioData || portfolioData.length === 0) {
                    chartContainer.innerHTML = '<p class="text-gray-500 text-center">No portfolio data available</p>';
                    return;
                }
                
                // Group data by sector and then by security
                const sectorData = {};
                
                // Define valid sectors to prevent individual securities from being treated as sectors
                const validSectors = new Set([
                    'Basic Materials', 'Food & Beverage', 'Energy', 'Capital Goods', 'Banks',
                    'Insurance', 'Retailing', 'Consumer Services', 'Consumer Durables', 
                    'Real Estate', 'Utilities', 'Automobiles', 'Diversified Finance',
                    'Commercial Services', 'Transportation', 'Food Retailing', 'Household Products',
                    'Health Care Equipment', 'Software & Services', 'Telecommunication'
                ]);
                
                portfolioData.forEach(item => {
                    let sector = item.sector || 'Unknown';
                    
                    // Ensure the sector is actually a valid sector, not a security name
                    if (!validSectors.has(sector)) {
                        sector = 'Unknown';
                    }
                    
                    // Ensure the security name is not the same as a sector name
                    if (validSectors.has(item.security)) {
                        return;
                    }
                    
                    // Initialize sector array if it doesn't exist
                    if (!sectorData[sector]) {
                        sectorData[sector] = [];
                    }
                    
                    // Ensure we're always working with an array
                    if (!Array.isArray(sectorData[sector])) {
                        sectorData[sector] = [];
                    }
                    
                    sectorData[sector].push({
                        security: item.security,
                        marketValue: item.marketValue || 0,
                        percentage: 0 // Will calculate this
                    });
                });
                
                // Final validation: ensure all sectors have arrays
                Object.keys(sectorData).forEach(sector => {
                    if (!Array.isArray(sectorData[sector])) {
                        sectorData[sector] = [];
                    }
                });
                
                // Process each sector's data
                Object.entries(sectorData).forEach(([sectorName, securities]) => {
                    // Special check for single-security sectors
                    if (securities.length === 1) {
                        // Handle single security sectors
                    }
                });
                
                // Calculate percentages and prepare Sankey data
                const totalValue = portfolioData.reduce((sum, item) => sum + (item.marketValue || 0), 0);
                
                if (totalValue === 0) {
                    chartContainer.innerHTML = '<p class="text-gray-500 text-center">No market value data available</p>';
                    return;
                }
                
                // Define minimum percentage threshold for securities to prevent line collapse
                const minPercentageThreshold = 0.01; // Very low threshold to include all sectors including Automobiles
                
                // Create Sankey diagram data structure
                const sankeyData = {
                    type: "sankey",
                    orientation: "h",
                    arrangement: "snap", // Better spacing
                    node: {
                        pad: 35, // Increased padding to prevent securities overlap
                        thickness: 18, // Thinner nodes for better link separation
                        line: {
                            color: "rgba(0,0,0,0.3)",
                            width: 0.8
                        },
                        label: [],
                        color: []
                    },
                    link: {
                        source: [],
                        target: [],
                        value: [],
                        color: "rgba(0,0,0,0.2)",
                        hovercolor: "rgba(0,0,0,0.4)"
                    }
                };
                
                // Build nodes and links
                const nodes = [];
                const links = [];
                let nodeIndex = 0;
                
                // Add Portfolio node
                nodes.push("Portfolio");
                nodeIndex++;
                
                // Sort sectors by total market value (largest first)
                const sortedSectors = Object.entries(sectorData)
                    .map(([sector, securities]) => ({
                        sector,
                        totalValue: securities.reduce((sum, sec) => sum + sec.marketValue, 0)
                    }))
                    .sort((a, b) => b.totalValue - a.totalValue);
                
                
                // Add Sector nodes in sorted order
                const sectorIndices = {};
                sortedSectors.forEach(({ sector }) => {
                    nodes.push(sector);
                    sectorIndices[sector] = nodeIndex;
                    nodeIndex++;
                });
                
                // Add Security nodes (only for securities that will have links)
                const securityIndices = {};
                const securitiesToShow = new Set();
                
                // First, collect all securities that will be shown (above threshold)
                portfolioData.forEach(item => {
                    if (item.sector && item.sector !== 'Unknown') {
                        const percentage = ((item.marketValue || 0) / totalValue) * 100;
                        if (percentage >= minPercentageThreshold) {
                            securitiesToShow.add(item.security);
                        } else {
                        }
                    }
                });
                
                // Special handling: Ensure all single-security sectors are included
                Object.entries(sectorData).forEach(([sectorName, securities]) => {
                    if (securities.length === 1) {
                        const security = securities[0].security;
                        if (!securitiesToShow.has(security)) {
                            securitiesToShow.add(security);
                        }
                    }
                });
                
                
                // Then add only those securities as nodes
                securitiesToShow.forEach(security => {
                    // Triple-check: ensure this is actually a security, not a sector name
                    const sectorNames = sortedSectors.map(s => s.sector);
                    
                    // Additional check: ensure the security is not a valid sector name
                    if (!sectorNames.includes(security) && !validSectors.has(security)) {
                        nodes.push(security);
                        securityIndices[security] = nodeIndex;
                        nodeIndex++;
                    } else {
                    }
                });
                
                // Create links from Portfolio to Sectors
                sortedSectors.forEach(({ sector }) => {
                    const sectorValue = sectorData[sector].reduce((sum, item) => sum + item.marketValue, 0);
                    const percentage = (sectorValue / totalValue) * 100;
                    
                    links.push({
                        source: 0, // Portfolio
                        target: sectorIndices[sector],
                        value: percentage
                    });
                });
                
                // Create links from Sectors to Securities
                portfolioData.forEach(item => {
                    if (item.sector && item.sector !== 'Unknown') {
                        const percentage = ((item.marketValue || 0) / totalValue) * 100;
                        
                        // Only include securities above threshold to prevent line collapse
                        if (percentage >= minPercentageThreshold) {
                            // Additional validation: ensure both sector and security exist in our nodes
                            if (sectorIndices[item.sector] !== undefined && securityIndices[item.security] !== undefined) {
                                links.push({
                                    source: sectorIndices[item.sector],
                                    target: securityIndices[item.security],
                                    value: percentage
                                });
                            } else {
                            }
                        }
                    }
                });
                
                // Update Sankey data
                sankeyData.node.label = nodes;
                sankeyData.link.source = links.map(l => l.source);
                sankeyData.link.target = links.map(l => l.target);
                sankeyData.link.value = links.map(l => l.value);
                
                // Debug: Log the final chart data
                
                // Create color scheme matching the image
                const sectorColors = {
                    'Basic Materials': '#FF8C00',      // Orange
                    'Food & Beverage': '#DC143C',     // Red
                    'Energy': '#8B4513',              // Dark Brown
                    'Capital Goods': '#800080',        // Purple
                    'Banks': '#FF69B4',               // Pink
                    'Insurance': '#006400',            // Dark Green
                    'Retailing': '#008B8B',            // Teal
                    'Consumer Services': '#D2691E',    // Light Brown
                    'Consumer Durables': '#654321',    // Dark Brown
                    'Real Estate': '#696969',          // Dark Grey
                    'Utilities': '#87CEEB',            // Light Blue
                    'Automobiles': '#000080',          // Dark Blue
                    'Diversified Finance': '#000000',  // Black
                    'Unknown': '#808080'               // Grey
                };
                
                // Fallback colors for any sectors not in our mapping
                const fallbackColors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                    '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
                ];
                
                sankeyData.node.color = nodes.map((node, i) => {
                    if (i === 0) return '#2E86AB'; // Portfolio color (Blue)
                    
                    if (i <= Object.keys(sectorData).length) {
                        // Sector nodes - use mapped colors or fallback
                        const sectorName = node;
                        return sectorColors[sectorName] || fallbackColors[(i - 1) % fallbackColors.length];
                    } else {
                        // Security nodes - use same color as their sector
                        const security = node;
                        const securityItem = portfolioData.find(item => item.security === security);
                        if (securityItem && securityItem.sector) {
                            return sectorColors[securityItem.sector] || '#808080';
                        }
                        return '#808080'; // Default grey for unknown
                    }
                });
                
                // Create the chart
                const layout = {
                    title: {
                        text: "", // Remove duplicate title
                        font: { size: 18, color: '#374151' }
                    },
                    font: { size: 11, color: '#374151' },
                    height: 600,
                    width: null, // Auto-width to fill container
                    margin: { t: 40, b: 400, l: 80, r: 200 }, // Massive bottom margin to completely prevent text overlap
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    node: {
                        pad: 20,
                        thickness: 25
                    },
                    // Force better spacing and visibility
                    sankey: {
                        node: {
                            thickness: 18,
                            pad: 35
                        },
                        // Improve link spacing and reduce overlap
                        link: {
                            color: "rgba(0,0,0,0.15)",
                            hovercolor: "rgba(0,0,0,0.3)"
                        }
                    },
                    // Add specific legend positioning to prevent clashing
                    showlegend: false, // Disable legend to prevent bottom clashing
                    // Force text positioning to prevent overlap
                    xaxis: { showticklabels: false },
                    yaxis: { showticklabels: false },
                    // Add padding to prevent text overlap
                    annotations: []
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'], // Removed pan2d to keep pan functionality
                    displaylogo: false,
                    useResizeHandler: true,
                    modeBarButtonsToAdd: ['resetScale2d'],
                    modeBarButtons: [
                        ['toImage', 'pan2d', 'zoom2d', 'resetScale2d']
                    ],
                    modeBar: {
                        orientation: 'v',
                        bgcolor: 'rgba(255,255,255,0.95)',
                        color: '#374151',
                        activecolor: '#2E86AB'
                    }
                };
                
                // Calculate dynamic height based on number of securities
                const totalSecurities = portfolioData.length;
                const totalSectors = Object.keys(sectorData).length;
                
                // Base height + additional height for each security (to prevent line collapse)
                let dynamicHeight = 1400; // Much higher base height for better spacing and legend area
                if (totalSecurities > 20) {
                    dynamicHeight = 1400 + (totalSecurities - 20) * 30; // Add 30px per additional security for better separation
                }
                if (totalSecurities > 60) {
                    dynamicHeight = 2600 + (totalSecurities - 60) * 25; // Add 25px per additional security over 60
                }
                
                // Cap maximum height to prevent excessive scrolling
                dynamicHeight = Math.min(dynamicHeight, 5000);
                
                layout.height = dynamicHeight;
                
                // Force the chart to be responsive to container width
                const containerWidth = chartContainer.offsetWidth;
                if (containerWidth > 800) {
                    layout.width = containerWidth - 60; // Account for margins
                }
                
                Plotly.newPlot('diversificationChart', [sankeyData], layout, config);
                
                // Consolidate all buttons into a single column after chart creation
                setTimeout(() => {
                    const modebar = document.querySelector('.modebar');
                    if (modebar) {
                        // Find all button groups
                        const groups = modebar.querySelectorAll('.modebar-group');
                        if (groups.length > 1) {
                            // Move all buttons from second group to first group
                            const firstGroup = groups[0];
                            const secondGroup = groups[1];
                            
                            // Move all buttons from second group to first group
                            while (secondGroup.firstChild) {
                                firstGroup.appendChild(secondGroup.firstChild);
                            }
                            
                            // Remove the empty second group
                            secondGroup.remove();
                            
                        }
                        
                        // Add click event listeners for better button functionality
                        const zoomBtn = modebar.querySelector('[data-attr="dragmode"][data-val="zoom"]');
                        const panBtn = modebar.querySelector('[data-attr="dragmode"][data-val="pan"]');
                        
                        if (zoomBtn) {
                            zoomBtn.addEventListener('click', function() {
                                Plotly.relayout('diversificationChart', {dragmode: 'zoom'});
                            });
                        }
                        
                        if (panBtn) {
                            panBtn.addEventListener('click', function() {
                                Plotly.relayout('diversificationChart', {dragmode: 'pan'});
                            });
                        }
                    }
                    
                    // Force chart boundaries to prevent text overlap
                    const chartContainer = document.getElementById('diversificationChart');
                    if (chartContainer) {
                        const svg = chartContainer.querySelector('svg');
                        if (svg) {
                            // Force SVG to respect boundaries
                            svg.style.overflow = 'visible';
                            svg.style.marginBottom = '100px';
                            
                            // Find and adjust any text elements that might overlap
                            const textElements = svg.querySelectorAll('text');
                            textElements.forEach(text => {
                                const y = parseFloat(text.getAttribute('y'));
                                if (y > 0) {
                                    // Ensure text doesn't go too close to bottom
                                    text.style.dominantBaseline = 'hanging';
                                }
                            });
                        }
                    }
                }, 200);
                
                
            } catch (error) {
                const chartContainer = document.getElementById('diversificationChart');
                if (chartContainer) {
                    chartContainer.innerHTML = '<p class="text-red-500 text-center">Error creating chart: ' + error.message + '</p>';
                }
            }
        }

        // Register Chart.js plugins
        Chart.register(ChartDataLabels);
        
        // Force reasonable spacing for chart titles after page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add reasonable spacing to all chart titles
            const chartTitles = document.querySelectorAll('h3.text-center.text-gray-700.mb-8.text-xl.font-semibold');
            chartTitles.forEach(title => {
                title.style.marginBottom = '2rem'; // 32px - much more reasonable
                title.style.paddingBottom = '0.5rem'; // 8px - minimal padding
                title.style.borderBottom = '1px solid #e5e7eb'; // Thinner, lighter border
            });
            
            // Add minimal spacing above all canvas elements
            const canvases = document.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                canvas.style.marginTop = '1rem'; // 16px - much less aggressive
                canvas.style.display = 'block';
            });
            
        });
        
        // Help toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const helpToggle = document.getElementById('helpToggle');
            const helpSection = document.getElementById('helpSection');
            const helpIcon = document.getElementById('helpIcon');
            const helpText = document.getElementById('helpText');
            
            if (helpToggle && helpSection) {
                helpToggle.addEventListener('click', function() {
                    const isHidden = helpSection.classList.contains('hidden');
                    
                    if (isHidden) {
                        // Show help
                        helpSection.classList.remove('hidden');
                        helpIcon.textContent = 'üìö';
                        helpText.textContent = 'Hide Help';
                        helpToggle.classList.add('text-blue-800');
                    } else {
                        // Hide help
                        helpSection.classList.add('hidden');
                        helpIcon.textContent = 'üìñ';
                        helpText.textContent = 'Show Help';
                        helpToggle.classList.remove('text-blue-800');
                    }
                });
                
            }
        });

        function exportPortfolioData(portfolio) {
            exportPortfolio(portfolio);
        }

        // Zip Export/Import Functions



        async function exportPortfoliosAsZip(portfolios) {
            try {
                // Validate input
                if (!Array.isArray(portfolios) || portfolios.length === 0) {
                    throw new Error('No valid portfolios to export');
                }
                
                // Filter out invalid portfolios
                const validPortfolios = portfolios.filter(portfolio => {
                    return portfolio && 
                           portfolio.name && 
                           portfolio.date && 
                           Array.isArray(portfolio.holdings) &&
                           portfolio.metadata;
                });
                
                if (validPortfolios.length === 0) {
                    throw new Error('No valid portfolios found in selection');
                }
                
                
                // Ensure JSZip is loaded
                if (!window.JSZip) {
                    await loadJSZip();
                }
                
                // Create a new JSZip instance
                const zip = new window.JSZip();
                
                // Add each portfolio as a JSON file
                validPortfolios.forEach(portfolio => {
                    const fileName = `portfolio_${portfolio.name}_${portfolio.date}.json`;
                    const portfolioData = {
                        ...portfolio,
                        metadata: {
                            ...portfolio.metadata,
                            exportDate: new Date().toISOString()
                        }
                    };
                    zip.file(fileName, JSON.stringify(portfolioData, null, 2));
                });
                
                // Add a manifest file
                const manifest = {
                    exportDate: new Date().toISOString(),
                    portfolioCount: validPortfolios.length,
                    portfolios: validPortfolios.map(p => ({
                        name: p.name,
                        date: p.date,
                        description: p.description || '',
                        securities: p.holdings ? p.holdings.length : 0,
                        totalValue: p.metadata ? (p.metadata.totalValue || 0) : 0
                    }))
                };
                
                zip.file('manifest.json', JSON.stringify(manifest, null, 2));
                
                // Generate and download the zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `portfolios_export_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                
                URL.revokeObjectURL(link.href);
                
            } catch (error) {
                throw new Error('Failed to create ZIP file: ' + error.message);
            }
        }

        async function loadJSZip() {
            // JSZip is already loaded in the HTML head
            if (window.JSZip) {
                return window.JSZip;
            }
            
            // Fallback: wait a bit for the library to load
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 10;
                
                const checkJSZip = () => {
                    if (window.JSZip) {
                        resolve(window.JSZip);
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkJSZip, 100);
                    } else {
                        reject(new Error('JSZip library failed to load'));
                    }
                };
                
                checkJSZip();
            });
        }

        async function importPortfoliosFromZip(zipFile) {
            try {
                const JSZip = await loadJSZip();
                const zip = new JSZip();
                const zipData = await zip.loadAsync(zipFile);
                
                const importedPortfolios = [];
                const errors = [];
                
                // Process each file in the zip
                for (const [fileName, fileData] of Object.entries(zipData.files)) {
                    if (fileData.dir || !fileName.endsWith('.json') || fileName === 'manifest.json') {
                        continue; // Skip directories, non-JSON files, and manifest
                    }
                    
                    try {
                        const content = await fileData.async('string');
                        const portfolioData = JSON.parse(content);
                        
                        // Validate portfolio structure
                        if (!portfolioData.name || !portfolioData.date || !Array.isArray(portfolioData.holdings)) {
                            errors.push(`Invalid portfolio file: ${fileName}`);
                            continue;
                        }
                        
                        // Create new portfolio object
                        const portfolio = new Portfolio(
                            portfolioData.name,
                            portfolioData.date,
                            portfolioData.description || '',
                            portfolioData.holdings || [],
                            portfolioData.metadata || {}
                        );
                        
                        // Check for duplicate names
                        const existingPortfolios = await getAllPortfoliosFromDB();
                        const duplicateName = existingPortfolios.find(p => p.name === portfolio.name);
                        
                        if (duplicateName) {
                            // Aggregate data instead of overwriting
                            
                            // Get existing portfolio data
                            const existingPortfolio = await getPortfolioFromDB(duplicateName.id);
                            
                            // Aggregate holdings data
                            if (existingPortfolio.holdings && portfolio.holdings) {
                                const holdingsMap = new Map();
                                
                                // Add existing holdings
                                existingPortfolio.holdings.forEach(holding => {
                                    const symbol = holding.symbol || holding.security;
                                    holdingsMap.set(symbol, { ...holding });
                                });
                                
                                // Aggregate new holdings
                                portfolio.holdings.forEach(holding => {
                                    const symbol = holding.symbol || holding.security;
                                    if (holdingsMap.has(symbol)) {
                                        const existing = holdingsMap.get(symbol);
                                        const newQuantity = parseFloat(holding.quantity) || 0;
                                        const existingQuantity = parseFloat(existing.quantity) || 0;
                                        const newAvgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
                                        const existingAvgCost = parseFloat(existing.avgPrice || existing.avgCost) || 0;
                                        const newMarketValue = parseFloat(holding.marketValue) || 0;
                                        const existingMarketValue = parseFloat(existing.marketValue) || 0;
                                        
                                        // Aggregate quantities and recalculate average cost
                                        const totalQuantity = existingQuantity + newQuantity;
                                        const totalCost = (existingQuantity * existingAvgCost) + (newQuantity * newAvgCost);
                                        const newAvgCostCalculated = totalQuantity > 0 ? totalCost / totalQuantity : existingAvgCost;
                                        
                                        // Use the latest market value and last price
                                        const latestMarketValue = newMarketValue > 0 ? newMarketValue : existingMarketValue;
                                        const latestLastPrice = parseFloat(holding.lastPrice) || parseFloat(existing.lastPrice) || 0;
                                        
                                        holdingsMap.set(symbol, {
                                            ...existing,
                                            quantity: totalQuantity,
                                            avgPrice: newAvgCostCalculated,
                                            avgCost: newAvgCostCalculated,
                                            marketValue: latestMarketValue,
                                            lastPrice: latestLastPrice,
                                            totalCost: totalCost
                                        });
                                        
                                    } else {
                                        holdingsMap.set(symbol, { ...holding });
                                    }
                                });
                                
                                // Update portfolio with aggregated holdings
                                portfolio.holdings = Array.from(holdingsMap.values());
                            }
                            
                            // Delete existing portfolio and save aggregated one
                            await deletePortfolioFromDB(duplicateName.id);
                        }
                        
                        // Save to database
                        await savePortfolioToDB(portfolio);
                        importedPortfolios.push(portfolio.name);
                        
                    } catch (error) {
                        errors.push(`Error processing ${fileName}: ${error.message}`);
                    }
                }
                
                // Show results in console for production
                if (importedPortfolios.length > 0) {
                    showNotification(`Successfully imported ${importedPortfolios.length} portfolios`, 'success');
                }
                
                if (errors.length > 0) {
                    showNotification(`${errors.length} import errors occurred`, 'warning');
                }
                
                // Refresh portfolio list
                loadPortfolioList();
                
            } catch (error) {
                alert('Error importing portfolios: ' + error.message);
            }
        }

        // Portfolio Selection Management
        function getSelectedPortfolios() {
            const checkboxes = document.querySelectorAll('.portfolio-checkbox:checked');
            const selectedPortfolios = Array.from(checkboxes).map(cb => ({
                id: cb.dataset.portfolioId,
                name: cb.dataset.portfolioName
            }));
            
            // Group by portfolio name to avoid counting duplicate files as separate portfolios
            const uniquePortfolios = [];
            const seenNames = new Set();
            
            selectedPortfolios.forEach(portfolio => {
                if (!seenNames.has(portfolio.name)) {
                    seenNames.add(portfolio.name);
                    uniquePortfolios.push(portfolio);
                }
            });
            
            
            return uniquePortfolios;
        }

        function updatePortfolioSelection() {
            const selectedPortfolios = getSelectedPortfolios();
            const exportBtn = document.getElementById('exportBtn');
            const comparisonControls = document.getElementById('comparisonControls');
            const selectedPortfoliosSpan = document.getElementById('selectedPortfolios');
            const compareSelectedBtn = document.getElementById('compareSelectedBtn');
            const showChartViewBtn = document.getElementById('showChartViewBtn');
            const selectedCount = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllPortfolios');
            const selectAllTable = document.getElementById('selectAllTable');
            const comparisonOrder = document.getElementById('comparisonOrder');
            const manualOrderSelection = document.getElementById('manualOrderSelection');
            
            // Update export button
            if (exportBtn) {
                exportBtn.disabled = false; // Always enabled since it can export all or selected
            }
            
            // Update selected count
            if (selectedCount) {
                const uniquePortfolios = getSelectedPortfolios();
                const allCheckboxes = document.querySelectorAll('.portfolio-checkbox:checked');
                const totalFiles = allCheckboxes.length;
                const uniqueCount = uniquePortfolios.length;
                
                if (totalFiles > uniqueCount) {
                    selectedCount.textContent = `${uniqueCount} portfolios (${totalFiles} files)`;
                    selectedCount.title = `Selected ${uniqueCount} unique portfolios from ${totalFiles} total files`;
                } else {
                    selectedCount.textContent = `${uniqueCount} selected`;
                }
            }
            
            // Update select all checkboxes (both card and table views)
            const allCheckboxes = document.querySelectorAll('.portfolio-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.portfolio-checkbox:checked');
            const allChecked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
            
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
            }
            
            if (selectAllTable) {
                selectAllTable.checked = allChecked;
                selectAllTable.indeterminate = selectedPortfolios.length > 0 && selectedPortfolios.length < allCheckboxes.length;
            }
            
            // Update comparison controls
            if (comparisonControls && selectedPortfoliosSpan && compareSelectedBtn && showChartViewBtn) {
                const uniquePortfolios = getSelectedPortfolios();
                if (uniquePortfolios.length === 2) {
                    comparisonControls.classList.remove('hidden');
                    selectedPortfoliosSpan.textContent = uniquePortfolios.map(p => p.name).join(' vs ');
                    compareSelectedBtn.disabled = false;
                    showChartViewBtn.disabled = false;
                } else if (uniquePortfolios.length > 2) {
                    comparisonControls.classList.remove('hidden');
                    selectedPortfoliosSpan.textContent = `${uniquePortfolios.length} portfolios selected (max 2 for comparison)`;
                    compareSelectedBtn.disabled = true;
                    showChartViewBtn.disabled = false;
                } else {
                    comparisonControls.classList.add('hidden');
                    showChartViewBtn.disabled = true;
                }
            }
            
            // Update delete selected button
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) {
                const hasSelected = selectedPortfolios.length > 0;
                deleteSelectedBtn.disabled = !hasSelected;
                if (hasSelected) {
                    deleteSelectedBtn.textContent = `üóëÔ∏è Delete Selected (${selectedPortfolios.length})`;
                } else {
                    deleteSelectedBtn.textContent = 'üóëÔ∏è Delete Selected';
                }
            }
        }



        function selectAllPortfolios(selectAll) {
            const checkboxes = document.querySelectorAll('.portfolio-checkbox');
            
            if (selectAll) {
                // Select all checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                // Unselect all checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            updatePortfolioSelection();
        }

        async function deleteSelectedPortfolios() {
            const selectedCheckboxes = document.querySelectorAll('.portfolio-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.portfolioId);
            
            if (selectedIds.length === 0) {
                alert('Please select portfolios to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected portfolio(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                // Delete each selected portfolio
                for (const portfolioId of selectedIds) {
                    await deletePortfolioFromDB(portfolioId);
                }
                
                // Refresh the portfolio list
                loadPortfolioList();
                alert(`${selectedIds.length} portfolio(s) deleted successfully`);
            } catch (error) {
                alert('Error deleting portfolios: ' + error.message);
            }
        }

        async function compareSelectedPortfolios() {
            const selectedPortfolios = getSelectedPortfolios();
            if (selectedPortfolios.length !== 2) {
                showNotification('Please select exactly 2 portfolios for comparison', 'warning');
                return;
            }
            
            try {
                // Load both portfolios
                const portfolio1 = await loadPortfolioFromDB(selectedPortfolios[0].id);
                const portfolio2 = await loadPortfolioFromDB(selectedPortfolios[1].id);
                
                // Automatically determine order based on date (earlier date = baseline)
                let baselinePortfolio, comparePortfolio;
                
                if (portfolio1.name <= portfolio2.name) {
                    // portfolio1 has earlier or same date (YYYYMMDD format sorts chronologically)
                    baselinePortfolio = portfolio1;
                    comparePortfolio = portfolio2;
                } else {
                    // portfolio2 has earlier date
                    baselinePortfolio = portfolio2;
                    comparePortfolio = portfolio1;
                }
                
                // Set up comparison mode
                comparisonMode = true;
                initialPortfolio = baselinePortfolio.holdings;
                portfolioData = comparePortfolio.holdings;
                
                // Add sectors
                sectorMapping = {...defaultSectorMapping};
                portfolioData.forEach(item => {
                    item.sector = sectorMapping[item.security] || 'Unknown';
                });
                
                // Show dashboard with comparison
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('portfolioManagementSection').classList.add('hidden');
                document.getElementById('uploadModal').classList.add('hidden');
                
                // Show comparison elements
                document.getElementById('comparisonCards').classList.remove('hidden');
                document.getElementById('comparisonTable').classList.remove('hidden');
                
                // Calculate and display comparison data
                calculateComparisonData(initialPortfolio, portfolioData);
                
                // Refresh dashboard
                refreshDashboard();
                
                // Clear selections
                document.querySelectorAll('.portfolio-checkbox:checked').forEach(cb => cb.checked = false);
                updatePortfolioSelection();
                
                showNotification(`Comparing portfolios: ${baselinePortfolio.name} (baseline) vs ${comparePortfolio.name} (compare)`, 'success');
                
            } catch (error) {
                showNotification('Error setting up comparison: ' + error.message, 'error');
            }
        }

        // Single Export Function
        async function exportPortfolios() {
            const selectedPortfolios = getSelectedPortfolios();
            
            try {
                if (selectedPortfolios.length === 0) {
                    // No selection - export all unique portfolios
                    const allPortfolios = await getAllPortfoliosFromDB();
                    
                    // Get unique portfolios by name
                    const uniquePortfolios = [];
                    const seenNames = new Set();
                    
                    allPortfolios.forEach(portfolio => {
                        if (!seenNames.has(portfolio.name)) {
                            seenNames.add(portfolio.name);
                            uniquePortfolios.push(portfolio);
                        } else {
                            // Keep the most recent one
                            const existingIndex = uniquePortfolios.findIndex(p => p.name === portfolio.name);
                            if (existingIndex !== -1) {
                                const existingDate = new Date(uniquePortfolios[existingIndex].metadata.createdAt);
                                const newDate = new Date(portfolio.metadata.createdAt);
                                if (newDate > existingDate) {
                                    uniquePortfolios[existingIndex] = portfolio;
                                }
                            }
                        }
                    });
                    
                    if (uniquePortfolios.length === 0) {
                        showNotification('No portfolios to export', 'warning');
                        return;
                    }
                    showNotification(`Exporting all ${uniquePortfolios.length} unique portfolios...`, 'info');
                    await exportPortfoliosAsZip(uniquePortfolios);
                    showNotification(`Successfully exported ${uniquePortfolios.length} unique portfolios`, 'success');
                } else {
                    // Export selected portfolios
                    showNotification(`Exporting ${selectedPortfolios.length} selected portfolios...`, 'info');
                    
                    // Get full portfolio data from database
                    const fullPortfolios = [];
                    for (const selected of selectedPortfolios) {
                        const portfolio = await loadPortfolioFromDB(selected.id);
                        if (portfolio) {
                            fullPortfolios.push(portfolio);
                        }
                    }
                    
                    if (fullPortfolios.length > 0) {
                        await exportPortfoliosAsZip(fullPortfolios);
                        showNotification(`Successfully exported ${fullPortfolios.length} portfolios`, 'success');
                    } else {
                        showNotification('No valid portfolios found in selection', 'warning');
                    }
                }
            } catch (error) {
                showNotification(`Export failed: ${error.message}`, 'error');
            }
        }

        // Export button
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', exportPortfolios);
        }
        
        // Select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllPortfolios');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                selectAllPortfolios(this.checked);
                // Force update after a short delay to ensure DOM is updated
                setTimeout(() => {
                    updatePortfolioSelection();
                }, 100);
            });
        }
        
        // Select all table checkbox
        const selectAllTable = document.getElementById('selectAllTable');
        if (selectAllTable) {
            selectAllTable.addEventListener('change', function() {
                selectAllPortfolios(this.checked);
            });
        }
        
        // View toggle buttons
        const cardViewBtn = document.getElementById('cardViewBtn');
        if (cardViewBtn) {
            cardViewBtn.addEventListener('click', showCardView);
        }
        
        const tableViewBtn = document.getElementById('tableViewBtn');
        if (tableViewBtn) {
            tableViewBtn.addEventListener('click', showTableView);
        }
        
        // Delete selected button
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        if (deleteSelectedBtn) {
            deleteSelectedBtn.addEventListener('click', deleteSelectedPortfolios);
        }
        

        
        // Compare selected portfolios button
        const compareSelectedBtn = document.getElementById('compareSelectedBtn');
        if (compareSelectedBtn) {
            compareSelectedBtn.addEventListener('click', compareSelectedPortfolios);
        }

        // Show chart view button
        const showChartViewBtn = document.getElementById('showChartViewBtn');
        if (showChartViewBtn) {
            showChartViewBtn.addEventListener('click', showMultiPortfolioChartView);
        }

        // Show trade analysis button
        const showTradeAnalysisBtn = document.getElementById('showTradeAnalysisBtn');
        if (showTradeAnalysisBtn) {
            showTradeAnalysisBtn.addEventListener('click', showTradeAnalysisSection);
        }

        // Trade analysis section buttons
        const analyzeTradesBtn = document.getElementById('analyzeTradesBtn');
        if (analyzeTradesBtn) {
            analyzeTradesBtn.addEventListener('click', analyzeTrades);
        }

        const backToManagementFromTradeBtn = document.getElementById('backToManagementFromTradeBtn');
        if (backToManagementFromTradeBtn) {
            backToManagementFromTradeBtn.addEventListener('click', showPortfolioManagement);
        }

        // Update trade analysis when portfolio selection changes
        document.addEventListener('change', function(event) {
            if (event.target.classList.contains('portfolio-checkbox')) {
                // Update selected portfolios count in trade analysis if it's visible
                const tradeAnalysisSection = document.getElementById('tradeAnalysisSection');
                if (tradeAnalysisSection && !tradeAnalysisSection.classList.contains('hidden')) {
                    updateSelectedPortfoliosCount();
                    loadTradingJournalData();
                }
            }
        });

        // Manual trade entry modal event listeners
        const addManualTradeBtn = document.getElementById('addManualTradeBtn');
        if (addManualTradeBtn) {
            addManualTradeBtn.addEventListener('click', openManualTradeModal);
        }

        const cancelTradeBtn = document.getElementById('cancelTradeBtn');
        if (cancelTradeBtn) {
            cancelTradeBtn.addEventListener('click', closeManualTradeModal);
        }

        const saveTradeBtn = document.getElementById('saveTradeBtn');
        if (saveTradeBtn) {
            saveTradeBtn.addEventListener('click', saveManualTrade);
        }

        const tradeTypeSelect = document.getElementById('tradeType');
        if (tradeTypeSelect) {
            tradeTypeSelect.addEventListener('change', toggleSellFields);
        }




        // Chart view controls
        const closeChartViewBtn = document.getElementById('closeChartView');
        if (closeChartViewBtn) {
            closeChartViewBtn.addEventListener('click', closeChartView);
        }

        const selectAllStocksBtn = document.getElementById('selectAllStocks');
        if (selectAllStocksBtn) {
            selectAllStocksBtn.addEventListener('click', selectAllStocks);
        }

        const clearAllStocksBtn = document.getElementById('clearAllStocks');
        if (clearAllStocksBtn) {
            clearAllStocksBtn.addEventListener('click', clearAllStocks);
        }

        const resetChartBtn = document.getElementById('resetChart');
        if (resetChartBtn) {
            resetChartBtn.addEventListener('click', resetChart);
        }

        const exportChartBtn = document.getElementById('exportChart');
        if (exportChartBtn) {
            exportChartBtn.addEventListener('click', exportChart);
        }

        // Chart data type toggles
        const priceChartRadio = document.getElementById('priceChart');
        const pnlChartRadio = document.getElementById('pnlChart');
        const pnlPercentageChartRadio = document.getElementById('pnlPercentageChart');
        
        if (priceChartRadio) {
            priceChartRadio.addEventListener('change', createStockPriceChart);
        }
        
        if (pnlChartRadio) {
            pnlChartRadio.addEventListener('change', createStockPriceChart);
        }
        
        if (pnlPercentageChartRadio) {
            pnlPercentageChartRadio.addEventListener('change', createStockPriceChart);
        }

        // Chart view type toggles
        const valueViewRadio = document.getElementById('valueView');
        const percentageViewRadio = document.getElementById('percentageView');
        
        if (valueViewRadio) {
            valueViewRadio.addEventListener('change', createStockPriceChart);
        }
        
        if (percentageViewRadio) {
            percentageViewRadio.addEventListener('change', createStockPriceChart);
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            if (notification && messageEl && iconEl) {
                messageEl.textContent = message;
                
                // Set icon based on type
                switch (type) {
                    case 'success':
                        iconEl.textContent = '‚úÖ';
                        break;
                    case 'warning':
                        iconEl.textContent = '‚ö†Ô∏è';
                        break;
                    case 'error':
                        iconEl.textContent = '‚ùå';
                        break;
                    default:
                        iconEl.textContent = '‚ÑπÔ∏è';
                }
                
                notification.classList.remove('hidden');
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    hideNotification();
                }, 5000);
            }
        }
        
        function hideNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.add('hidden');
            }
        }

        // View Toggle Functions
        function showCardView() {
            const portfolioList = document.getElementById('portfolioList');
            const tableViewContainer = document.getElementById('tableViewContainer');
            const cardViewBtn = document.getElementById('cardViewBtn');
            const tableViewBtn = document.getElementById('tableViewBtn');
            
            if (portfolioList && tableViewContainer && cardViewBtn && tableViewBtn) {
                // Show card view
                portfolioList.classList.remove('hidden');
                tableViewContainer.classList.add('hidden');
                
                // Update button states
                cardViewBtn.className = 'px-3 py-1 text-sm font-medium text-blue-600 bg-blue-100 rounded-md border border-blue-200';
                tableViewBtn.className = 'px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md border border-gray-200 hover:bg-gray-200';
                
            }
        }

        function showTableView() {
            const portfolioList = document.getElementById('portfolioList');
            const tableViewContainer = document.getElementById('tableViewContainer');
            const cardViewBtn = document.getElementById('cardViewBtn');
            const tableViewBtn = document.getElementById('tableViewBtn');
            
            if (portfolioList && tableViewContainer && cardViewBtn && tableViewBtn) {
                // Show table view
                portfolioList.classList.add('hidden');
                tableViewContainer.classList.remove('hidden');
                
                // Update button states
                cardViewBtn.className = 'px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md border border-gray-200 hover:bg-gray-200';
                tableViewBtn.className = 'px-3 py-1 text-sm font-medium text-blue-600 bg-blue-100 rounded-md border border-blue-200';
                
            }
        }

        // Update portfolio count display
        function updatePortfolioCount() {
            const portfolioCountElement = document.getElementById('portfolioCount');
            if (portfolioCountElement) {
                getAllPortfoliosFromDB().then(portfolios => {
                    // Get unique portfolios by name
                    const uniquePortfolios = [];
                    const seenNames = new Set();
                    
                    portfolios.forEach(portfolio => {
                        if (!seenNames.has(portfolio.name)) {
                            seenNames.add(portfolio.name);
                            uniquePortfolios.push(portfolio);
                        }
                    });
                    
                    
                    portfolioCountElement.textContent = `${uniquePortfolios.length} portfolios (${portfolios.length} total uploads)`;
                });
            }
        }

        // Portfolio Selection Management

        // Multi-Portfolio Chart View Functions
        let selectedPortfoliosForChart = [];
        let stockPriceData = {};
        let selectedStocks = new Set();

        async function showMultiPortfolioChartView() {
            const selectedPortfolios = getSelectedPortfolios();
            if (selectedPortfolios.length < 2) {
                showNotification('Please select at least 2 portfolios to view price trends', 'warning');
                return;
            }

            try {
                selectedPortfoliosForChart = selectedPortfolios;
                
                // Load portfolio data and prepare chart data
                await prepareStockPriceData();
                
                // Show chart view
                document.getElementById('multiPortfolioChartView').classList.remove('hidden');
                
                // Populate stock list
                populateStockList();
                
                // Auto-select Portfolio stock by default
                if (stockPriceData['Portfolio']) {
                    selectedStocks.add('Portfolio');
                }
                
                // Update stock list to reflect selection
                populateStockList();
                
                // Create initial chart
                createStockPriceChart();
                
                showNotification(`Showing price trends for ${selectedPortfolios.length} portfolios`, 'success');
                
            } catch (error) {
                showNotification('Error loading chart data: ' + error.message, 'error');
            }
        }

        async function prepareStockPriceData() {
            stockPriceData = {};
            
            // Load all selected portfolios
            for (const portfolio of selectedPortfoliosForChart) {
                const portfolioData = await loadPortfolioFromDB(portfolio.id);
                if (portfolioData && portfolioData.holdings) {
                    const portfolioDate = portfolioData.name; // YYYYMMDD format
                    
                    // Calculate portfolio-level averages
                    let totalAvgPrice = 0;
                    let totalCurrentPrice = 0;
                    let totalQuantity = 0;
                    let validHoldings = 0;
                    
                    portfolioData.holdings.forEach(holding => {
                        // Skip holdings with quantity 0
                        if (!holding.quantity || holding.quantity <= 0) {
                            return;
                        }
                        
                        const stock = holding.security;
                        
                        if (!stockPriceData[stock]) {
                            stockPriceData[stock] = {
                                dates: [],
                                avgPrices: [],
                                currentPrices: [],
                                quantities: [],
                                pnlValues: [],
                                pnlPercentages: [],
                                initialAvgPrice: null,
                                initialTotalCost: null
                            };
                        }
                        
                        // Add data for this portfolio date
                        stockPriceData[stock].dates.push(portfolioDate);
                        stockPriceData[stock].avgPrices.push(holding.avgPrice || 0);
                        stockPriceData[stock].currentPrices.push(holding.marketValue / (holding.quantity || 1) || 0);
                        stockPriceData[stock].quantities.push(holding.quantity || 0);
                        
                        // Calculate P&L values
                        const totalCost = (holding.avgPrice || 0) * (holding.quantity || 0);
                        const pnlValue = (holding.marketValue || 0) - totalCost;
                        const pnlPercentage = totalCost > 0 ? (pnlValue / totalCost) * 100 : 0;
                        
                        stockPriceData[stock].pnlValues.push(pnlValue);
                        stockPriceData[stock].pnlPercentages.push(pnlPercentage);
                        
                        // Store initial values for percentage calculation
                        if (!stockPriceData[stock].initialAvgPrice) {
                            stockPriceData[stock].initialAvgPrice = holding.avgPrice || 0;
                            stockPriceData[stock].initialTotalCost = totalCost;
                        }
                        
                        // Accumulate portfolio-level data
                        if (holding.avgPrice && holding.quantity) {
                            totalAvgPrice += (holding.avgPrice * holding.quantity);
                            totalCurrentPrice += holding.marketValue;
                            totalQuantity += holding.quantity;
                            validHoldings++;
                        }
                    });
                    
                    // Add portfolio-level data
                    if (validHoldings > 0) {
                        if (!stockPriceData['Portfolio']) {
                            stockPriceData['Portfolio'] = {
                                dates: [],
                                avgPrices: [],
                                currentPrices: [],
                                quantities: [],
                                pnlValues: [],
                                pnlPercentages: [],
                                initialAvgPrice: null,
                                initialTotalCost: null
                            };
                        }
                        
                        const portfolioAvgPrice = totalAvgPrice / totalQuantity;
                        const portfolioCurrentPrice = totalCurrentPrice / totalQuantity;
                        
                        // Calculate portfolio P&L
                        const portfolioTotalCost = totalAvgPrice;
                        const portfolioPnLValue = totalCurrentPrice - portfolioTotalCost;
                        const portfolioPnLPercentage = portfolioTotalCost > 0 ? (portfolioPnLValue / portfolioTotalCost) * 100 : 0;
                        
                        stockPriceData['Portfolio'].dates.push(portfolioDate);
                        stockPriceData['Portfolio'].avgPrices.push(portfolioAvgPrice);
                        stockPriceData['Portfolio'].currentPrices.push(portfolioCurrentPrice);
                        stockPriceData['Portfolio'].quantities.push(totalQuantity);
                        stockPriceData['Portfolio'].pnlValues.push(portfolioPnLValue);
                        stockPriceData['Portfolio'].pnlPercentages.push(portfolioPnLPercentage);
                        
                        // Store initial portfolio values for percentage calculation
                        if (!stockPriceData['Portfolio'].initialAvgPrice) {
                            stockPriceData['Portfolio'].initialAvgPrice = portfolioAvgPrice;
                            stockPriceData['Portfolio'].initialTotalCost = portfolioTotalCost;
                        }
                    }
                }
            }
            
            // Sort dates chronologically for each stock
            Object.keys(stockPriceData).forEach(stock => {
                const stockData = stockPriceData[stock];
                const sortedIndices = stockData.dates.map((date, index) => ({ date, index }))
                    .sort((a, b) => a.date.localeCompare(b.date))
                    .map(item => item.index);
                
                // Reorder arrays based on sorted dates
                stockData.dates = sortedIndices.map(i => stockData.dates[i]);
                stockData.avgPrices = sortedIndices.map(i => stockData.avgPrices[i]);
                stockData.currentPrices = sortedIndices.map(i => stockData.currentPrices[i]);
                stockData.quantities = sortedIndices.map(i => stockData.quantities[i]);
            });
        }

        function populateStockList() {
            const stockList = document.getElementById('stockList');
            const stockSearch = document.getElementById('stockSearch');
            
            if (!stockList) return;
            
            stockList.innerHTML = '';
            
            // Sort stocks with Portfolio first, then alphabetically
            const stocks = Object.keys(stockPriceData).sort((a, b) => {
                if (a === 'Portfolio') return -1;
                if (b === 'Portfolio') return 1;
                return a.localeCompare(b);
            });
            
            stocks.forEach(stock => {
                const stockItem = document.createElement('div');
                const isPortfolio = stock === 'Portfolio';
                
                stockItem.className = `flex items-center space-x-2 p-2 hover:bg-gray-100 rounded cursor-pointer ${isPortfolio ? 'bg-blue-50 border-l-4 border-blue-400' : ''}`;
                stockItem.onclick = () => toggleStockSelection(stock);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = `w-4 h-4 ${isPortfolio ? 'text-blue-600' : 'text-blue-600'} rounded border-gray-300 focus:ring-blue-500`;
                checkbox.checked = selectedStocks.has(stock);
                checkbox.onclick = (e) => e.stopPropagation();
                checkbox.onchange = () => toggleStockSelection(stock);
                
                const label = document.createElement('span');
                label.className = `text-sm flex-1 ${isPortfolio ? 'font-semibold text-blue-800' : 'text-gray-700'}`;
                label.textContent = stock;
                
                // Add color pill
                const colorPill = document.createElement('span');
                colorPill.className = 'w-4 h-4 rounded-full ml-2 border-2 border-gray-400 inline-block';
                const stockColor = getStockColor(stock, 'avg');
                colorPill.style.backgroundColor = stockColor;
                colorPill.style.minWidth = '16px';
                colorPill.style.minHeight = '16px';
                colorPill.style.display = 'inline-block';
                label.appendChild(colorPill);
                
                // Add portfolio indicator
                if (isPortfolio) {
                    const portfolioIcon = document.createElement('span');
                    portfolioIcon.className = 'text-blue-600 text-xs ml-1';
                    portfolioIcon.textContent = 'üìä';
                    label.appendChild(portfolioIcon);
                }
                
                stockItem.appendChild(checkbox);
                stockItem.appendChild(label);
                stockList.appendChild(stockItem);
            });
            
            // Add search functionality
            if (stockSearch) {
                stockSearch.oninput = filterStockList;
            }
        }

        function filterStockList() {
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            const stockItems = document.querySelectorAll('#stockList > div');
            
            stockItems.forEach(item => {
                const stockName = item.querySelector('span').textContent.toLowerCase();
                if (stockName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function toggleStockSelection(stock) {
            if (selectedStocks.has(stock)) {
                selectedStocks.delete(stock);
            } else {
                selectedStocks.add(stock);
            }
            
            // Update checkbox state
            const stockItem = Array.from(document.querySelectorAll('#stockList > div')).find(item => 
                item.querySelector('span').textContent === stock
            );
            if (stockItem) {
                const checkbox = stockItem.querySelector('input[type="checkbox"]');
                checkbox.checked = selectedStocks.has(stock);
            }
            
            // Update chart
            createStockPriceChart();
        }

        function createStockPriceChart() {
            const chartContainer = document.getElementById('stockPriceChart');
            if (!chartContainer) return;
            
            // Get chart view type early
            const chartViewType = document.getElementById('chartViewType')?.value || 'value';
            
            if (selectedStocks.size === 0) {
                // Clear the canvas and show message
                const ctx = chartContainer.getContext('2d');
                ctx.clearRect(0, 0, chartContainer.width, chartContainer.height);
                
                // Draw message on canvas
                ctx.fillStyle = '#6B7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Select stocks to view price trends', chartContainer.width / 2, chartContainer.height / 2);
                return;
            }
            
            // Show percentage view info message
            if (chartViewType === 'percentage') {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800';
                infoDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-600">‚ÑπÔ∏è</span>
                        <span><strong>Percentage View:</strong> Shows price deviation from initial date's average price (set as 0%). 
                        Positive values = price increase, Negative values = price decrease.</span>
                    </div>
                `;
                
                // Insert info message above the chart
                const chartContainerDiv = document.querySelector('.chart-container');
                if (chartContainerDiv && !chartContainerDiv.querySelector('.info-message')) {
                    infoDiv.classList.add('info-message');
                    chartContainerDiv.insertBefore(infoDiv, chartContainerDiv.firstChild);
                }
            } else {
                // Remove percentage info message if exists
                const existingInfo = document.querySelector('.info-message');
                if (existingInfo) {
                    existingInfo.remove();
                }
            }
            
            const chartDataType = document.getElementById('chartDataType')?.value || 'price';
            
            // Prepare chart data
            const datasets = [];
            const allDates = new Set();
            
            // Collect all unique dates
            selectedStocks.forEach(stock => {
                if (stockPriceData[stock]) {
                    stockPriceData[stock].dates.forEach(date => allDates.add(date));
                }
            });
            
            const sortedDates = Array.from(allDates).sort();
            
            // Create datasets for each selected stock
            selectedStocks.forEach(stock => {
                if (stockPriceData[stock]) {
                    const stockData = stockPriceData[stock];
                    const initialPrice = stockData.initialAvgPrice || 0;
                    
                    let datasetsForStock = [];
                    
                    switch (chartViewType) {
                        case 'value':
                            // Option 1: Value - shows stock's avg price and dotted current price
                            const avgDataset = {
                                label: `${stock} - Avg Price`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    return Number(stockData.avgPrices[index]).toFixed(2);
                                }),
                                borderColor: getStockColor(stock, 'avg'),
                                backgroundColor: getStockColor(stock, 'avg'),
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            };
                            
                            const currentDataset = {
                                label: `${stock} - Current Price`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    return Number(stockData.currentPrices[index]).toFixed(2);
                                }),
                                borderColor: getStockColor(stock, 'current'),
                                backgroundColor: getStockColor(stock, 'current'),
                                borderWidth: 2,
                                borderDash: [5, 5], // Dotted line
                                fill: false,
                                tension: 0.1
                            };
                            
                            datasetsForStock = [avgDataset, currentDataset];
                            break;
                            
                        case 'percentage':
                            // Option 2: Percentage - deviation from initial avg price (0%)
                            const avgPercentageDataset = {
                                label: `${stock} - Avg Price %`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    const price = stockData.avgPrices[index];
                                    return initialPrice > 0 ? Number(((price - initialPrice) / initialPrice) * 100).toFixed(2) : 0;
                                }),
                                borderColor: getStockColor(stock, 'avg'),
                                backgroundColor: getStockColor(stock, 'avg'),
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            };
                            
                            const currentPercentageDataset = {
                                label: `${stock} - Current Price %`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    const price = stockData.currentPrices[index];
                                    return initialPrice > 0 ? Number(((price - initialPrice) / initialPrice) * 100).toFixed(2) : 0;
                                }),
                                borderColor: getStockColor(stock, 'current'),
                                backgroundColor: getStockColor(stock, 'current'),
                                borderWidth: 2,
                                borderDash: [5, 5], // Dotted line
                                fill: false,
                                tension: 0.1
                            };
                            
                            datasetsForStock = [avgPercentageDataset, currentPercentageDataset];
                            break;
                            
                        case 'pnl':
                            // Option 3: P&L Value - single value for each period
                            const pnlDataset = {
                                label: `${stock} - P&L Value`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    return Number(stockData.pnlValues[index]).toFixed(2);
                                }),
                                borderColor: getStockColor(stock, 'pnl'),
                                backgroundColor: getStockColor(stock, 'pnl'),
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            };
                            
                            datasetsForStock = [pnlDataset];
                            break;
                            
                        case 'pnlPercentage':
                            // Option 4: P&L % - percentage for each period
                            const pnlPercentageDataset = {
                                label: `${stock} - P&L %`,
                                data: sortedDates.map(date => {
                                    const index = stockData.dates.indexOf(date);
                                    if (index === -1) return null;
                                    return Number(stockData.pnlPercentages[index]).toFixed(2);
                                }),
                                borderColor: getStockColor(stock, 'pnlPercentage'),
                                backgroundColor: getStockColor(stock, 'pnlPercentage'),
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            };
                            
                            datasetsForStock = [pnlPercentageDataset];
                            break;
                    }
                    
                    datasets.push(...datasetsForStock);
                }
            });
            
            // Format dates for display
            const formattedDates = sortedDates.map(date => {
                const year = date.substring(0, 4);
                const month = date.substring(4, 6);
                const day = date.substring(6, 8);
                return `${year}-${month}-${day}`;
            });
            
            // Create chart
            if (window.stockPriceChartInstance) {
                window.stockPriceChartInstance.destroy();
            }
            
            const ctx = chartContainer.getContext('2d');
            window.stockPriceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: getChartTitle(chartDataType, chartViewType)
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Date: ${context[0].label}`;
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Portfolio Date'
                            },
                            ticks: {
                                maxRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: getYAxisTitle(chartDataType, chartViewType)
                            },
                            beginAtZero: chartViewType === 'percentage' || chartDataType === 'pnl',
                            ticks: {
                                callback: function(value) {
                                    return value + (chartViewType === 'percentage' || chartViewType === 'pnlPercentage' ? '%' : '');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper functions for chart formatting
        function getChartTitle(chartViewType) {
            switch (chartViewType) {
                case 'value':
                    return 'Stock & Portfolio Price Trends (Avg + Current)';
                case 'percentage':
                    return 'Stock & Portfolio Price Deviation (%) from Initial Date';
                case 'pnl':
                    return 'Stock & Portfolio P&L Values (Rs.) Across Time';
                case 'pnlPercentage':
                    return 'Stock & Portfolio P&L Percentages (%) Across Time';
                default:
                    return 'Stock & Portfolio Data Across Time';
            }
        }

        function getYAxisTitle(chartViewType) {
            switch (chartViewType) {
                case 'value':
                    return 'Price (Rs.)';
                case 'percentage':
                    return 'Price Deviation (%)';
                case 'pnl':
                    return 'P&L Value (Rs.)';
                case 'pnlPercentage':
                    return 'P&L Percentage (%)';
                default:
                    return 'Value';
            }
        }

        function formatYAxisTick(value, chartDataType, chartViewType) {
            if (chartDataType === 'pnlPercentage' || (chartDataType === 'price' && chartViewType === 'percentage')) {
                const sign = value >= 0 ? '+' : '';
                return `${sign}${Number(value).toFixed(1)}%`;
            } else if (chartDataType === 'pnl') {
                return `Rs. ${Number(value).toFixed(0)}`;
            } else {
                return `Rs. ${Number(value).toFixed(1)}`;
            }
        }

        function formatTooltipLabel(context, chartDataType, chartViewType) {
            const value = context.parsed.y;
            const label = context.dataset.label;
            
            switch (chartDataType) {
                case 'price':
                    if (chartViewType === 'percentage') {
                        const sign = value >= 0 ? '+' : '';
                        return `${label}: ${sign}${Number(value).toFixed(2)}%`;
                    } else {
                        return `${label}: Rs. ${Number(value).toFixed(2)}`;
                    }
                case 'pnl':
                    return `${label}: Rs. ${Number(value).toFixed(2)}`;
                case 'pnlPercentage':
                    const sign = value >= 0 ? '+' : '';
                    return `${label}: ${sign}${Number(value).toFixed(2)}%`;
                default:
                    return `${label}: ${Number(value).toFixed(2)}`;
            }
        }

        // Extended color palette with 50+ distinct, visually different colors
        const stockColors = [
            // Primary Colors - High Contrast
            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
            '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1',
            
            // Secondary Colors - Medium Contrast
            '#DC2626', '#059669', '#D97706', '#7C3AED', '#BE185D',
            '#0891B2', '#65A30D', '#EA580C', '#4F46E5', '#C026D3',
            
            // Tertiary Colors - Distinct Hues
            '#16A34A', '#CA8A04', '#9333EA', '#E11D48', '#0D9488',
            '#F97316', '#7C2D12', '#1E40AF', '#7C3AED', '#059669',
            
            // High Saturation Colors - Very Distinct
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
            
            // Deep Colors - Rich and Different
            '#8E44AD', '#2E86AB', '#A23B72', '#F18F01', '#C73E1D',
            '#6A4C93', '#1982C4', '#8AC926', '#FF6B35', '#F7931E',
            
            // Muted but Distinct Colors
            '#6C5CE7', '#00B894', '#FDCB6E', '#E17055', '#74B9FF',
            '#A29BFE', '#FD79A8', '#FAB1A0', '#00CEC9', '#FF7675',
            
            // Additional Distinct Colors
            '#E84393', '#6C5CE7', '#00B894', '#FDCB6E', '#E17055',
            '#74B9FF', '#A29BFE', '#FD79A8', '#FAB1A0', '#00CEC9',
            '#FF7675', '#55A3FF', '#FF6B9D', '#4ECDC4', '#45B7D1'
        ];

        function getStockColor(stock, type) {
            // Special color for Portfolio
            if (stock === 'Portfolio') {
                return '#1E40AF'; // Consistent blue for Portfolio
            }
            
            // Assign unique color based on stock name hash
            let hash = 0;
            for (let i = 0; i < stock.length; i++) {
                const char = stock.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            const colorIndex = Math.abs(hash) % stockColors.length;
            return stockColors[colorIndex];
        }

        function selectAllStocks() {
            Object.keys(stockPriceData).forEach(stock => {
                selectedStocks.add(stock);
            });
            populateStockList();
            createStockPriceChart();
        }

        function clearAllStocks() {
            selectedStocks.clear();
            populateStockList();
            createStockPriceChart();
        }

        function resetChart() {
            selectedStocks.clear();
            populateStockList();
            createStockPriceChart();
        }

        function exportChart() {
            if (window.stockPriceChartInstance) {
                const canvas = window.stockPriceChartInstance.canvas;
                const link = document.createElement('a');
                link.download = 'stock-price-trends.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        function closeChartView() {
            document.getElementById('multiPortfolioChartView').classList.add('hidden');
            selectedPortfoliosForChart = [];
            selectedStocks.clear();
            if (window.stockPriceChartInstance) {
                window.stockPriceChartInstance.destroy();
                window.stockPriceChartInstance = null;
            }
        }

        // Portfolio Selection Management

        // Chart data type dropdown
        const chartDataTypeSelect = document.getElementById('chartDataType');
        if (chartDataTypeSelect) {
            chartDataTypeSelect.addEventListener('change', createStockPriceChart);
        }

        // Chart view type dropdown
        const chartViewTypeSelect = document.getElementById('chartViewType');
        if (chartViewTypeSelect) {
            chartViewTypeSelect.addEventListener('change', createStockPriceChart);
        }

        // Trade Analysis Functions
        function showTradeAnalysisSection() {
            const selectedPortfolios = getSelectedPortfolios();
            if (selectedPortfolios.length < 1) {
                showNotification('Please select at least 1 portfolio for trading journal analysis', 'warning');
                return;
            }

            // Hide other sections
            document.getElementById('portfolioManagementSection').classList.add('hidden');
            document.getElementById('portfolioComparisonSection').classList.add('hidden');
            document.getElementById('multiPortfolioChartView').classList.add('hidden');
            
            // Show trade analysis section
            document.getElementById('tradeAnalysisSection').classList.remove('hidden');
            
            // Update selected portfolios count
            updateSelectedPortfoliosCount();
            
            // Load trading journal data
            loadTradingJournalData();
        }

        function updateSelectedPortfoliosCount() {
            const selectedPortfolios = getSelectedPortfolios();
            const countElement = document.getElementById('selectedPortfoliosCount');
            if (countElement) {
                countElement.textContent = `${selectedPortfolios.length} portfolio${selectedPortfolios.length !== 1 ? 's' : ''}`;
            }
        }

        async function loadTradingJournalData() {
            const selectedPortfolios = getSelectedPortfolios();
            
            if (selectedPortfolios.length === 0) {
                document.getElementById('tradingJournalContainer').classList.add('hidden');
                document.getElementById('portfolioHoldingsSummary').classList.add('hidden');
                return;
            }

            try {
                // Load all selected portfolios
                const portfolios = [];
                for (const portfolio of selectedPortfolios) {
                    const portfolioData = await loadPortfolioFromDB(portfolio.id);
                    if (portfolioData) {
                        portfolios.push(portfolioData);
                    }
                }

                // Sort portfolios by date extracted from portfolio name
                portfolios.sort((a, b) => {
                    const dateA = getDateFromPortfolioName(a.name);
                    const dateB = getDateFromPortfolioName(b.name);
                    return new Date(dateA) - new Date(dateB);
                });
                

                // Generate trading journal
                generateTradingJournal(portfolios);
                
                
                // Generate holdings summary
                generateHoldingsSummary(portfolios);

                // Show tables
                document.getElementById('tradingJournalContainer').classList.remove('hidden');
                document.getElementById('portfolioHoldingsSummary').classList.remove('hidden');
                
                // Initialize DataTable after data is populated
                initializeTradingJournalDataTable();
                
            } catch (error) {
                showNotification('Error loading portfolio data', 'error');
            }
        }

        // Global variable to store all trades
        let allTrades = [];

        // Helper function to extract date from portfolio name (YYYYMMDD format)
        function getDateFromPortfolioName(portfolioName) {
            // Extract YYYYMMDD from portfolio name
            const match = portfolioName.match(/(\d{8})/);
            if (match) {
                const dateStr = match[1];
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                return `${year}-${month}-${day}`;
            }
            // Fallback to current date if no date found in name
            return new Date().toISOString().split('T')[0];
        }

        // Counter to track how many times generateTradingJournal is called
        let tradingJournalGenerationCount = 0;
        let isGenerating = false; // Flag to prevent multiple simultaneous calls
        let processedStocks = new Set(); // Track which stocks have been processed for initial BUY orders
        
        function generateTradingJournal(portfolios) {
            // Prevent multiple simultaneous calls
            if (isGenerating) {
                return;
            }
            
            isGenerating = true;
            tradingJournalGenerationCount++;
            const tbody = document.getElementById('tradingJournalTableBody');
            tbody.innerHTML = '';

            // Reset trades array and processed stocks
            allTrades = [];
            processedStocks.clear();

            // Process each portfolio chronologically to extract individual trades
            portfolios.forEach((portfolio, portfolioIndex) => {
                if (portfolio.holdings) {
                    portfolio.holdings.forEach(holding => {
                        const symbol = holding.symbol || holding.security;
                        const quantity = parseFloat(holding.quantity) || 0;
                        const avgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
                        const marketValue = parseFloat(holding.marketValue) || 0;
                        
                        // Calculate last price from marketValue / quantity if lastPrice is not available
                        let lastPrice = parseFloat(holding.lastPrice) || 0;
                        if (lastPrice === 0 && quantity > 0 && marketValue > 0) {
                            lastPrice = marketValue / quantity;
                        }
                        
                        const salePrice = lastPrice * (1 - 0.0112); // 1.12% deduction
                        
                        // Check if this is the first appearance of this stock
                        if (!processedStocks.has(symbol)) {
                            // First appearance of this stock - create initial BUY order
                            if (quantity > 0 && avgCost > 0) {
                                // Always create a new BUY trade for the first appearance
                                // Don't aggregate - each file should create its own BUY order
                                // Calculate the actual cost per share including brokerage fees
                                // If avgCost is the net price after brokerage, we need to calculate the gross price
                                const grossPrice = avgCost / (1 - 0.0112); // Reverse calculate to get gross price
                                const totalCostWithFees = quantity * grossPrice;
                                const netProceeds = totalCostWithFees * (1 - 0.0112);
                                const actualAvgCost = netProceeds / quantity; // This should equal avgCost
                                
                                const buyTrade = {
                                    id: generateTradeId(),
                                    date: getDateFromPortfolioName(portfolio.name), // Use portfolio name for date
                                    stock: symbol,
                                    amount: quantity,
                                    originalAmount: quantity, // Store original amount for display
                                    avePrice: grossPrice, // Use gross price (before brokerage fees)
                                    buyOrderSL: 0, // No SL set initially
                                    tp: 0, // No TP set initially
                                    type: 'BUY',
                                    isCompleted: false
                                };
                                allTrades.push(buyTrade);
                                
                                // Mark this stock as processed
                                processedStocks.add(symbol);
                            }
                        } else {
                            // Compare with previous portfolio to find changes
                            const prevPortfolio = portfolios[portfolioIndex - 1];
                            const prevHolding = prevPortfolio.holdings ? prevPortfolio.holdings.find(h => (h.symbol || h.security) === symbol) : null;
                            const prevQuantity = prevHolding ? parseFloat(prevHolding.quantity) || 0 : 0;
                            const prevAvgCost = prevHolding ? parseFloat(prevHolding.avgPrice || prevHolding.avgCost) || 0 : 0;

                            const quantityChange = quantity - prevQuantity;

                            if (quantityChange > 0) {
                                const buyTrade = {
                                    id: generateTradeId(),
                                    date: getDateFromPortfolioName(portfolio.name), // Use portfolio name for date
                                    stock: symbol,
                                    amount: quantityChange,
                                    originalAmount: quantityChange, // Store original amount for display
                                    avePrice: lastPrice, // Use last price as purchase price
                                    buyOrderSL: 0, tp: 0, type: 'BUY', soldDate: '', duration: 0, soldPrice: 0, sellOrderValue: 0, pnl: 0, pnlPercent: 0, isCompleted: false
                                };
                                allTrades.push(buyTrade);
                            } else if (quantityChange < 0) {
                                const soldQuantity = -quantityChange;
                                const sellDate = getDateFromPortfolioName(portfolio.name);
                                // Use the lastPrice as the selling price (this is the actual price at which the sale occurred)
                                let sellPrice = lastPrice;
                                
                                // If lastPrice is 0 or undefined, calculate it from marketValue and quantity
                                if (sellPrice === 0 && quantity > 0 && marketValue > 0) {
                                    sellPrice = marketValue / quantity;
                                }
                                
                                const currentAvgCost = avgCost;
                                
                                closeTrades(symbol, soldQuantity, getDateFromPortfolioName(portfolio.name), sellPrice, currentAvgCost);
                            }
                        }
                    });
                }
            });
            
            // Display all trades
            displayTrades();
            
            // Reset the generation flag
            isGenerating = false;
        }

        function closeTrades(symbol, soldQuantity, sellDate, sellPrice, avgCost) {
            // Skip if no quantity to sell
            if (soldQuantity <= 0) return;


            // Find open buy trades for this symbol (FIFO)
            const openTrades = allTrades.filter(trade => 
                trade.stock === symbol && 
                trade.type === 'BUY' && 
                !trade.isCompleted &&
                trade.amount > 0 // Only consider trades with positive quantity
            ).sort((a, b) => new Date(a.date) - new Date(b.date));


            if (openTrades.length === 0) {
                return;
            }

            let remainingToSell = soldQuantity;

            for (const trade of openTrades) {
                if (remainingToSell <= 0) break;

                const sellFromThisTrade = Math.min(remainingToSell, trade.amount);
                
                // Skip if no quantity to sell from this trade
                if (sellFromThisTrade <= 0) continue;
                
                // Create sell trade using the selling price (last price from selling date)
                // For P&L calculation, we need to use the average cost from the portfolio, not the trade's avePrice
                const sellTrade = {
                    id: generateTradeId(),
                    date: sellDate,
                    stock: symbol,
                    amount: sellFromThisTrade,
                    avePrice: trade.avePrice, // Original purchase price (last price when bought)
                    buyOrderSL: trade.buyOrderSL,
                    tp: trade.tp,
                    type: 'SELL',
                    soldDate: sellDate,
                    duration: calculateDuration(trade.date, sellDate),
                    soldPrice: sellPrice, // Last price from selling date (this is the actual selling price)
                    sellOrderValue: sellFromThisTrade * sellPrice,
                    pnl: sellFromThisTrade * (sellPrice - avgCost), // P&L = (Selling Price - Average Cost) * Quantity
                    pnlPercent: avgCost > 0 ? ((sellPrice - avgCost) / avgCost) * 100 : 0,
                    isCompleted: true,
                    relatedBuyTradeId: trade.id
                };
                
                


                allTrades.push(sellTrade);

                // Update the buy trade
                trade.amount -= sellFromThisTrade;
                if (trade.amount <= 0) {
                    trade.isCompleted = true;
                }

                remainingToSell -= sellFromThisTrade;
            }
        }

        function calculateDuration(buyDate, sellDate) {
            const buy = new Date(buyDate);
            const sell = new Date(sellDate);
            const diffTime = Math.abs(sell - buy);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function generateTradeId() {
            return 'trade_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function displayTrades() {
            const tbody = document.getElementById('tradingJournalTableBody');
            tbody.innerHTML = '';


            // Display all trades - DataTable will handle sorting
            allTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.dataset.tradeId = trade.id;
                
                
                const typeClass = trade.type === 'BUY' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const pnlClass = trade.pnl !== undefined ? (trade.pnl >= 0 ? 'text-green-600' : 'text-red-600') : 'text-gray-600';
                const pnlPercentClass = trade.pnlPercent !== undefined ? (trade.pnlPercent >= 0 ? 'text-green-600' : 'text-red-600') : 'text-gray-600';
                
                // For BUY trades, show original amount if it exists (for partially or fully sold trades)
                const displayAmount = (trade.type === 'BUY' && trade.originalAmount) 
                    ? trade.originalAmount 
                    : trade.amount;
                
                // Calculate market value for display
                const marketValue = displayAmount * trade.avePrice;
                
                
                row.innerHTML = `
                    <td class="px-3 py-2 text-xs text-gray-900 whitespace-nowrap">${trade.date}</td>
                    <td class="px-3 py-2 text-xs font-medium text-gray-900">${trade.stock}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">${formatInteger(displayAmount)}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">Rs. ${formatNumber(trade.avePrice, 2)}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">Rs. ${formatNumber(marketValue, 2)}</td>
                    <td class="px-3 py-2 text-center">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${typeClass}">${trade.type}</span>
                    </td>
                    <td class="px-3 py-2 text-xs text-gray-900 whitespace-nowrap">${trade.soldDate || '-'}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">${trade.duration > 0 ? trade.duration + 'd' : '-'}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">${trade.soldPrice > 0 ? 'Rs. ' + formatNumber(trade.soldPrice, 2) : '-'}</td>
                    <td class="px-3 py-2 text-xs text-gray-600 text-right">${trade.sellOrderValue > 0 ? 'Rs. ' + formatNumber(trade.sellOrderValue, 2) : '-'}</td>
                    <td class="px-3 py-2 text-xs font-medium text-right ${pnlClass}">${trade.pnl !== undefined && trade.pnl !== 0 ? 'Rs. ' + formatNumber(trade.pnl, 2) : '-'}</td>
                    <td class="px-3 py-2 text-xs font-medium text-right ${pnlPercentClass}">${trade.pnlPercent !== undefined && trade.pnlPercent !== 0 ? formatNumber(trade.pnlPercent, 2) + '%' : '-'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editTrade('${trade.id}')" class="text-blue-600 hover:text-blue-800 text-xs mr-2">Edit</button>
                        <button onclick="deleteTrade('${trade.id}')" class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            
            // Reinitialize DataTable after updating the table with a small delay
            setTimeout(() => {
                initializeTradingJournalDataTable();
            }, 100);
            
            // Reset the generation flag
            isGenerating = false;
        }

        

        function initializeTradingJournalDataTable() {
            // Check if jQuery and DataTables are available
            if (typeof $ === 'undefined' || typeof $.fn.DataTable === 'undefined') {
                return;
            }
            
            const tradingJournalTable = document.getElementById('tradingJournalTable');
            if (tradingJournalTable) {
                // Check if table has data rows before initializing DataTable
                const tbody = tradingJournalTable.querySelector('tbody');
                const hasData = tbody && tbody.children.length > 0;
                
                if ($.fn.DataTable.isDataTable(tradingJournalTable)) {
                    $(tradingJournalTable).DataTable().destroy();
                }
                
                // Only initialize DataTable if there's data
                if (hasData) {
                    try {
                        $(tradingJournalTable).DataTable({
                            pageLength: 50,
                            lengthMenu: [[25, 50, 100, 200, -1], [25, 50, 100, 200, "All"]],
                            order: [[0, 'desc']], // Sort by date descending
                            responsive: true,
                            processing: false,
                            searching: true,
                            ordering: true,
                            info: true,
                            paging: true,
                            scrollX: true,
                            scrollCollapse: true,
                            columnDefs: [
                                { type: 'date', targets: [0, 6] }, // Date columns (Date, Sold Date)
                                { type: 'num', targets: [2, 3, 4, 7, 8, 9, 10, 11] }, // Numeric columns (Amount, Ave Price, Market Value, Duration, Sold Price, Sell Value, P&L, P&L%)
                                { type: 'string', targets: [1, 5, 12] }, // String columns (Stock, Type, Actions)
                                { className: 'text-center', targets: [5, 12] }, // Center align (Type, Actions)
                                { className: 'text-right', targets: [2, 3, 4, 7, 8, 9, 10, 11] }, // Right align numeric columns
                                { className: 'text-left', targets: [0, 1, 6] }, // Left align (Date, Stock, Sold Date)
                                { orderable: true, targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] }, // All columns sortable except Actions
                                { orderable: false, targets: [12] } // Actions column not sortable
                            ],
                            language: {
                                search: "Search:",
                                lengthMenu: "Show _MENU_ entries",
                                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                                paginate: {
                                    first: "First",
                                    last: "Last",
                                    next: "Next",
                                    previous: "Previous"
                                }
                            }
                        });
                    } catch (error) {
                    }
                } else {
                }
            }
        }

        // Export and Print Functions
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const cols = row.querySelectorAll('td, th');
                let rowData = [];
                
                for (let j = 0; j < cols.length; j++) {
                    let cellText = cols[j].innerText || cols[j].textContent || '';
                    // Clean up the text and remove extra whitespace
                    cellText = cellText.replace(/\s+/g, ' ').trim();
                    // Escape quotes and wrap in quotes if contains comma
                    if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                        cellText = '"' + cellText.replace(/"/g, '""') + '"';
                    }
                    rowData.push(cellText);
                }
                csv.push(rowData.join(','));
            }
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printTable(tableId, title) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const printWindow = window.open('', '_blank');
            const tableClone = table.cloneNode(true);
            
            // Remove action buttons from print version
            const actionCols = tableClone.querySelectorAll('td:last-child, th:last-child');
            actionCols.forEach(col => {
                if (col.textContent.includes('Edit') || col.textContent.includes('Delete')) {
                    col.remove();
                }
            });
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: bold; }
                            .text-right { text-align: right; }
                            .text-center { text-align: center; }
                            .text-left { text-align: left; }
                            h1 { color: #333; margin-bottom: 20px; }
                        </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        ${tableClone.outerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function generateHoldingsSummary(portfolios) {
            const tbody = document.getElementById('holdingsSummaryTableBody');
            tbody.innerHTML = '';

            // Get the latest portfolio for current holdings only
            const latestPortfolio = portfolios[portfolios.length - 1];
            
            if (!latestPortfolio || !latestPortfolio.holdings) {
                return;
            }

            // Display current holdings from latest portfolio only
            latestPortfolio.holdings.forEach(holding => {
                const symbol = holding.symbol || holding.security;
                const quantity = parseFloat(holding.quantity) || 0;
                const avgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
                const lastPrice = parseFloat(holding.lastPrice) || 0;
                const marketValue = parseFloat(holding.marketValue) || 0;
                
                // Calculate current price if not available
                const currentPrice = lastPrice > 0 ? lastPrice : (quantity > 0 ? marketValue / quantity : 0);
                
                // Calculate unrealized P&L with 1.12% brokerage fee
                const grossProceeds = marketValue;
                const brokerFees = grossProceeds * 0.0112; // 1.12% broker fees
                const netProceeds = grossProceeds - brokerFees;
                const totalCost = quantity * avgCost;
                const unrealizedPnL = netProceeds - totalCost;
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const pnlClass = unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${symbol}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">${formatInteger(quantity)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">Rs. ${formatNumber(avgCost, 2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">Rs. ${formatNumber(currentPrice, 2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">Rs. ${formatNumber(marketValue, 2)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-right ${pnlClass}">Rs. ${formatNumber(unrealizedPnL, 2)}</td>
                `;
                
                tbody.appendChild(row);
            });

            // Initialize DataTable for holdings summary
            const holdingsTable = document.querySelector('#portfolioHoldingsSummary table');
            if (holdingsTable && $.fn.DataTable) {
                if ($.fn.DataTable.isDataTable(holdingsTable)) {
                    $(holdingsTable).DataTable().destroy();
                }
                
                $(holdingsTable).DataTable({
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                    order: [[4, 'desc']], // Sort by Market Value descending
                    responsive: true,
                    processing: false,
                    searching: true,
                    ordering: true,
                    info: true,
                    paging: true,
                    scrollX: true,
                    scrollCollapse: true,
                    columnDefs: [
                        { type: 'string', targets: [0] }, // Symbol
                        { type: 'num', targets: [1, 2, 3, 4, 5] }, // Numeric columns (Qty, Avg Cost, Current Price, Market Value, P&L)
                        { className: 'text-right', targets: [1, 2, 3, 4, 5] }, // Right align numeric columns
                        { className: 'text-left', targets: [0] } // Left align Symbol
                    ]
                });
            }
        }

        function analyzeTrades() {
            const tbody = document.getElementById('tradingJournalTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            let totalProfit = 0;
            let totalLoss = 0;
            let totalTrades = 0;
            let winningTrades = 0;
            let bestTrade = 0;
            let worstTrade = 0;
            
            rows.forEach(row => {
                const pnlText = row.querySelector('td:nth-child(8)').textContent;
                const pnl = parseFloat(pnlText.replace('$', '').replace(',', ''));
                
                if (pnl !== 0) { // Only count actual trades (not purchases)
                    totalTrades++;
                    
                    if (pnl > 0) {
                        totalProfit += pnl;
                        winningTrades++;
                        bestTrade = Math.max(bestTrade, pnl);
                    } else if (pnl < 0) {
                        totalLoss += Math.abs(pnl);
                        worstTrade = Math.min(worstTrade, pnl);
                    }
                }
            });
            
            const netPnL = totalProfit - totalLoss;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
            const avgProfitPerTrade = totalTrades > 0 ? netPnL / totalTrades : 0;
            
            // Update results display
            document.getElementById('totalProfit').textContent = `Rs. ${formatNumber(totalProfit)}`;
            document.getElementById('totalLoss').textContent = `Rs. ${formatNumber(totalLoss)}`;
            document.getElementById('netPnL').textContent = `Rs. ${formatNumber(netPnL)}`;
            document.getElementById('winRate').textContent = `${formatNumber(winRate, 1)}%`;
            document.getElementById('totalTrades').textContent = totalTrades.toString();
            document.getElementById('avgProfitPerTrade').textContent = `Rs. ${formatNumber(avgProfitPerTrade)}`;
            document.getElementById('bestTrade').textContent = `Rs. ${formatNumber(bestTrade)}`;
            document.getElementById('worstTrade').textContent = `Rs. ${formatNumber(worstTrade)}`;
            
            // Show results
            document.getElementById('tradingPerformanceSummary').classList.remove('hidden');
        }

        // Manual Trade Entry Functions
        function openManualTradeModal() {
            const modal = document.getElementById('manualTradeModal');
            modal.classList.remove('hidden');
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tradeDate').value = today;
            
            // Clear form
            document.getElementById('stockSymbol').value = '';
            document.getElementById('tradeQuantity').value = '';
            document.getElementById('tradePrice').value = '';
            document.getElementById('stopLoss').value = '';
            document.getElementById('takeProfit').value = '';
            document.getElementById('tradeType').value = 'BUY';
            document.getElementById('sellDate').value = '';
            document.getElementById('sellPrice').value = '';
            
            toggleSellFields();
        }

        function closeManualTradeModal() {
            const modal = document.getElementById('manualTradeModal');
            modal.classList.add('hidden');
        }

        function toggleSellFields() {
            const tradeType = document.getElementById('tradeType').value;
            const sellDateContainer = document.getElementById('sellDateContainer');
            const sellPriceContainer = document.getElementById('sellPriceContainer');
            
            if (tradeType === 'SELL') {
                sellDateContainer.classList.remove('hidden');
                sellPriceContainer.classList.remove('hidden');
            } else {
                sellDateContainer.classList.add('hidden');
                sellPriceContainer.classList.add('hidden');
            }
        }

        function saveManualTrade() {
            const tradeDate = document.getElementById('tradeDate').value;
            const stockSymbol = document.getElementById('stockSymbol').value;
            const quantity = parseFloat(document.getElementById('tradeQuantity').value);
            const price = parseFloat(document.getElementById('tradePrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
            const takeProfit = parseFloat(document.getElementById('takeProfit').value) || 0;
            const tradeType = document.getElementById('tradeType').value;
            const sellDate = document.getElementById('sellDate').value;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;

            // Validation
            if (!tradeDate || !stockSymbol || !quantity || !price) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (quantity <= 0) {
                showNotification('Quantity must be greater than 0', 'error');
                return;
            }

            if (tradeType === 'SELL' && (!sellDate || !sellPrice)) {
                showNotification('Please fill in sell date and sell price for SELL trades', 'error');
                return;
            }

            // Create trade object
            const trade = {
                id: generateTradeId(),
                date: tradeDate,
                stock: stockSymbol.toUpperCase(),
                amount: quantity,
                avePrice: price,
                buyOrderSL: stopLoss,
                tp: takeProfit,
                type: tradeType,
                soldDate: sellDate || '',
                duration: sellDate ? calculateDuration(tradeDate, sellDate) : 0,
                soldPrice: sellPrice,
                sellOrderValue: sellPrice * quantity,
                pnl: tradeType === 'SELL' ? quantity * (sellPrice - price) : 0,
                pnlPercent: tradeType === 'SELL' ? ((sellPrice - price) / price) * 100 : 0,
                isCompleted: tradeType === 'SELL'
            };

            // Add to trades array
            allTrades.push(trade);

            // Refresh display
            displayTrades();

            // Close modal
            closeManualTradeModal();

            showNotification('Trade added successfully', 'success');
        }

        function editTrade(tradeId) {
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;

            // Open modal with trade data
            const modal = document.getElementById('manualTradeModal');
            modal.classList.remove('hidden');

            document.getElementById('tradeDate').value = trade.date;
            document.getElementById('stockSymbol').value = trade.stock;
            document.getElementById('tradeQuantity').value = trade.amount;
            document.getElementById('tradePrice').value = trade.avePrice;
            document.getElementById('stopLoss').value = trade.buyOrderSL;
            document.getElementById('takeProfit').value = trade.tp;
            document.getElementById('tradeType').value = trade.type;
            document.getElementById('sellDate').value = trade.soldDate;
            document.getElementById('sellPrice').value = trade.soldPrice;

            toggleSellFields();

            // Store the trade ID for updating
            modal.dataset.editingTradeId = tradeId;
        }

        function deleteTrade(tradeId) {
            if (confirm('Are you sure you want to delete this trade?')) {
                allTrades = allTrades.filter(t => t.id !== tradeId);
                displayTrades();
                showNotification('Trade deleted successfully', 'success');
            }
        }

        // Target Price Management Functions
        let currentPortfolioForTargets = null;
        let targetPrices = {}; // Store target prices for each stock

        // Wrapper function to load portfolio and show target price management
        async function showTargetPriceForPortfolio(portfolioId) {
            try {
                const portfolio = await loadPortfolioFromDB(portfolioId);
                showTargetPriceManagement(portfolio);
            } catch (error) {
                alert('Error loading portfolio: ' + error.message);
            }
        }



        function showTargetPriceManagement(portfolio) {
            currentPortfolioForTargets = portfolio;
            
            // Hide all other sections and show only target price section
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('portfolioManagementSection').classList.add('hidden');
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('portfolioComparisonSection').classList.add('hidden');
            document.getElementById('tradeAnalysisSection').classList.add('hidden');
            
            // Diversification chart now handled in separate pages
            
            // Show target price section as main content
            const targetPriceSection = document.getElementById('targetPriceSection');
            if (targetPriceSection) {
                targetPriceSection.classList.remove('hidden');
                // Force visibility with inline styles
                targetPriceSection.style.display = 'block';
                targetPriceSection.style.visibility = 'visible';
                targetPriceSection.style.opacity = '1';
            } else {
                return;
            }
            
            
            
            // Update the title to show portfolio name
            const titleElement = targetPriceSection.querySelector('h2');
            if (titleElement) {
                titleElement.textContent = `üéØ Target Price Management - ${portfolio.name}`;
            }
            
            loadTargetPriceData(portfolio);
        }

        function loadTargetPriceData(portfolio) {
            const tbody = document.getElementById('targetPriceTableBody');
            
            if (!tbody) {
                return;
            }
            
            tbody.innerHTML = '';

            if (!portfolio.holdings || portfolio.holdings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">No holdings found</td></tr>';
                return;
            }

            // Filter out holdings with 0 quantity
            const validHoldings = portfolio.holdings.filter(holding => {
                const quantity = parseFloat(holding.quantity) || 0;
                return quantity > 0;
            });


            if (validHoldings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">No holdings with quantity > 0 found</td></tr>';
                return;
            }

            validHoldings.forEach((holding, index) => {
                const symbol = holding.symbol || holding.security;
                const quantity = parseFloat(holding.quantity) || 0;
                const avgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
                
                // Calculate current price from lastPrice or marketValue/quantity
                let currentPrice = parseFloat(holding.lastPrice) || 0;
                if (currentPrice === 0 && quantity > 0) {
                    const marketValue = parseFloat(holding.marketValue) || 0;
                    if (marketValue > 0) {
                        currentPrice = marketValue / quantity;
                    }
                }
                
                // Calculate current P&L and P&L% (including 1.12% brokerage fee)
                const currentMarketValue = quantity * currentPrice;
                const grossProceeds = currentMarketValue;
                const brokerFees = grossProceeds * 0.0112; // 1.12% broker fees
                const netProceeds = grossProceeds - brokerFees;
                const currentTotalCost = quantity * avgCost;
                const currentPnL = netProceeds - currentTotalCost;
                const currentPnLPercent = avgCost > 0 ? (currentPnL / currentTotalCost) * 100 : 0;
                
                // Get saved target price data
                const targetData = targetPrices[symbol] || { targetPrice: 0, tpSetDate: '' };
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.dataset.symbol = symbol;
                
                const currentPnLClass = currentPnL >= 0 ? 'text-green-600' : 'text-red-600';
                const currentPnLPercentClass = currentPnLPercent >= 0 ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${symbol}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">${formatInteger(quantity)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">Rs. ${formatNumber(avgCost)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">Rs. ${formatNumber(currentPrice)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-right ${currentPnLClass}">Rs. ${formatNumber(currentPnL)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-right ${currentPnLPercentClass}">${formatNumber(currentPnLPercent)}%</td>
                    <td class="px-4 py-3 text-right">
                        <input type="number" 
                               class="target-price-input w-20 text-right border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                               value="${targetData.targetPrice}" 
                               step="0.01" 
                               min="0"
                               data-symbol="${symbol}"
                               data-field="targetPrice">
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-right" id="target-pnl-${symbol}">Rs. 0.00</td>
                    <td class="px-4 py-3 text-sm font-medium text-right" id="target-pnl-percent-${symbol}">0.00%</td>
                    <td class="px-4 py-3 text-center">
                        <input type="date" 
                               class="tp-date-input w-32 border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                               value="${targetData.tpSetDate}" 
                               data-symbol="${symbol}"
                               data-field="tpSetDate">
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            // Add event listeners for input changes
            addTargetPriceEventListeners();
            
            // Calculate target P&L for all stocks with target prices
            portfolio.holdings.forEach((holding, index) => {
                const symbol = holding.symbol || holding.security;
                const targetData = targetPrices[symbol];
                if (targetData && targetData.targetPrice > 0) {
                    calculateTargetPnL(symbol);
                }
            });
            
            updateTargetPriceSummary();
        }

        function addTargetPriceEventListeners() {
            // Target price inputs
            document.querySelectorAll('.target-price-input').forEach(input => {
                input.addEventListener('input', function() {
                    const symbol = this.dataset.symbol;
                    const targetPrice = parseFloat(this.value) || 0;
                    updateTargetPriceData(symbol, 'targetPrice', targetPrice);
                    
                    // Auto-set current date if target price is set and no date exists
                    if (targetPrice > 0) {
                        const targetData = targetPrices[symbol];
                        if (!targetData.tpSetDate) {
                            const today = new Date().toISOString().split('T')[0];
                            updateTargetPriceData(symbol, 'tpSetDate', today);
                            
                            // Update the date input field
                            const dateInput = document.querySelector(`input[data-symbol="${symbol}"][data-field="tpSetDate"]`);
                            if (dateInput) {
                                dateInput.value = today;
                            }
                        }
                    }
                    
                    calculateTargetPnL(symbol);
                    updateTargetPriceSummary();
                });
                
                // Auto-set date when user focuses on target price input (if no date exists)
                input.addEventListener('focus', function() {
                    const symbol = this.dataset.symbol;
                    const targetData = targetPrices[symbol];
                    if (targetData && targetData.targetPrice > 0 && !targetData.tpSetDate) {
                        const today = new Date().toISOString().split('T')[0];
                        updateTargetPriceData(symbol, 'tpSetDate', today);
                        
                        // Update the date input field
                        const dateInput = document.querySelector(`input[data-symbol="${symbol}"][data-field="tpSetDate"]`);
                        if (dateInput) {
                            dateInput.value = today;
                        }
                    }
                });
            });

            // TP set date inputs
            document.querySelectorAll('.tp-date-input').forEach(input => {
                input.addEventListener('change', function() {
                    const symbol = this.dataset.symbol;
                    const tpSetDate = this.value;
                    updateTargetPriceData(symbol, 'tpSetDate', tpSetDate);
                });
            });
        }

        function updateTargetPriceData(symbol, field, value) {
            if (!targetPrices[symbol]) {
                targetPrices[symbol] = {};
            }
            targetPrices[symbol][field] = value;
            
            // Save to localStorage
            localStorage.setItem('targetPrices', JSON.stringify(targetPrices));
        }

        function calculateTargetPnL(symbol) {
            if (!currentPortfolioForTargets) return;

            const holding = currentPortfolioForTargets.holdings.find(h => (h.symbol || h.security) === symbol);
            if (!holding) return;

            const quantity = parseFloat(holding.quantity) || 0;
            const avgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
            const targetPrice = parseFloat(targetPrices[symbol]?.targetPrice) || 0;

            if (targetPrice > 0 && quantity > 0 && avgCost > 0) {
                // Calculate target P&L with 1.12% broker fees
                const grossProceeds = quantity * targetPrice;
                const brokerFees = grossProceeds * 0.0112; // 1.12% broker fees
                const netProceeds = grossProceeds - brokerFees;
                const totalCost = quantity * avgCost;
                const targetPnL = netProceeds - totalCost;
                const targetPnLPercent = (targetPnL / totalCost) * 100;

                // Update display
                const pnlElement = document.getElementById(`target-pnl-${symbol}`);
                const pnlPercentElement = document.getElementById(`target-pnl-percent-${symbol}`);
                
                if (pnlElement) {
                    pnlElement.textContent = `Rs. ${formatNumber(targetPnL)}`;
                    pnlElement.className = `px-4 py-3 text-sm font-medium text-right ${targetPnL >= 0 ? 'text-green-600' : 'text-red-600'}`;
                }
                
                if (pnlPercentElement) {
                    pnlPercentElement.textContent = `${formatNumber(targetPnLPercent)}%`;
                    pnlPercentElement.className = `px-4 py-3 text-sm font-medium text-right ${targetPnLPercent >= 0 ? 'text-green-600' : 'text-red-600'}`;
                }
            } else {
                // Reset display
                const pnlElement = document.getElementById(`target-pnl-${symbol}`);
                const pnlPercentElement = document.getElementById(`target-pnl-percent-${symbol}`);
                
                if (pnlElement) {
                    pnlElement.textContent = 'Rs. 0.00';
                    pnlElement.className = 'px-4 py-3 text-sm font-medium text-right text-gray-600';
                }
                
                if (pnlPercentElement) {
                    pnlPercentElement.textContent = '0.00%';
                    pnlPercentElement.className = 'px-4 py-3 text-sm font-medium text-right text-gray-600';
                }
            }
        }

        function updateTargetPriceSummary() {
            if (!currentPortfolioForTargets) return;

            let totalTargetPnL = 0;
            let totalWeightedPnLPercent = 0;
            let totalWeight = 0;
            let stocksWithTargets = 0;

            currentPortfolioForTargets.holdings.forEach(holding => {
                const symbol = holding.symbol || holding.security;
                const quantity = parseFloat(holding.quantity) || 0;
                const avgCost = parseFloat(holding.avgPrice || holding.avgCost) || 0;
                const targetPrice = parseFloat(targetPrices[symbol]?.targetPrice) || 0;

                if (targetPrice > 0 && quantity > 0 && avgCost > 0) {
                    stocksWithTargets++;
                    
                    // Calculate P&L for this stock
                    const grossProceeds = quantity * targetPrice;
                    const brokerFees = grossProceeds * 0.0112;
                    const netProceeds = grossProceeds - brokerFees;
                    const totalCost = quantity * avgCost;
                    const targetPnL = netProceeds - totalCost;
                    const targetPnLPercent = (targetPnL / totalCost) * 100;

                    totalTargetPnL += targetPnL;
                    totalWeightedPnLPercent += targetPnLPercent * (totalCost / 1000); // Weight by investment size
                    totalWeight += totalCost / 1000;
                }
            });

            // Update summary display
            document.getElementById('totalTargetPnL').textContent = `Rs. ${formatNumber(totalTargetPnL)}`;
            document.getElementById('totalTargetPnL').className = `text-xl font-bold ${totalTargetPnL >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            const avgTargetPnLPercent = totalWeight > 0 ? totalWeightedPnLPercent / totalWeight : 0;
            document.getElementById('avgTargetPnLPercent').textContent = `${formatNumber(avgTargetPnLPercent)}%`;
            document.getElementById('avgTargetPnLPercent').className = `text-xl font-bold ${avgTargetPnLPercent >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('stocksWithTargets').textContent = stocksWithTargets;
        }

        // Load saved target prices on page load
        function loadSavedTargetPrices() {
            const saved = localStorage.getItem('targetPrices');
            if (saved) {
                targetPrices = JSON.parse(saved);
            }
        }

        // Initialize target prices on page load
        loadSavedTargetPrices();

        // Listen for storage changes from other windows/tabs (Target Price Manager)
        window.addEventListener('storage', function(e) {
            if (e.key === 'targetPrices' && e.newValue !== null) {
                // Reload target prices data
                loadSavedTargetPrices();
                
                // If target price management is currently visible, refresh it
                const targetPriceSection = document.getElementById('targetPriceSection');
                if (targetPriceSection && !targetPriceSection.classList.contains('hidden')) {
                    if (currentPortfolioForTargets) {
                        loadTargetPriceData(currentPortfolioForTargets);
                    }
                }
            }
        });

        // Listen for custom events from Target Price Manager (same window)
        window.addEventListener('targetPriceUpdated', function() {
            // Reload target prices data
            loadSavedTargetPrices();
            
            // If target price management is currently visible, refresh it
            const targetPriceSection = document.getElementById('targetPriceSection');
            if (targetPriceSection && !targetPriceSection.classList.contains('hidden')) {
                if (currentPortfolioForTargets) {
                    loadTargetPriceData(currentPortfolioForTargets);
                }
            }
        });
    </script>
</body>
</html>

