<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Management - Portfolio Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .transaction-type-buy { background-color: #dcfce7; color: #166534; }
        .transaction-type-sell { background-color: #fef2f2; color: #dc2626; }
        .transaction-type-withdraw { background-color: #fef3c7; color: #d97706; }
        .transaction-type-deposit { background-color: #dbeafe; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="text-gray-600 hover:text-gray-900 transition-colors">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900">Transaction Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='pm.html'" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio
                    </button>
                    <button onclick="window.location.href='target-price-manager.html'" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-bullseye mr-2"></i>Target Prices
                    </button>
                    <button onclick="window.location.href='settings.html'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-plus text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Deposits</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalDeposits">Rs. 0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-minus text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Withdrawals</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalWithdrawals">Rs. 0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-chart-line text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Net Cash Flow</p>
                        <p class="text-2xl font-bold text-gray-900" id="netCashFlow">Rs. 0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-list text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalTransactions">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Add Transaction</h2>
            </div>
            <div class="p-6">
                <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="transactionDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-2">Amount (Rs.)</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                        <select id="transactionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="deposit">Deposit</option>
                            <option value="withdraw">Withdraw</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" id="transactionDescription" placeholder="e.g., Initial investment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    
                    <div class="md:col-span-2 lg:col-span-4 flex justify-end space-x-4">
                        <button type="button" onclick="clearForm()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            <i class="fas fa-times mr-2"></i>Clear
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Transaction History</h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="searchInput" placeholder="Search transactions..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="clearAllTransactions()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-trash mr-2"></i>Clear All
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                Date <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                Type <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                Amount <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                Description <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport()">

    <script>
        let transactions = [];
        let sortDirection = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            setTodayAsDefault();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Form submission
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addTransaction();
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterTransactions(e.target.value);
            });
        }

        function setTodayAsDefault() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        function addTransaction() {
            const date = document.getElementById('transactionDate').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const type = document.getElementById('transactionType').value;
            const description = document.getElementById('transactionDescription').value;

            if (!date || !amount || !description) {
                alert('Please fill in all fields');
                return;
            }

            const transaction = {
                id: Date.now().toString(),
                date: date,
                amount: amount,
                type: type,
                description: description,
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            saveTransactions();
            loadTransactions();
            clearForm();
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionDescription').value = transaction.description;

            // Remove the transaction from the list
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions();
            loadTransactions();
        }

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                loadTransactions();
            }
        }

        function clearForm() {
            document.getElementById('transactionForm').reset();
            setTodayAsDefault();
        }

        function clearAllTransactions() {
            if (confirm('Are you sure you want to delete all transactions? This action cannot be undone.')) {
                transactions = [];
                saveTransactions();
                loadTransactions();
            }
        }

        function loadTransactions() {
            const stored = localStorage.getItem('transactions');
            if (stored) {
                transactions = JSON.parse(stored);
            }
            displayTransactions();
            updateSummary();
        }

        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            No transactions found. Add your first transaction above.
                        </td>
                    </tr>
                `;
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const typeClass = `transaction-type-${transaction.type}`;
                const typeIcon = transaction.type === 'deposit' ? 'fas fa-plus' : 'fas fa-minus';
                const amountSign = transaction.type === 'deposit' ? '+' : '-';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${typeClass}">
                            <i class="${typeIcon} mr-1"></i>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'deposit' ? 'text-green-600' : 'text-red-600'}">
                        ${amountSign}Rs. ${formatNumber(transaction.amount)}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTransaction('${transaction.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction('${transaction.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummary() {
            const deposits = transactions.filter(t => t.type === 'deposit').reduce((sum, t) => sum + t.amount, 0);
            const withdrawals = transactions.filter(t => t.type === 'withdraw').reduce((sum, t) => sum + t.amount, 0);
            const netFlow = deposits - withdrawals;

            document.getElementById('totalDeposits').textContent = `Rs. ${formatNumber(deposits)}`;
            document.getElementById('totalWithdrawals').textContent = `Rs. ${formatNumber(withdrawals)}`;
            document.getElementById('netCashFlow').textContent = `Rs. ${formatNumber(netFlow)}`;
            document.getElementById('totalTransactions').textContent = transactions.length;
        }

        function filterTransactions(searchTerm) {
            const rows = document.querySelectorAll('#transactionsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function sortTable(columnIndex) {
            const tbody = document.getElementById('transactionsTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            const isAscending = !sortDirection[columnIndex];
            sortDirection[columnIndex] = isAscending;

            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                let comparison = 0;
                if (columnIndex === 2) { // Amount column
                    const aAmount = parseFloat(aText.replace(/[^\d.-]/g, ''));
                    const bAmount = parseFloat(bText.replace(/[^\d.-]/g, ''));
                    comparison = aAmount - bAmount;
                } else if (columnIndex === 0) { // Date column
                    comparison = new Date(aText) - new Date(bText);
                } else {
                    comparison = aText.localeCompare(bText);
                }
                
                return isAscending ? comparison : -comparison;
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        function exportData() {
            const data = {
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.transactions && Array.isArray(data.transactions)) {
                        if (confirm('This will replace all current transactions. Continue?')) {
                            transactions = data.transactions;
                            saveTransactions();
                            loadTransactions();
                            alert('Transactions imported successfully!');
                        }
                    } else {
                        alert('Invalid file format');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function goBack() {
            window.location.href = 'pm.html';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    </script>
</body>
</html>
